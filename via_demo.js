
function _via_load_submodules() {
  _via_basic_demo_load_img();
  //_via_basic_demo_draw_default_regions();
  _via_basic_demo_define_attributes();
  _via_basic_demo_define_annotations();

  toggle_attributes_editor();
  update_attributes_update_panel();

  annotation_editor_show();
}

function _via_basic_demo_load_img() {
  // add files
  var i, n;
  var file_count = 0;
  n = _via_basic_demo_img.length;
  for ( i = 0; i < n; ++i ) {
    project_file_add_base64( _via_basic_demo_img_filename[i], _via_basic_demo_img[i] );
    file_count += 1;
  }

  _via_show_img(0);
  update_img_fn_list();
}

function _via_basic_demo_draw_default_regions() {
  var csv_annotations = 'filename,file_size,file_attributes,region_count,region_id,region_shape_attributes,region_attributes\nadutta_swan.jpg,-1,"{}",1,0,"{""name"":""polygon"",""all_points_x"":[116,94,176,343,383,385,369,406,398,364,310,297,304,244,158],""all_points_y"":[157,195,264,273,261,234,222,216,155,124,135,170,188,170,175]}","{}"\nwikimedia_death_of_socrates.jpg,-1,"{}",3,0,"{""name"":""rect"",""x"":174,""y"":139,""width"":108,""height"":227}","{}"\nwikimedia_death_of_socrates.jpg,-1,"{}",3,1,"{""name"":""rect"",""x"":347,""y"":114,""width"":91,""height"":209}","{}"\nwikimedia_death_of_socrates.jpg,-1,"{}",3,2,"{""name"":""ellipse"",""cx"":316,""cy"":180,""rx"":17,""ry"":12}","{}"';

  import_annotations_from_csv(csv_annotations);
}

function _via_basic_demo_define_attributes() {
  var attributes_json = '{"region":{"name":{"type":"text","description":"Name of the object","default_value":"not_defined"},"type":{"type":"dropdown","description":"Category of object","options":{"bird":"Bird","human":"Human","cup":"Cup (object)","unknown":"Unknown (object)"},"default_options":{"unknown":true}},"image_quality":{"type":"checkbox","description":"Quality of image region","options":{"blur":"Blurred region","good_illumination":"Good Illumination","frontal":"Object in Frontal View"},"default_options":{"good":true,"frontal":true,"good_illumination":true}}},"file":{"caption":{"type":"text","description":"","default_value":""},"public_domain":{"type":"radio","description":"","options":{"yes":"Yes","no":"No"},"default_options":{"no":true}},"image_url":{"type":"text","description":"","default_value":""}}}';

  project_import_attributes_from_json(attributes_json);
}

function _via_basic_demo_define_annotations() {
  var annotations_json = '{}'

  import_annotations_from_json(annotations_json);
}

var _via_basic_demo_img = [];
var _via_basic_demo_img_filename = ['current_img.jpeg'];

// adutta_swan.jpg

_via_basic_demo_img.push('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4QDmRXhpZgAATU0AKgAAAAgABwEaAAUAAAABAAAAYgEbAAUAAAABAAAAagEoAAMAAAABAAIAAAE7AAIAAAAOAAAAcgITAAMAAAABAAEAAIKYAAIAAAAzAAAAgIdpAAQAAAABAAAAtAAAAAAAAABIAAAAAQAAAEgAAAABVHJ1amlsbG8gSnVhbgBodHRwczovL2NyZWF0aXZlY29tbW9ucy5vcmcvcHVibGljZG9tYWluL3plcm8vMS4wLwAAAAOQAAAHAAAABDAyMTCgAAAHAAAABDAxMDCgAQADAAAAAf//AAAAAAAA/+EELWh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8APD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4KPHg6eG1wbWV0YSB4bWxuczp4PSdhZG9iZTpuczptZXRhLyc+CjxyZGY6UkRGIHhtbG5zOnJkZj0naHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyc+CgogPHJkZjpEZXNjcmlwdGlvbiB4bWxuczpkYz0naHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8nPgogIDxkYzpkZXNjcmlwdGlvbj4KICAgPHJkZjpBbHQ+CiAgICA8cmRmOmxpIHhtbDpsYW5nPSd4LWRlZmF1bHQnPngtZGVmYXVsdDwvcmRmOmxpPgogICA8L3JkZjpBbHQ+CiAgPC9kYzpkZXNjcmlwdGlvbj4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24geG1sbnM6ZXhpZj0naHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8nPgogIDxleGlmOlhSZXNvbHV0aW9uPjcyPC9leGlmOlhSZXNvbHV0aW9uPgogIDxleGlmOllSZXNvbHV0aW9uPjcyPC9leGlmOllSZXNvbHV0aW9uPgogIDxleGlmOlJlc29sdXRpb25Vbml0PkluY2g8L2V4aWY6UmVzb2x1dGlvblVuaXQ+CiAgPGV4aWY6QXJ0aXN0PlRydWppbGxvIEp1YW48L2V4aWY6QXJ0aXN0PgogIDxleGlmOllDYkNyUG9z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');


"use strict";

var VIA_VERSION      = '2.0.9';
var VIA_NAME         = 'VGG Image Annotator';
var VIA_SHORT_NAME   = 'VIA';
var VIA_REGION_SHAPE = { RECT:'rect',
                         CIRCLE:'circle',
                         ELLIPSE:'ellipse',
                         POLYGON:'polygon',
                         POINT:'point',
                         POLYLINE:'polyline'
                       };

var VIA_ATTRIBUTE_TYPE = { TEXT:'text',
                           CHECKBOX:'checkbox',
                           RADIO:'radio',
                           IMAGE:'image',
                           DROPDOWN:'dropdown'
                         };

var VIA_DISPLAY_AREA_CONTENT_NAME = {IMAGE:'image_panel',
                                     IMAGE_GRID:'image_grid_panel',
                                     SETTINGS:'settings_panel',
                                     PAGE_404:'page_404',
                                     PAGE_GETTING_STARTED:'page_getting_started',
                                     PAGE_ABOUT:'page_about',
                                     PAGE_START_INFO:'page_start_info',
                                     PAGE_LICENSE:'page_license'
                                    };

var VIA_ANNOTATION_EDITOR_MODE    = {SINGLE_REGION:'single_region',
                                     ALL_REGIONS:'all_regions'};
var VIA_ANNOTATION_EDITOR_PLACEMENT = {NEAR_REGION:'NEAR_REGION',
                                       IMAGE_BOTTOM:'IMAGE_BOTTOM',
                                       DISABLE:'DISABLE'};

var VIA_REGION_EDGE_TOL           = 5;   // pixel
var VIA_REGION_CONTROL_POINT_SIZE = 2;
var VIA_POLYGON_VERTEX_MATCH_TOL  = 5;
var VIA_REGION_MIN_DIM            = 3;
var VIA_MOUSE_CLICK_TOL           = 2;
var VIA_ELLIPSE_EDGE_TOL          = 0.2; // euclidean distance
var VIA_THETA_TOL                 = Math.PI/18; // 10 degrees
var VIA_POLYGON_RESIZE_VERTEX_OFFSET  = 100;
var VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX = 3;
var VIA_CANVAS_ZOOM_LEVELS = [0.25, 0.5, 0.75, 1.0, 1.5, 2.0, 2.5, 3.0, 4, 5, 6, 7, 8, 9, 10];
var VIA_REGION_COLOR_LIST = ["#E69F00", "#56B4E9", "#009E73", "#D55E00", "#CC79A7", "#F0E442", "#ffffff"];
var VIA_REGION_POINT_RADIUS         = 3;
var VIA_REGION_POINT_RADIUS_DEFAULT = 3;

var VIA_THEME_REGION_BOUNDARY_WIDTH = 3;
var VIA_THEME_BOUNDARY_LINE_COLOR   = "black";
var VIA_THEME_BOUNDARY_FILL_COLOR   = "yellow";
var VIA_THEME_SEL_REGION_FILL_COLOR = "#808080";
var VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR = "yellow";
var VIA_THEME_SEL_REGION_OPACITY    = 0.5;
var VIA_THEME_MESSAGE_TIMEOUT_MS    = 6000;
var VIA_THEME_CONTROL_POINT_COLOR   = '#ff0000';

var VIA_CSV_SEP        = ',';
var VIA_CSV_QUOTE_CHAR = '"';
var VIA_CSV_KEYVAL_SEP = ':';

var _via_img_metadata = {};   // data structure to store loaded images metadata
var _via_img_src      = {};   // image content {abs. path, url, base64 data, etc}
var _via_img_fileref  = {};   // reference to local images selected by using browser file selector
var _via_img_count    = 0;    // count of the loaded images
var _via_canvas_regions = []; // image regions spec. in canvas space
var _via_canvas_scale   = 1.0;// current scale of canvas image

var _via_image_id       = ''; // id={filename+length} of current image
var _via_image_index    = -1; // index

var _via_current_image_filename;
var _via_current_image;
var _via_current_image_width;
var _via_current_image_height;

// a record of image statistics (e.g. width, height)
var _via_img_stat     = {};
var _via_is_all_img_stat_read_ongoing = false;
var _via_img_stat_current_img_index = false;

// image canvas
var _via_display_area = document.getElementById('display_area');
var _via_img_panel    = document.getElementById('image_panel');
var _via_reg_canvas   = document.getElementById('region_canvas');
var _via_reg_ctx; // initialized in _via_init()
var _via_canvas_width, _via_canvas_height;

// canvas zoom
var _via_canvas_zoom_level_index   = VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX; // 1.0
var _via_canvas_scale_without_zoom = 1.0;

// state of the application
var _via_is_user_drawing_region  = false;
var _via_current_image_loaded    = false;
var _via_is_window_resized       = false;
var _via_is_user_resizing_region = false;
var _via_is_user_moving_region   = false;
var _via_is_user_drawing_polygon = false;
var _via_is_region_selected      = false;
var _via_is_all_region_selected  = false;
var _via_is_loaded_img_list_visible  = false;
var _via_is_attributes_panel_visible = false;
var _via_is_reg_attr_panel_visible   = false;
var _via_is_file_attr_panel_visible  = false;
var _via_is_canvas_zoomed            = false;
var _via_is_loading_current_image    = false;
var _via_is_region_id_visible        = true;
var _via_is_region_boundary_visible  = true;
var _via_is_region_info_visible      = false;
var _via_is_ctrl_pressed             = false;
var _via_is_debug_mode               = false;

// region
var _via_current_shape             = VIA_REGION_SHAPE.RECT;
var _via_current_polygon_region_id = -1;
var _via_user_sel_region_id        = -1;
var _via_click_x0 = 0; var _via_click_y0 = 0;
var _via_click_x1 = 0; var _via_click_y1 = 0;
var _via_region_click_x, _via_region_click_y;
var _via_region_edge          = [-1, -1];
var _via_current_x = 0; var _via_current_y = 0;

// region copy/paste
var _via_region_selected_flag = []; // region select flag for current image
var _via_copied_image_regions = [];
var _via_paste_to_multiple_images_input;

// message
var _via_message_clear_timer;

// attributes
var _via_attribute_being_updated       = 'region'; // {region, file}
var _via_attributes                    = { 'region':{}, 'file':{} };
var _via_current_attribute_id          = '';

// region group color
var _via_canvas_regions_group_color = {}; // color of each region

// invoke a method after receiving user input
var _via_user_input_ok_handler     = null;
var _via_user_input_cancel_handler = null;
var _via_user_input_data           = {};

// annotation editor
var _via_annotaion_editor_panel     = document.getElementById('annotation_editor_panel');
var _via_metadata_being_updated     = 'region'; // {region, file}
var _via_annotation_editor_mode     = VIA_ANNOTATION_EDITOR_MODE.SINGLE_REGION;

// persistence to local storage
var _via_is_local_storage_available = false;
var _via_is_save_ongoing            = false;

// all the image_id and image_filename of images added by the user is
// stored in _via_image_id_list and _via_image_filename_list
//
// Image filename list (img_fn_list) contains a filtered list of images
// currently accessible by the user. The img_fn_list is visible in the
// left side toolbar. image_grid, next/prev, etc operations depend on
// the contents of _via_img_fn_list_img_index_list.
var _via_image_id_list                 = []; // array of all image id (in order they were added by user)
var _via_image_filename_list           = []; // array of all image filename
var _via_image_load_error              = []; // {true, false}
var _via_image_filepath_resolved       = []; // {true, false}
var _via_image_filepath_id_list        = []; // path for each file

var _via_reload_img_fn_list_table      = true;
var _via_img_fn_list_img_index_list    = []; // image index list of images show in img_fn_list
var _via_img_fn_list_html              = []; // html representation of image filename list

// image grid
var image_grid_panel                        = document.getElementById('image_grid_panel');
var _via_display_area_content_name          = ''; // describes what is currently shown in display area
var _via_display_area_content_name_prev     = '';
var _via_image_grid_requires_update         = false;
var _via_image_grid_content_overflow        = false;
var _via_image_grid_load_ongoing            = false;
var _via_image_grid_page_first_index        = 0; // array index in _via_img_fn_list_img_index_list[]
var _via_image_grid_page_last_index         = -1;
var _via_image_grid_selected_img_index_list = [];
var _via_image_grid_page_img_index_list     = []; // list of all image index in current page of image grid
var _via_image_grid_visible_img_index_list  = []; // list of images currently visible in grid
var _via_image_grid_mousedown_img_index     = -1;
var _via_image_grid_mouseup_img_index       = -1;
var _via_image_grid_img_index_list          = []; // list of all image index in the image grid
var _via_image_grid_region_index_list       = []; // list of all image index in the image grid
var _via_image_grid_group                   = {}; // {'value':[image_index_list]}
var _via_image_grid_group_var               = []; // {type, name, value}
var _via_image_grid_group_show_all          = false;
var _via_image_grid_stack_prev_page         = []; // stack of first img index of every page navigated so far

// image buffer
var VIA_IMG_PRELOAD_INDICES         = [1, -1, 2, 3, -2, 4]; // for any image, preload previous 2 and next 4 images
var VIA_IMG_PRELOAD_COUNT           = 4;
var _via_buffer_preload_img_index   = -1;
var _via_buffer_img_index_list      = [];
var _via_buffer_img_shown_timestamp = [];
var _via_preload_img_promise_list   = [];

// via settings
var _via_settings = {};
_via_settings.ui  = {};
_via_settings.ui.annotation_editor_height   = 25; // in percent of the height of browser window
_via_settings.ui.annotation_editor_fontsize = 0.8;// in rem
_via_settings.ui.leftsidebar_width          = 18;  // in rem

_via_settings.ui.image_grid = {};
_via_settings.ui.image_grid.img_height          = 80;  // in pixel
_via_settings.ui.image_grid.rshape_fill         = 'none';
_via_settings.ui.image_grid.rshape_fill_opacity = 0.3;
_via_settings.ui.image_grid.rshape_stroke       = 'yellow';
_via_settings.ui.image_grid.rshape_stroke_width = 2;
_via_settings.ui.image_grid.show_region_shape   = true;
_via_settings.ui.image_grid.show_image_policy   = 'all';

_via_settings.ui.image = {};
_via_settings.ui.image.region_label      = '__via_region_id__'; // default: region_id
_via_settings.ui.image.region_color      = '__via_default_region_color__'; // default color: yellow
_via_settings.ui.image.region_label_font = '10px Sans';
_via_settings.ui.image.on_image_annotation_editor_placement = VIA_ANNOTATION_EDITOR_PLACEMENT.NEAR_REGION;

_via_settings.core                  = {};
_via_settings.core.buffer_size      = 4*VIA_IMG_PRELOAD_COUNT + 2;
_via_settings.core.filepath         = {};
_via_settings.core.default_filepath = '';

// UI html elements
var invisible_file_input = document.getElementById("invisible_file_input");
var display_area    = document.getElementById("display_area");
var ui_top_panel    = document.getElementById("ui_top_panel");
var image_panel     = document.getElementById("image_panel");
var img_buffer_now  = document.getElementById("img_buffer_now");

var annotation_list_snippet = document.getElementById("annotation_list_snippet");
var annotation_textarea     = document.getElementById("annotation_textarea");

var img_fn_list_panel     = document.getElementById('img_fn_list_panel');
var img_fn_list           = document.getElementById('img_fn_list');
var attributes_panel      = document.getElementById('attributes_panel');
var leftsidebar           = document.getElementById('leftsidebar');

var BBOX_LINE_WIDTH       = 4;
var BBOX_SELECTED_OPACITY = 0.3;
var BBOX_BOUNDARY_FILL_COLOR_ANNOTATED = "#f2f2f2";
var BBOX_BOUNDARY_FILL_COLOR_NEW       = "#aaeeff";
var BBOX_BOUNDARY_LINE_COLOR           = "#1a1a1a";
var BBOX_SELECTED_FILL_COLOR           = "#ffffff";

var VIA_ANNOTATION_EDITOR_HEIGHT_CHANGE   = 5;   // in percent
var VIA_ANNOTATION_EDITOR_FONTSIZE_CHANGE = 0.1; // in rem
var VIA_IMAGE_GRID_IMG_HEIGHT_CHANGE      = 20;  // in percent
var VIA_LEFTSIDEBAR_WIDTH_CHANGE          = 1;   // in rem
var VIA_POLYGON_SEGMENT_SUBTENDED_ANGLE   = 5;   // in degree (used to approximate shapes using polygon)
var VIA_FLOAT_PRECISION = 3; // number of decimal places to include in float values

//
// Data structure to store metadata about file and regions
//
function file_metadata(filename, size) {
  this.filename = filename;
  this.size     = size;         // file size in bytes
  this.regions  = [];           // array of file_region()
  this.file_attributes = {};    // image attributes
}

function file_region() {
  this.shape_attributes  = {}; // region shape attributes
  this.region_attributes = {}; // region attributes
}

//
// Initialization routine
//
function _via_init() {
  console.log(VIA_NAME);
  show_message(VIA_NAME + ' (' + VIA_SHORT_NAME + ') version ' + VIA_VERSION +
               '. Ready !', 2*VIA_THEME_MESSAGE_TIMEOUT_MS);

  if ( _via_is_debug_mode ) {
    document.getElementById('ui_top_panel').innerHTML += '<span>DEBUG MODE</span>';
  }

  document.getElementById('img_fn_list').style.display = 'block';
  document.getElementById('leftsidebar').style.display = 'table-cell';

  // initialize default project
  project_init_default_project();

  // initialize region canvas 2D context
  _via_init_reg_canvas_context();

  // initialize user input handlers (for both window and via_reg_canvas)
  // handles drawing of regions by user over the image
  _via_init_keyboard_handlers();
  _via_init_mouse_handlers();

  // initialize image grid
  image_grid_init();

  show_single_image_view();
  init_leftsidebar_accordion();
  attribute_update_panel_set_active_button();
  annotation_editor_set_active_button();
  init_message_panel();

  // run attached sub-modules (if any)
  // e.g. demo modules
  if (typeof _via_load_submodules === 'function') {
    console.log('Loading VIA submodule');
    setTimeout( async function() {
      await _via_load_submodules();
    }, 100);
  }

}

function _via_init_reg_canvas_context() {
  _via_reg_ctx  = _via_reg_canvas.getContext('2d');
}

function _via_init_keyboard_handlers() {
  window.addEventListener('keydown', _via_window_keydown_handler, false);
  _via_reg_canvas.addEventListener('keydown', _via_reg_canvas_keydown_handler, false);
  _via_reg_canvas.addEventListener('keyup', _via_reg_canvas_keyup_handler, false);
}

// handles drawing of regions over image by the user
function _via_init_mouse_handlers() {
  _via_reg_canvas.addEventListener('dblclick', _via_reg_canvas_dblclick_handler, false);
  _via_reg_canvas.addEventListener('mousedown', _via_reg_canvas_mousedown_handler, false);
  _via_reg_canvas.addEventListener('mouseup', _via_reg_canvas_mouseup_handler, false);
  _via_reg_canvas.addEventListener('mouseover', _via_reg_canvas_mouseover_handler, false);
  _via_reg_canvas.addEventListener('mousemove', _via_reg_canvas_mousemove_handler, false);
  _via_reg_canvas.addEventListener('wheel', _via_reg_canvas_mouse_wheel_listener, false);
  // touch screen event handlers
  // @todo: adapt for mobile users
  _via_reg_canvas.addEventListener('touchstart', _via_reg_canvas_mousedown_handler, false);
  _via_reg_canvas.addEventListener('touchend', _via_reg_canvas_mouseup_handler, false);
  _via_reg_canvas.addEventListener('touchmove', _via_reg_canvas_mousemove_handler, false);
}

//
// Download image with annotations
//

function download_as_image() {
  if ( _via_display_area_content_name !== VIA_DISPLAY_AREA_CONTENT_NAME['IMAGE'] ) {
    show_message('This functionality is only available in single image view mode');
    return;
  } else {
    var c = document.createElement('canvas');

    // ensures that downloaded image is scaled at current zoom level
    c.width  = _via_reg_canvas.width;
    c.height = _via_reg_canvas.height;

    var ct = c.getContext('2d');
    // draw current image
    ct.drawImage(_via_current_image, 0, 0, _via_reg_canvas.width, _via_reg_canvas.height);
    // draw current regions
    ct.drawImage(_via_reg_canvas, 0, 0);

    var cur_img_mime = 'image/jpeg';
    if ( _via_current_image.src.startsWith('data:') )  {
      var c1 = _via_current_image.src.indexOf(':', 0);
      var c2 = _via_current_image.src.indexOf(';', c1);
      cur_img_mime = _via_current_image.src.substring(c1 + 1, c2);
    }

    // extract image data from canvas
    var saved_img = c.toDataURL(cur_img_mime);
    saved_img.replace(cur_img_mime, "image/octet-stream");

    // simulate user click to trigger download of image
    var a      = document.createElement('a');
    a.href     = saved_img;
    a.target   = '_blank';
    a.download = _via_current_image_filename;

    // simulate a mouse click event
    var event = new MouseEvent('click', {
      view: window,
      bubbles: true,
      cancelable: true
    });

    a.dispatchEvent(event);
  }
}

//
// Display area content
//
function clear_display_area() {
  var panels = document.getElementsByClassName('display_area_content');
  var i;
  for ( i = 0; i < panels.length; ++i ) {
    panels[i].classList.add('display_none');
  }
}

function is_content_name_valid(content_name) {
  var e;
  for ( e in VIA_DISPLAY_AREA_CONTENT_NAME ) {
    if ( VIA_DISPLAY_AREA_CONTENT_NAME[e] === content_name ) {
      return true;
    }
  }
  return false;
}

function show_home_panel() {
  show_single_image_view();
}

function set_display_area_content(content_name) {
  if ( is_content_name_valid(content_name) ) {
    _via_display_area_content_name_prev = _via_display_area_content_name;
    clear_display_area();
    var p = document.getElementById(content_name);
    p.classList.remove('display_none');
    _via_display_area_content_name = content_name;
  }
}

function show_single_image_view() {
  if (_via_current_image_loaded) {
    img_fn_list_clear_all_style();
    _via_show_img(_via_image_index);
    set_display_area_content(VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE);
    annotation_editor_update_content();

    var p = document.getElementById('toolbar_image_grid_toggle');
    p.firstChild.setAttribute('xlink:href', '#icon_gridon');
    p.childNodes[1].innerHTML = 'Switch to Image Grid View';
  } else {
    set_display_area_content(VIA_DISPLAY_AREA_CONTENT_NAME.PAGE_START_INFO);
  }
}

function show_image_grid_view() {
  if (_via_current_image_loaded) {
    img_fn_list_clear_all_style();
    set_display_area_content(VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID);
    image_grid_toolbar_update_group_by_select();

    if ( _via_image_grid_group_var.length === 0 ) {
      image_grid_show_all_project_images();
    }
    annotation_editor_update_content();

    var p = document.getElementById('toolbar_image_grid_toggle');
    p.firstChild.setAttribute('xlink:href', '#icon_gridoff');
    p.childNodes[1].innerHTML = 'Switch to Single Image View';

    //edit_file_metadata_in_annotation_editor();
  } else {
    set_display_area_content(VIA_DISPLAY_AREA_CONTENT_NAME.PAGE_START_INFO);
  }
}

//
// Handlers for top navigation bar
//
function sel_local_images() {
  // source: https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications
  if (invisible_file_input) {
    invisible_file_input.setAttribute('multiple', 'multiple')
    invisible_file_input.accept   = '.jpg,.jpeg,.png,.bmp';
    invisible_file_input.onchange = project_file_add_local;
    invisible_file_input.click();
  }
}

function download_all_region_data(type, file_extension) {
  if ( typeof(file_extension) === 'undefined' ) {
    file_extension = type;
  }

  // Javascript strings (DOMString) is automatically converted to utf-8
  // see: https://developer.mozilla.org/en-US/docs/Web/API/Blob/Blob
  pack_via_metadata(type).then( function(data) {
    var blob_attr = {type: 'text/'+file_extension+';charset=utf-8'};
    var all_region_data_blob = new Blob(data, blob_attr);

    var filename = 'via_export';
    if ( file_extension !== 'csv' || file_extension !== 'json' ) {
      filename += '_' + type + '.' + file_extension;
    }
    save_data_to_local_file(all_region_data_blob, filename);
  }.bind(this), function(err) {
    show_message('Failed to download data: [' + err + ']');
  }.bind(this));
}

function sel_local_data_file(type) {
  if (invisible_file_input) {
    switch(type) {
    case 'annotations':
      invisible_file_input.accept='.csv,.json';
      invisible_file_input.onchange = import_annotations_from_file;
      break;

    case 'annotations_coco':
      invisible_file_input.accept='.json';
      invisible_file_input.onchange = import_annotations_from_file;
      break;

    case 'files_url':
      invisible_file_input.accept='';
      invisible_file_input.onchange = import_files_url_from_file;
      break;

    case 'attributes':
      invisible_file_input.accept='json';
      invisible_file_input.onchange = project_import_attributes_from_file;
      break;

    default:
      console.log('sel_local_data_file() : unknown type ' + type);
      return;
    }
    invisible_file_input.removeAttribute('multiple');
    invisible_file_input.click();
  }
}

//
// Data Importer
//
function import_files_url_from_file(event) {
  var selected_files = event.target.files;
  var i, file;
  for ( i = 0; i < selected_files.length; ++i ) {
    file = selected_files[i];
    load_text_file(file, import_files_url_from_csv);
  }
}

function import_annotations_from_file(event) {
  var selected_files = event.target.files;
  var i, file;
  for ( i = 0; i < selected_files.length; ++i ) {
    file = selected_files[i];
    switch ( file.type ) {
    case '': // Fall-through // Windows 10: Firefox and Chrome do not report filetype
      show_message('File type for ' + file.name + ' cannot be determined! Assuming text/plain.');
    case 'text/plain': // Fall-through
    case 'application/vnd.ms-excel': // Fall-through // @todo: filetype of VIA csv annotations in Windows 10 , fix this (reported by @Eli Walker)
    case 'text/csv':
      load_text_file(file, import_annotations_from_csv);
      break;

    case 'text/json': // Fall-through
    case 'application/json':
      load_text_file(file, import_annotations_from_json);
      break;

    default:
      show_message('Annotations cannot be imported from file of type ' + file.type);
      break;
    }
  }
}

function import_annotations_from_csv(data) {
  return new Promise( function(ok_callback, err_callback) {
    if ( data === '' || typeof(data) === 'undefined') {
      err_callback();
    }

    var region_import_count = 0;
    var malformed_csv_lines_count = 0;
    var file_added_count = 0;

    var line_split_regex = new RegExp('\n|\r|\r\n', 'g');
    var csvdata = data.split(line_split_regex);

    var parsed_header = parse_csv_header_line(csvdata[0]);
    console.log(parsed_header)
    if ( ! parsed_header.is_header ) {
      show_message('Header line missing in the CSV file');
      err_callback();
      return;
    }

    var percent_completed = 0;
    var n = csvdata.length;
    var i;
    var first_img_id = '';
    for ( i = 1; i < n; ++i ) {
      // ignore blank lines
      if (csvdata[i].charAt(0) === '\n' || csvdata[i].charAt(0) === '') {
        continue;
      }

      var d = parse_csv_line(csvdata[i]);

      // check if csv line was malformed
      if ( d.length !== parsed_header.csv_column_count ) {
        malformed_csv_lines_count += 1;
        continue;
      }

      var filename = d[parsed_header.filename_index];
      var size     = d[parsed_header.size_index];
      var img_id   = _via_get_image_id(filename, size);

      // check if file is already present in this project
      if ( ! _via_img_metadata.hasOwnProperty(img_id) ) {
        img_id = project_add_new_file(filename, size);
        if ( _via_settings.core.default_filepath === '' ) {
          _via_img_src[img_id] = filename;
        } else {
          _via_file_resolve_file_to_default_filepath(img_id);
        }
        file_added_count += 1;

        if ( first_img_id === '' ) {
          first_img_id = img_id;
        }
      }

      // copy file attributes
      if ( d[parsed_header.file_attr_index] !== '"{}"') {
        var fattr = d[parsed_header.file_attr_index];
        fattr     = remove_prefix_suffix_quotes( fattr );
        fattr     = unescape_from_csv( fattr );

        var m = json_str_to_map( fattr );
        for( var key in m ) {
          _via_img_metadata[img_id].file_attributes[key] = m[key];

          // add this file attribute to _via_attributes
          if ( ! _via_attributes['file'].hasOwnProperty(key) ) {
            _via_attributes['file'][key] = { 'type':'text' };
          }
        }
      }

      var region_i = new file_region();
      // copy regions shape attributes
      if ( d[parsed_header.region_shape_attr_index] !== '"{}"' ) {
        var sattr = d[parsed_header.region_shape_attr_index];
        sattr     = remove_prefix_suffix_quotes( sattr );
        sattr     = unescape_from_csv( sattr );

        var m = json_str_to_map( sattr );
        for ( var key in m ) {
          region_i.shape_attributes[key] = m[key];
        }
      }

      // copy region attributes
      if ( d[parsed_header.region_attr_index] !== '"{}"' ) {
        var rattr = d[parsed_header.region_attr_index];
        rattr     = remove_prefix_suffix_quotes( rattr );
        rattr     = unescape_from_csv( rattr );

        var m = json_str_to_map( rattr );
        for ( var key in m ) {
          region_i.region_attributes[key] = m[key];

          // add this region attribute to _via_attributes
          if ( ! _via_attributes['region'].hasOwnProperty(key) ) {
            _via_attributes['region'][key] = { 'type':'text' };
          }
        }
      }

      // add regions only if they are present
      if (Object.keys(region_i.shape_attributes).length > 0 ||
          Object.keys(region_i.region_attributes).length > 0 ) {
        _via_img_metadata[img_id].regions.push(region_i);
        region_import_count += 1;
      }
    }
    show_message('Import Summary : [' + file_added_count + '] new files, ' +
                 '[' + region_import_count + '] regions, ' +
                 '[' + malformed_csv_lines_count  + '] malformed csv lines.');

    if ( file_added_count ) {
      update_img_fn_list();
    }

    if ( _via_current_image_loaded ) {
      if ( region_import_count ) {
        update_attributes_update_panel();
        annotation_editor_update_content();
        _via_load_canvas_regions(); // image to canvas space transform
        _via_redraw_reg_canvas();
        _via_reg_canvas.focus();
      }
    } else {
      if ( file_added_count ) {
        var first_img_index = _via_image_id_list.indexOf(first_img_id);
        _via_show_img( first_img_index );
      }
    }
    ok_callback([file_added_count, region_import_count, malformed_csv_lines_count]);
  });
}

function parse_csv_header_line(line) {
  var header_via_10x = '#filename,file_size,file_attributes,region_count,region_id,region_shape_attributes,region_attributes'; // VIA versions 1.0.x
  var header_via_11x = 'filename,file_size,file_attributes,region_count,region_id,region_shape_attributes,region_attributes'; // VIA version 1.1.x

  if ( line === header_via_10x || line === header_via_11x ) {
    return { 'is_header':true,
             'filename_index': 0,
             'size_index': 1,
             'file_attr_index': 2,
             'region_shape_attr_index': 5,
             'region_attr_index': 6,
             'csv_column_count': 7
           }
  } else {
    return { 'is_header':false };
  }
}

function import_annotations_from_json(data_str) {
  return new Promise( function(ok_callback, err_callback) {
    if (data_str === '' || typeof(data_str) === 'undefined') {
      return;
    }

    var data = JSON.parse(data_str);
    var d;

    if ( data.hasOwnProperty('info') && data.hasOwnProperty('categories') &&
         data.hasOwnProperty('images') && data.hasOwnProperty('annotations')
       ) {
      // import annotations in COCO format
      d = coco_to_via(data);
    } else {
      d = data;
    }

    var region_import_count = 0;
    var file_added_count    = 0;
    var malformed_entries_count    = 0;
    for (var img_id in d) {
      if ( ! _via_img_metadata.hasOwnProperty(img_id) ) {
        project_add_new_file(d[img_id].filename, d[img_id].size, img_id);
        if ( _via_settings.core.default_filepath === '' ) {
          _via_img_src[img_id] = d[img_id].filename;
        } else {
          _via_file_resolve_file_to_default_filepath(img_id);
        }
        file_added_count += 1;
      }

      // copy file attributes
      var key;
      for ( key in d[img_id].file_attributes ) {
        if ( key === '' ) {
          continue;
        }

        _via_img_metadata[img_id].file_attributes[key] = d[img_id].file_attributes[key];

        // add this file attribute to _via_attributes
        if ( ! _via_attributes['file'].hasOwnProperty(key) ) {
          _via_attributes['file'][key] = { 'type':'text' };
        }
      }

      // copy regions
      var regions = d[img_id].regions;
      var key, i;
      for ( i in regions ) {
        var region_i = new file_region();
        for ( key in regions[i].shape_attributes ) {
          region_i.shape_attributes[key] = regions[i].shape_attributes[key];
        }
        for ( var key in regions[i].region_attributes ) {
          if ( key === '' ) {
            continue;
          }

          region_i.region_attributes[key] = regions[i].region_attributes[key];

          // add this region attribute to _via_attributes
          if ( ! _via_attributes['region'].hasOwnProperty(key) ) {
            _via_attributes['region'][key] = { 'type':'text' };
          }
        }

        // add regions only if they are present
        if ( Object.keys(region_i.shape_attributes).length > 0 ||
             Object.keys(region_i.region_attributes).length > 0 ) {
          _via_img_metadata[img_id].regions.push(region_i);
          region_import_count += 1;
        }
      }
    }
    show_message('Import Summary : [' + file_added_count + '] new files, ' +
                 '[' + region_import_count + '] regions, ' +
                 '[' + malformed_entries_count + '] malformed entries.');

    if ( file_added_count ) {
      update_img_fn_list();
    }

    if ( _via_current_image_loaded ) {
      if ( region_import_count ) {
        update_attributes_update_panel();
        annotation_editor_update_content();
        _via_load_canvas_regions(); // image to canvas space transform
        _via_redraw_reg_canvas();
        _via_reg_canvas.focus();
      }
    } else {
      if ( file_added_count ) {
        _via_show_img(0);
      }
    }

    ok_callback([file_added_count, region_import_count, malformed_entries_count]);
  });
}

// convert from coco JSON format to VIA JSON format
// see http://cocodataset.org/#format-data
function coco_to_via(coco) {
  var d = {};

  // create an index of all categories
  var category_list = {}
  for ( var cat_index in coco.categories ) {
    var catid = coco.categories[cat_index]['id'];
    category_list[catid] = coco.categories[cat_index]['name'];
  }

  // create an index of all annotations
  var annotation_list = {}
  for ( var annotation_index in coco.annotations ) {
    var coco_image_id = coco.annotations[annotation_index]['image_id'];
    if ( ! annotation_list.hasOwnProperty(coco_image_id) ) {
      annotation_list[coco_image_id] = [];
    }
    annotation_list[coco_image_id].push( annotation_index );
  }

  // add all files and annotations
  for ( var coco_img_index in coco.images ) {
    var filename = coco.images[coco_img_index]['file_name'];
    if ( coco.images[coco_img_index].hasOwnProperty('coco_url') ) {
      filename = coco.images[coco_img_index]['coco_url'];
    }
    var size = -1;
    var via_img_id = _via_get_image_id(filename, size);
    var coco_img_id = coco.images[coco_img_index]['id'];
    var width = coco.images[coco_img_index]['width'];
    var height = coco.images[coco_img_index]['height'];

    d[via_img_id] = { 'filename':filename,
                      'size':size,
                      'regions':[],
                      'file_attributes':{'width':width, 'height':height},
                    };

    // add all annotations associated with this file
    if ( annotation_list.hasOwnProperty(coco_img_id) ) {
      for ( var i in annotation_list[coco_img_id] ) {
        var annotation = coco.annotations[ annotation_list[coco_img_id][i] ];

        var category_id = -1;
        if ( annotation.category_id !== "undefined") {
          category_id = annotation.category_id - 1;
        }

        var bbox_from_polygon = polygon_to_bbox(annotation['segmentation']);

        // fix for variations in segmentation:
        // annotation['segmentation'] = [x0,y0,x1,y1,...]
        // annotation['segmentation'] = [[x0,y0,x1,y1,...]]
        var seg = annotation['segmentation'];
        if ( seg.length === 1 && seg[0].length !== 0 ) {
          seg = annotation['segmentation'][0];
        }

        // check if imported region is polygon or rectangle
        var is_rectangle = true;
        var anno_bbox = annotation['bbox'];
        for (var i = 0; i < anno_bbox.length; ++i) {
          if (anno_bbox[i] !== bbox_from_polygon[i]) {
            is_rectangle = false;
            break;
          }
        }

        if ( seg.length === 8 && is_rectangle ) {
          // a rectangle
          var r = { 'shape_attributes': { 'name':'rect', 'x': [], 'y': [], 'width': [], 'height': []},
                    'region_attributes': {},
                  };
          r['shape_attributes']['x'].push( anno_bbox[0] );
          r['shape_attributes']['y'].push( anno_bbox[1] );
          r['shape_attributes']['width'].push( anno_bbox[2] );
          r['shape_attributes']['height'].push( anno_bbox[3] );

          if ( category_id !== -1 && !isNaN(category_id)) {
            var sup_category = coco.categories[category_id]['supercategory'];
            r['region_attributes'][sup_category] = coco.categories[category_id]['name'];
          }
        } else {
          // other shapes
          var r = { 'shape_attributes': { 'name':'polygon', 'all_points_x':[], 'all_points_y':[] },
            'region_attributes': {},
          };
          for ( var j = 0; j < seg.length; j = j + 2 ) {
            r['shape_attributes']['all_points_x'].push( seg[j] );
            r['shape_attributes']['all_points_y'].push( seg[j+1] );
          }
        }
        d[via_img_id].regions.push(r);
      }
    }
  }
  return d;
}

// assumes that csv line follows the RFC 4180 standard
// see: https://en.wikipedia.org/wiki/Comma-separated_values
function parse_csv_line(s, field_separator) {
  if (typeof(s) === 'undefined' || s.length === 0 ) {
    return [];
  }

  if (typeof(field_separator) === 'undefined') {
    field_separator = ',';
  }
  var double_quote_seen = false;
  var start = 0;
  var d = [];

  var i = 0;
  while ( i < s.length) {
    if (s.charAt(i) === field_separator) {
      if (double_quote_seen) {
        // field separator inside double quote is ignored
        i = i + 1;
      } else {
        //var part = s.substr(start, i - start);
        d.push( s.substr(start, i - start) );
        start = i + 1;
        i = i + 1;
      }
    } else {
      if (s.charAt(i) === '"') {
        if (double_quote_seen) {
          if (s.charAt(i+1) === '"') {
            // ignore escaped double quotes
            i = i + 2;
          } else {
            // closing of double quote
            double_quote_seen = false;
            i = i + 1;
          }
        } else {
          double_quote_seen = true;
          start = i;
          i = i + 1;
        }
      } else {
        i = i + 1;
      }
    }

  }
  // extract the last field (csv rows have no trailing comma)
  d.push( s.substr(start) );
  return d;
}

// s = '{"name":"rect","x":188,"y":90,"width":243,"height":233}'
function json_str_to_map(s) {
  if (typeof(s) === 'undefined' || s.length === 0 ) {
    return {};
  }

  return JSON.parse(s);
}

// ensure the exported json string conforms to RFC 4180
// see: https://en.wikipedia.org/wiki/Comma-separated_values
function map_to_json(m) {
  var s = [];
  for ( var key in m ) {
    var v   = m[key];
    var si  = JSON.stringify(key);
    si += VIA_CSV_KEYVAL_SEP;
    si += JSON.stringify(v);
    s.push( si );
  }
  return '{' + s.join(VIA_CSV_SEP) + '}';
}

function escape_for_csv(s) {
  return s.replace(/["]/g, '""');
}

function unescape_from_csv(s) {
  return s.replace(/""/g, '"');
}

function remove_prefix_suffix_quotes(s) {
  if ( s.charAt(0) === '"' && s.charAt(s.length-1) === '"' ) {
    return s.substr(1, s.length-2);
  } else {
    return s;
  }
}

function clone_image_region(r0) {
  var r1 = new file_region();

  // copy shape attributes
  for ( var key in r0.shape_attributes ) {
    r1.shape_attributes[key] = clone_value(r0.shape_attributes[key]);
  }

  // copy region attributes
  for ( var key in r0.region_attributes ) {
    r1.region_attributes[key] = clone_value(r0.region_attributes[key]);
  }
  return r1;
}

function clone_value(value) {
  if ( typeof(value) === 'object' ) {
    if ( Array.isArray(value) ) {
      return value.slice(0);
    } else {
      var copy = {};
      for ( var p in value ) {
        if ( value.hasOwnProperty(p) ) {
          copy[p] = clone_value(value[p]);
        }
      }
      return copy;
    }
  }
  return value;
}

function _via_get_image_id(filename, size) {
  if ( typeof(size) === 'undefined' ) {
    return filename;
  } else {
    return filename + size;
  }
}

function load_text_file(text_file, callback_function) {
  if (text_file) {
    var text_reader = new FileReader();
    text_reader.addEventListener( 'progress', function(e) {
      show_message('Loading data from file : ' + text_file.name + ' ... ');
    }, false);

    text_reader.addEventListener( 'error', function() {
      show_message('Error loading data text file :  ' + text_file.name + ' !');
      callback_function('');
    }, false);

    text_reader.addEventListener( 'load', function() {
      callback_function(text_reader.result);
    }, false);
    text_reader.readAsText(text_file, 'utf-8');
  }
}

function import_files_url_from_csv(data) {
  return new Promise( function(ok_callback, err_callback) {
    if ( data === '' || typeof(data) === 'undefined') {
      err_callback();
    }

    var malformed_url_count = 0;
    var url_added_count = 0;

    var line_split_regex = new RegExp('\n|\r|\r\n', 'g');
    var csvdata = data.split(line_split_regex);

    var percent_completed = 0;
    var n = csvdata.length;
    var i;
    var img_id;
    var first_img_id = '';
    for ( i=0; i < n; ++i ) {
      // ignore blank lines
      if (csvdata[i].charAt(0) === '\n' || csvdata[i].charAt(0) === '') {
        malformed_url_count += 1;
        continue;
      } else {
        img_id = project_file_add_url(csvdata[i]);
        if ( first_img_id === '' ) {
          first_img_id = img_id;
        }
        url_added_count += 1;
      }
    }
    show_message('Added ' + url_added_count + ' files to project');
    if ( url_added_count ) {
      var first_img_index = _via_image_id_list.indexOf(first_img_id);
      _via_show_img(first_img_index);
      update_img_fn_list();
    }
  });
}

//
// Data Exporter
//
function pack_via_metadata(return_type) {
  return new Promise( function(ok_callback, err_callback) {
    if( return_type === 'csv' ) {
      var csvdata = [];
      var csvheader = 'filename,file_size,file_attributes,region_count,region_id,region_shape_attributes,region_attributes';
      csvdata.push(csvheader);

      for ( var image_id in _via_img_metadata ) {
        var fattr = map_to_json( _via_img_metadata[image_id].file_attributes );
        fattr = escape_for_csv( fattr );

        var prefix = '\n' + _via_img_metadata[image_id].filename;
        prefix += ',' + _via_img_metadata[image_id].size;
        prefix += ',"' + fattr + '"';

        var r = _via_img_metadata[image_id].regions;

        if ( r.length !==0 ) {
          for ( var i = 0; i < r.length; ++i ) {
            var csvline = [];
            csvline.push(prefix);
            csvline.push(r.length);
            csvline.push(i);

            var sattr = map_to_json( r[i].shape_attributes );
            sattr = '"' +  escape_for_csv( sattr ) + '"';
            csvline.push(sattr);

            var rattr = map_to_json( r[i].region_attributes );
            rattr = '"' +  escape_for_csv( rattr ) + '"';
            csvline.push(rattr);
            csvdata.push( csvline.join(VIA_CSV_SEP) );
          }
        } else {
          // @todo: reconsider this practice of adding an empty entry
          csvdata.push(prefix + ',0,0,"{}","{}"');
        }
      }
      ok_callback(csvdata);
    }

    // see http://cocodataset.org/#format-data
    if( return_type === 'coco' ) {
      img_stat_set_all().then( function(ok) {
        var d = { 'info':{}, 'images':[], 'annotations':[], 'licenses':[], 'categories':[] };
        d.info = {
          'year': new Date().getFullYear(),
          'version': '1',
          'description': 'Exported using VGG Image Annotator (http://www.robots.ox.ac.uk/~vgg/software/via/)',
          'contributor': '',
          'url': 'http://www.robots.ox.ac.uk/~vgg/software/via/',
          'date_created': new Date().toString(),
        };
        d.licenses = [ { 'id':1, 'name':'Unknown', 'url':'' } ];

        // add files
        var img_id, file_src;
        var annotation_id = 0;
        for ( var img_index in _via_image_id_list ) {
          img_id = _via_image_id_list[img_index];

          // add file
          if ( _via_img_fileref[img_id] instanceof File ) {
            file_src = _via_img_fileref[img_id].filename;
          } else {
            //file_src = _via_img_src[img_id];
            file_src = _via_img_metadata[img_id].filename;
          }
          d.images.push( {
            'id':parseInt(img_index),
            'width':_via_img_stat[img_index][0],
            'height':_via_img_stat[img_index][1],
            'file_name':_via_img_metadata[img_id].filename,
            'license':1,
            'flickr_url':file_src,
            'coco_url':file_src,
            'date_captured':'',
          } );

          // initialize categories
          var attrval_to_catid = {};
          var cat_id = 1;
          for ( var rid in _via_attributes['region'] ) {
            if ( _via_attributes['region'][rid].type === VIA_ATTRIBUTE_TYPE.CHECKBOX ||
                 _via_attributes['region'][rid].type === VIA_ATTRIBUTE_TYPE.DROPDOWN ||
                 _via_attributes['region'][rid].type === VIA_ATTRIBUTE_TYPE.RADIO ) {
              for ( var oid in _via_attributes['region'][rid]['options'] ) {
                d.categories.push( { 'id':cat_id, 'name':oid, 'supercategory':rid } );
                attrval_to_catid[oid] = cat_id;
                cat_id = cat_id + 1;
              }
            }
          }

          var shape_name, region;
          for ( var rindex in _via_img_metadata[img_id].regions ) {
            region = _via_img_metadata[img_id].regions[rindex];
            if ( region.shape_attributes['name'] === 'rect' ||
                 region.shape_attributes['name'] === 'circle' ||
                 region.shape_attributes['name'] === 'ellipse' ||
                 region.shape_attributes['name'] === 'polygon' ||
                 region.shape_attributes['name'] === 'point' ) {
              var annotation = via_region_shape_to_coco_annotation(region.shape_attributes);
              var attr_val;
              for(var k in region.region_attributes) {
                if ( region.region_attributes[k] !== "undefined" &&
                     Object.entries(region.region_attributes[k]).length > 0) {
                    attr_val = region.region_attributes[k];
                }
              }
              // assume there is only one value (radio button)
              cat_id = attrval_to_catid[attr_val];

              d.annotations.push( Object.assign({
                'id':annotation_id,
                'image_id':img_index,
                'category_id':cat_id,
              }, annotation) );
              annotation_id = annotation_id + 1;
            }
          }
        }
        ok_callback( [ JSON.stringify(d) ] );
      }.bind(this), function(err) {
        err_callback(err);
      }.bind(this));
    } else {
      // default format is JSON
      ok_callback( [ JSON.stringify(_via_img_metadata) ] );
    }
  }.bind(this));
}

function via_region_shape_to_coco_annotation(shape_attributes) {
  var annotation = { 'segmentation':[], 'area':[], 'bbox':[], 'iscrowd':0 };

  switch(shape_attributes['name']) {
  case 'rect':
    var x0 = shape_attributes['x'];
    var y0 = shape_attributes['y'];
    var w  = parseInt(shape_attributes['width']);
    var h  = parseInt(shape_attributes['height']);
    var x1 = x0 + w;
    var y1 = y0 + h;
    annotation['segmentation'] = [x0, y0, x1, y0, x1, y1, x0, y1];
    annotation['area'] =  w * h ;

    annotation['bbox'] = [x0, y0, w, h];
    break;

  case 'point':
    var cx = shape_attributes['cx'];
    var cy = shape_attributes['cy'];
    // 2 is for visibility - currently set to always inside segmentation.
    // see Keypoint Detection: http://cocodataset.org/#format-data
    annotation['keypoints'] = [cx, cy, 2];
    annotation['num_keypoints'] = 1;
    break;

  case 'circle':
    var a,b;
    a = shape_attributes['r'];
    b = shape_attributes['r'];
    var theta_to_radian = Math.PI/180;

    for ( var theta = 0; theta < 360; theta = theta + VIA_POLYGON_SEGMENT_SUBTENDED_ANGLE ) {
      var theta_radian = theta * theta_to_radian;
      var x = shape_attributes['cx'] + a * Math.cos(theta_radian);
      var y = shape_attributes['cy'] + b * Math.sin(theta_radian);
      annotation['segmentation'].push( fixfloat(x), fixfloat(y) );
    }
    annotation['bbox'] = polygon_to_bbox(annotation['segmentation']);
    annotation['area'] = annotation['bbox'][2] * annotation['bbox'][3];
    break;

  case 'ellipse':
    var a,b;
    a = shape_attributes['rx'];
    b = shape_attributes['ry'];
    var rotation = shape_attributes['theta'];
    var theta_to_radian = Math.PI/180;

    for ( var theta = 0; theta < 360; theta = theta + VIA_POLYGON_SEGMENT_SUBTENDED_ANGLE ) {
      var theta_radian = theta * theta_to_radian;
      var x = shape_attributes['cx'] +
              ( a * Math.cos(theta_radian) * Math.cos(rotation) ) -
              ( b * Math.sin(theta_radian) * Math.sin(rotation) );
      var y = shape_attributes['cy'] +
              ( a * Math.cos(theta_radian) * Math.sin(rotation) ) +
              ( b * Math.sin(theta_radian) * Math.cos(rotation) );
      annotation['segmentation'].push( fixfloat(x), fixfloat(y) );
    }
    annotation['bbox'] = polygon_to_bbox(annotation['segmentation']);
    annotation['area'] = annotation['bbox'][2] * annotation['bbox'][3];
    break;

  case 'polygon':
    annotation['segmentation'] = [];
    var x0 = +Infinity;
    var y0 = +Infinity;
    var x1 = -Infinity;
    var y1 = -Infinity;
    for ( var i in shape_attributes['all_points_x'] ) {
      annotation['segmentation'].push( shape_attributes['all_points_x'][i] );
      annotation['segmentation'].push( shape_attributes['all_points_y'][i] );
      if ( shape_attributes['all_points_x'][i] < x0 ) {
        x0 = shape_attributes['all_points_x'][i];
      }
      if ( shape_attributes['all_points_y'][i] < y0 ) {
        y0 = shape_attributes['all_points_y'][i];
      }
      if ( shape_attributes['all_points_x'][i] > x1 ) {
        x1 = shape_attributes['all_points_x'][i];
      }
      if ( shape_attributes['all_points_y'][i] > y1 ) {
        y1 = shape_attributes['all_points_y'][i];
      }
    }
    var w = x1 - x0;
    var h = y1 - y0;
    annotation['bbox'] = [x0, y0, w, h];
    annotation['area'] = w * h; // approximate area
  }
  return annotation;
}

function save_data_to_local_file(data, filename) {
  var a      = document.createElement('a');
  a.href     = URL.createObjectURL(data);
  a.download = filename;

  // simulate a mouse click event
  var event = new MouseEvent('click', {
    view: window,
    bubbles: true,
    cancelable: true
  });
  a.dispatchEvent(event);

  // @todo: replace a.dispatchEvent() with a.click()
  // a.click() based trigger is supported in Chrome 70 and Safari 11/12 but **not** in Firefox 63
  //a.click();
}

//
// Maintainers of user interface
//

function init_message_panel() {
  var p = document.getElementById('message_panel');
  p.addEventListener('mousedown', function() {
    this.style.display = 'none';
  }, false);
  p.addEventListener('mouseover', function() {
    clearTimeout(_via_message_clear_timer); // stop any previous timeouts
  }, false);
}

function show_message(msg, t) {
  if ( _via_message_clear_timer ) {
    clearTimeout(_via_message_clear_timer); // stop any previous timeouts
  }
  var timeout = t;
  if ( typeof t === 'undefined' ) {
    timeout = VIA_THEME_MESSAGE_TIMEOUT_MS;
  }
  document.getElementById('message_panel_content').innerHTML = msg;
  document.getElementById('message_panel').style.display = 'block';

  _via_message_clear_timer = setTimeout( function() {
    document.getElementById('message_panel').style.display = 'none';
  }, timeout);
}

function _via_regions_group_color_init() {
  _via_canvas_regions_group_color = {};
  var aid = _via_settings.ui.image.region_color;
  if ( aid !== '__via_default_region_color__' ) {
    var avalue;
    for ( var i = 0; i < _via_img_metadata[_via_image_id].regions.length; ++i ) {
      avalue = _via_img_metadata[_via_image_id].regions[i].region_attributes[aid];
      _via_canvas_regions_group_color[avalue] = 1;
    }
    var color_index = 0;
    for ( avalue in _via_canvas_regions_group_color ) {
      _via_canvas_regions_group_color[avalue] = VIA_REGION_COLOR_LIST[ color_index % VIA_REGION_COLOR_LIST.length ];
      color_index = color_index + 1;
    }
  }
}

// transform regions in image space to canvas space
function _via_load_canvas_regions() {
  _via_regions_group_color_init();

  // load all existing annotations into _via_canvas_regions
  var regions = _via_img_metadata[_via_image_id].regions;
  _via_canvas_regions  = [];
  for ( var i = 0; i < regions.length; ++i ) {
    var region_i = new file_region();
    for ( var key in regions[i].shape_attributes ) {
      region_i.shape_attributes[key] = regions[i].shape_attributes[key];
    }
    _via_canvas_regions.push(region_i);

    switch(_via_canvas_regions[i].shape_attributes['name']) {
    case VIA_REGION_SHAPE.RECT:
      var x      = regions[i].shape_attributes['x'] / _via_canvas_scale;
      var y      = regions[i].shape_attributes['y'] / _via_canvas_scale;
      var width  = regions[i].shape_attributes['width']  / _via_canvas_scale;
      var height = regions[i].shape_attributes['height'] / _via_canvas_scale;

      _via_canvas_regions[i].shape_attributes['x'] = Math.round(x);
      _via_canvas_regions[i].shape_attributes['y'] = Math.round(y);
      _via_canvas_regions[i].shape_attributes['width'] = Math.round(width);
      _via_canvas_regions[i].shape_attributes['height'] = Math.round(height);
      break;

    case VIA_REGION_SHAPE.CIRCLE:
      var cx = regions[i].shape_attributes['cx'] / _via_canvas_scale;
      var cy = regions[i].shape_attributes['cy'] / _via_canvas_scale;
      var r  = regions[i].shape_attributes['r']  / _via_canvas_scale;
      _via_canvas_regions[i].shape_attributes['cx'] = Math.round(cx);
      _via_canvas_regions[i].shape_attributes['cy'] = Math.round(cy);
      _via_canvas_regions[i].shape_attributes['r'] = Math.round(r);
      break;

    case VIA_REGION_SHAPE.ELLIPSE:
      var cx = regions[i].shape_attributes['cx'] / _via_canvas_scale;
      var cy = regions[i].shape_attributes['cy'] / _via_canvas_scale;
      var rx = regions[i].shape_attributes['rx'] / _via_canvas_scale;
      var ry = regions[i].shape_attributes['ry'] / _via_canvas_scale;
      // rotation in radians
      var theta = regions[i].shape_attributes['theta'];
      _via_canvas_regions[i].shape_attributes['cx'] = Math.round(cx);
      _via_canvas_regions[i].shape_attributes['cy'] = Math.round(cy);
      _via_canvas_regions[i].shape_attributes['rx'] = Math.round(rx);
      _via_canvas_regions[i].shape_attributes['ry'] = Math.round(ry);
      _via_canvas_regions[i].shape_attributes['theta'] = theta;
      break;

    case VIA_REGION_SHAPE.POLYLINE: // handled by polygon
    case VIA_REGION_SHAPE.POLYGON:
      var all_points_x = regions[i].shape_attributes['all_points_x'].slice(0);
      var all_points_y = regions[i].shape_attributes['all_points_y'].slice(0);
      for (var j=0; j<all_points_x.length; ++j) {
        all_points_x[j] = Math.round(all_points_x[j] / _via_canvas_scale);
        all_points_y[j] = Math.round(all_points_y[j] / _via_canvas_scale);
      }
      _via_canvas_regions[i].shape_attributes['all_points_x'] = all_points_x;
      _via_canvas_regions[i].shape_attributes['all_points_y'] = all_points_y;
      break;

    case VIA_REGION_SHAPE.POINT:
      var cx = regions[i].shape_attributes['cx'] / _via_canvas_scale;
      var cy = regions[i].shape_attributes['cy'] / _via_canvas_scale;

      _via_canvas_regions[i].shape_attributes['cx'] = Math.round(cx);
      _via_canvas_regions[i].shape_attributes['cy'] = Math.round(cy);
      break;
    }
  }
}

// updates currently selected region shape
function select_region_shape(sel_shape_name) {
  for ( var shape_name in VIA_REGION_SHAPE ) {
    var ui_element = document.getElementById('region_shape_' + VIA_REGION_SHAPE[shape_name]);
    ui_element.classList.remove('selected');
  }

  _via_current_shape = sel_shape_name;
  var ui_element = document.getElementById('region_shape_' + _via_current_shape);
  ui_element.classList.add('selected');

  switch(_via_current_shape) {
  case VIA_REGION_SHAPE.RECT: // Fall-through
  case VIA_REGION_SHAPE.CIRCLE: // Fall-through
  case VIA_REGION_SHAPE.ELLIPSE:
    show_message('Press single click and drag mouse to draw ' +
                 _via_current_shape + ' region');
    break;

  case VIA_REGION_SHAPE.POLYLINE:
  case VIA_REGION_SHAPE.POLYGON:
    _via_is_user_drawing_polygon = false;
    _via_current_polygon_region_id = -1;

    show_message('[Single Click] to define polygon/polyline vertices, ' +
                 '[Backspace] to delete last vertex, [Enter] to finish, [Esc] to cancel drawing.' );
    break;

  case VIA_REGION_SHAPE.POINT:
    show_message('Press single click to define points (or landmarks)');
    break;

  default:
    show_message('Unknown shape selected!');
    break;
  }
}

function set_all_canvas_size(w, h) {
  _via_reg_canvas.height = h;
  _via_reg_canvas.width = w;

  image_panel.style.height = h + 'px';
  image_panel.style.width  = w + 'px';
}

function set_all_canvas_scale(s) {
  _via_reg_ctx.scale(s, s);
}

function show_all_canvas() {
  image_panel.style.display = 'inline-block';
}

function hide_all_canvas() {
  image_panel.style.display = 'none';
}

function jump_to_image(image_index) {
  if ( _via_img_count <= 0 ) {
    return;
  }

  switch(_via_display_area_content_name) {
  case VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID:
    if ( image_index >= 0 && image_index < _via_img_count) {
      // @todo: jump to image grid page view with the given first image index
      show_single_image_view();
      _via_show_img(image_index);
    }
    break;
  default:
    if ( image_index >= 0 && image_index < _via_img_count) {
      _via_show_img(image_index);
    }
    break;
  }
}

function count_missing_region_attr(img_id) {
  var miss_region_attr_count = 0;
  var attr_count = Object.keys(_via_region_attributes).length;
  for( var i=0; i < _via_img_metadata[img_id].regions.length; ++i ) {
    var set_attr_count = Object.keys(_via_img_metadata[img_id].regions[i].region_attributes).length;
    miss_region_attr_count += ( attr_count - set_attr_count );
  }
  return miss_region_attr_count;
}

function count_missing_file_attr(img_id) {
  return Object.keys(_via_file_attributes).length - Object.keys(_via_img_metadata[img_id].file_attributes).length;
}

function toggle_all_regions_selection(is_selected) {
  var n = _via_img_metadata[_via_image_id].regions.length;
  var i;
  _via_region_selected_flag = [];
  for ( i = 0; i < n; ++i) {
    _via_region_selected_flag[i] = is_selected;
  }
  _via_is_all_region_selected = is_selected;
  annotation_editor_hide();
  if ( _via_annotation_editor_mode === VIA_ANNOTATION_EDITOR_MODE.ALL_REGIONS ) {
    annotation_editor_clear_row_highlight();
  }
}

function select_only_region(region_id) {
  toggle_all_regions_selection(false);
  set_region_select_state(region_id, true);
  _via_is_region_selected = true;
  _via_is_all_region_selected = false;
  _via_user_sel_region_id = region_id;
}

function set_region_select_state(region_id, is_selected) {
  _via_region_selected_flag[region_id] = is_selected;
}

function show_annotation_data() {
  pack_via_metadata('csv').then( function(data) {
    var hstr = '<pre>' + data.join('') + '</pre>';
    var window_features = 'toolbar=no,menubar=no,location=no,resizable=yes,scrollbars=yes,status=no';
    window_features += ',width=800,height=600';
    var annotation_data_window = window.open('', 'Annotations (preview) ', window_features);
    annotation_data_window.document.body.innerHTML = hstr;
  }.bind(this), function(err) {
    show_message('Failed to collect annotation data!');
  }.bind(this));
}

//
// Image click handlers
//

// enter annotation mode on double click
function _via_reg_canvas_dblclick_handler(e) {
  e.stopPropagation();
  // @todo: use double click in future
}

// user clicks on the canvas
function _via_reg_canvas_mousedown_handler(e) {
  e.stopPropagation();
  _via_click_x0 = e.offsetX; _via_click_y0 = e.offsetY;
  _via_region_edge = is_on_region_corner(_via_click_x0, _via_click_y0);
  var region_id = is_inside_region(_via_click_x0, _via_click_y0);

  if ( _via_is_region_selected ) {
    // check if user clicked on the region boundary
    if ( _via_region_edge[1] > 0 ) {
      if ( !_via_is_user_resizing_region ) {
        if ( _via_region_edge[0] !== _via_user_sel_region_id ) {
          _via_user_sel_region_id = _via_region_edge[0];
        }
        // resize region
        _via_is_user_resizing_region = true;
      }
    } else {
      var yes = is_inside_this_region(_via_click_x0,
                                      _via_click_y0,
                                      _via_user_sel_region_id);
      if (yes) {
        if( !_via_is_user_moving_region ) {
          _via_is_user_moving_region = true;
          _via_region_click_x = _via_click_x0;
          _via_region_click_y = _via_click_y0;
        }
      }
      if ( region_id === -1 ) {
        // mousedown on outside any region
        _via_is_user_drawing_region = true;
        // unselect all regions
        _via_is_region_selected = false;
        _via_user_sel_region_id = -1;
        toggle_all_regions_selection(false);
      }
    }
  } else {
    if ( region_id === -1 ) {
      // mousedown outside a region
      if (_via_current_shape !== VIA_REGION_SHAPE.POLYGON &&
          _via_current_shape !== VIA_REGION_SHAPE.POLYLINE &&
          _via_current_shape !== VIA_REGION_SHAPE.POINT) {
        // this is a bounding box drawing event
        _via_is_user_drawing_region = true;
      }
    } else {
      // mousedown inside a region
      // this could lead to (1) region selection or (2) region drawing
      _via_is_user_drawing_region = true;
    }
  }
}

// implements the following functionalities:
//  - new region drawing (including polygon)
//  - moving/resizing/select/unselect existing region
function _via_reg_canvas_mouseup_handler(e) {
  e.stopPropagation();
  _via_click_x1 = e.offsetX; _via_click_y1 = e.offsetY;

  var click_dx = Math.abs(_via_click_x1 - _via_click_x0);
  var click_dy = Math.abs(_via_click_y1 - _via_click_y0);

  // indicates that user has finished moving a region
  if ( _via_is_user_moving_region ) {
    _via_is_user_moving_region = false;
    _via_reg_canvas.style.cursor = "default";

    var move_x = Math.round(_via_click_x1 - _via_region_click_x);
    var move_y = Math.round(_via_click_y1 - _via_region_click_y);

    if (Math.abs(move_x) > VIA_MOUSE_CLICK_TOL ||
        Math.abs(move_y) > VIA_MOUSE_CLICK_TOL) {
      // move all selected regions
      _via_move_selected_regions(move_x, move_y);
    } else {
      // indicates a user click on an already selected region
      // this could indicate the user's intention to select another
      // nested region within this region
      // OR
      // draw a nested region (i.e. region inside a region)

      // traverse the canvas regions in alternating ascending
      // and descending order to solve the issue of nested regions
      var nested_region_id = is_inside_region(_via_click_x0, _via_click_y0, true);
      if (nested_region_id >= 0 &&
          nested_region_id !== _via_user_sel_region_id) {
        _via_user_sel_region_id = nested_region_id;
        _via_is_region_selected = true;
        _via_is_user_moving_region = false;

        // de-select all other regions if the user has not pressed Shift
        if ( !e.shiftKey ) {
          toggle_all_regions_selection(false);
        }
        set_region_select_state(nested_region_id, true);
        annotation_editor_show();
      } else {
        // user clicking inside an already selected region
        // indicates that the user intends to draw a nested region
        toggle_all_regions_selection(false);
        _via_is_region_selected = false;

        switch (_via_current_shape) {
        case VIA_REGION_SHAPE.POLYLINE: // handled by case for POLYGON
        case VIA_REGION_SHAPE.POLYGON:
          // user has clicked on the first point in a new polygon
          // see also event 'mouseup' for _via_is_user_drawing_polygon=true
          _via_is_user_drawing_polygon = true;

          var canvas_polygon_region = new file_region();
          canvas_polygon_region.shape_attributes['name'] = _via_current_shape;
          canvas_polygon_region.shape_attributes['all_points_x'] = [Math.round(_via_click_x0)];
          canvas_polygon_region.shape_attributes['all_points_y'] = [Math.round(_via_click_y0)];
          var new_length = _via_canvas_regions.push(canvas_polygon_region);
          _via_current_polygon_region_id = new_length - 1;
          break;

        case VIA_REGION_SHAPE.POINT:
          // user has marked a landmark point
          var point_region = new file_region();
          point_region.shape_attributes['name'] = VIA_REGION_SHAPE.POINT;
          point_region.shape_attributes['cx'] = Math.round(_via_click_x0 * _via_canvas_scale);
          point_region.shape_attributes['cy'] = Math.round(_via_click_y0 * _via_canvas_scale);
          _via_img_metadata[_via_image_id].regions.push(point_region);

          var canvas_point_region = new file_region();
          canvas_point_region.shape_attributes['name'] = VIA_REGION_SHAPE.POINT;
          canvas_point_region.shape_attributes['cx'] = Math.round(_via_click_x0);
          canvas_point_region.shape_attributes['cy'] = Math.round(_via_click_y0);
          _via_canvas_regions.push(canvas_point_region);
          break;
        }
        annotation_editor_update_content();
      }
    }
    _via_redraw_reg_canvas();
    _via_reg_canvas.focus();
    return;
  }

  // indicates that user has finished resizing a region
  if ( _via_is_user_resizing_region ) {
    // _via_click(x0,y0) to _via_click(x1,y1)
    _via_is_user_resizing_region = false;
    _via_reg_canvas.style.cursor = "default";

    // update the region
    var region_id = _via_region_edge[0];
    var image_attr = _via_img_metadata[_via_image_id].regions[region_id].shape_attributes;
    var canvas_attr = _via_canvas_regions[region_id].shape_attributes;

    switch (canvas_attr['name']) {
    case VIA_REGION_SHAPE.RECT:
      var d = [canvas_attr['x'], canvas_attr['y'], 0, 0];
      d[2] = d[0] + canvas_attr['width'];
      d[3] = d[1] + canvas_attr['height'];

      var mx = _via_current_x;
      var my = _via_current_y;
      var preserve_aspect_ratio = false;

      // constrain (mx,my) to lie on a line connecting a diagonal of rectangle
      if ( _via_is_ctrl_pressed ) {
        preserve_aspect_ratio = true;
      }

      rect_update_corner(_via_region_edge[1], d, mx, my, preserve_aspect_ratio);
      rect_standardize_coordinates(d);

      var w = Math.abs(d[2] - d[0]);
      var h = Math.abs(d[3] - d[1]);

      image_attr['x'] = Math.round(d[0] * _via_canvas_scale);
      image_attr['y'] = Math.round(d[1] * _via_canvas_scale);
      image_attr['width'] = Math.round(w * _via_canvas_scale);
      image_attr['height'] = Math.round(h * _via_canvas_scale);

      canvas_attr['x'] = Math.round( image_attr['x'] / _via_canvas_scale);
      canvas_attr['y'] = Math.round( image_attr['y'] / _via_canvas_scale);
      canvas_attr['width'] = Math.round( image_attr['width'] / _via_canvas_scale);
      canvas_attr['height'] = Math.round( image_attr['height'] / _via_canvas_scale);
      break;

    case VIA_REGION_SHAPE.CIRCLE:
      var dx = Math.abs(canvas_attr['cx'] - _via_current_x);
      var dy = Math.abs(canvas_attr['cy'] - _via_current_y);
      var new_r = Math.sqrt( dx*dx + dy*dy );

      image_attr['r'] = fixfloat(new_r * _via_canvas_scale);
      canvas_attr['r'] = Math.round( image_attr['r'] / _via_canvas_scale);
      break;

    case VIA_REGION_SHAPE.ELLIPSE:
      var new_rx = canvas_attr['rx'];
      var new_ry = canvas_attr['ry'];
      var new_theta = canvas_attr['theta'];
      var dx = Math.abs(canvas_attr['cx'] - _via_current_x);
      var dy = Math.abs(canvas_attr['cy'] - _via_current_y);

      switch(_via_region_edge[1]) {
      case 5:
        new_ry = Math.sqrt(dx*dx + dy*dy);
        new_theta = Math.atan2(- (_via_current_x - canvas_attr['cx']), (_via_current_y - canvas_attr['cy']));
        break;

      case 6:
        new_rx = Math.sqrt(dx*dx + dy*dy);
        new_theta = Math.atan2((_via_current_y - canvas_attr['cy']), (_via_current_x - canvas_attr['cx']));
        break;

      default:
        new_rx = dx;
        new_ry = dy;
        new_theta = 0;
        break;
      }

      image_attr['rx'] = fixfloat(new_rx * _via_canvas_scale);
      image_attr['ry'] = fixfloat(new_ry * _via_canvas_scale);
      image_attr['theta'] = fixfloat(new_theta);

      canvas_attr['rx'] = Math.round(image_attr['rx'] / _via_canvas_scale);
      canvas_attr['ry'] = Math.round(image_attr['ry'] / _via_canvas_scale);
      canvas_attr['theta'] = fixfloat(new_theta);
      break;

    case VIA_REGION_SHAPE.POLYLINE: // handled by polygon
    case VIA_REGION_SHAPE.POLYGON:
      var moved_vertex_id = _via_region_edge[1] - VIA_POLYGON_RESIZE_VERTEX_OFFSET;

      if ( e.ctrlKey ) {
        // if on vertex, delete it
        // if on edge, add a new vertex
        var r = _via_canvas_regions[_via_user_sel_region_id].shape_attributes;
        var shape = r.name;
        var is_on_vertex = is_on_polygon_vertex(r['all_points_x'], r['all_points_y'], _via_current_x, _via_current_y);

        if ( is_on_vertex === _via_region_edge[1] ) {
          // click on vertex, hence delete vertex
          if ( _via_polygon_del_vertex(region_id, moved_vertex_id) ) {
            show_message('Deleted vertex ' + moved_vertex_id + ' from region');
          }
        } else {
          var is_on_edge = is_on_polygon_edge(r['all_points_x'], r['all_points_y'], _via_current_x, _via_current_y);
          if ( is_on_edge === _via_region_edge[1] ) {
            // click on edge, hence add new vertex
            var vertex_index = is_on_edge - VIA_POLYGON_RESIZE_VERTEX_OFFSET;
            var canvas_x0 = Math.round(_via_click_x1);
            var canvas_y0 = Math.round(_via_click_y1);
            var img_x0 = Math.round( canvas_x0 * _via_canvas_scale );
            var img_y0 = Math.round( canvas_y0 * _via_canvas_scale );
            canvas_x0 = Math.round( img_x0 / _via_canvas_scale );
            canvas_y0 = Math.round( img_y0 / _via_canvas_scale );

            _via_canvas_regions[region_id].shape_attributes['all_points_x'].splice(vertex_index+1, 0, canvas_x0);
            _via_canvas_regions[region_id].shape_attributes['all_points_y'].splice(vertex_index+1, 0, canvas_y0);
            _via_img_metadata[_via_image_id].regions[region_id].shape_attributes['all_points_x'].splice(vertex_index+1, 0, img_x0);
            _via_img_metadata[_via_image_id].regions[region_id].shape_attributes['all_points_y'].splice(vertex_index+1, 0, img_y0);

            show_message('Added 1 new vertex to ' + shape + ' region');
          }
        }
      } else {
        // update coordinate of vertex
        var imx = Math.round(_via_current_x * _via_canvas_scale);
        var imy = Math.round(_via_current_y * _via_canvas_scale);
        image_attr['all_points_x'][moved_vertex_id] = imx;
        image_attr['all_points_y'][moved_vertex_id] = imy;
        canvas_attr['all_points_x'][moved_vertex_id] = Math.round( imx / _via_canvas_scale );
        canvas_attr['all_points_y'][moved_vertex_id] = Math.round( imy / _via_canvas_scale );
      }
      break;
    } // end of switch()
    _via_redraw_reg_canvas();
    _via_reg_canvas.focus();
    return;
  }

  // denotes a single click (= mouse down + mouse up)
  if ( click_dx < VIA_MOUSE_CLICK_TOL ||
       click_dy < VIA_MOUSE_CLICK_TOL ) {
    // if user is already drawing polygon, then each click adds a new point
    if ( _via_is_user_drawing_polygon ) {
      var canvas_x0 = Math.round(_via_click_x1);
      var canvas_y0 = Math.round(_via_click_y1);
      var n = _via_canvas_regions[_via_current_polygon_region_id].shape_attributes['all_points_x'].length;
      var last_x0 = _via_canvas_regions[_via_current_polygon_region_id].shape_attributes['all_points_x'][n-1];
      var last_y0 = _via_canvas_regions[_via_current_polygon_region_id].shape_attributes['all_points_y'][n-1];
      // discard if the click was on the last vertex
      if ( canvas_x0 !== last_x0 || canvas_y0 !== last_y0 ) {
        // user clicked on a new polygon point
        _via_canvas_regions[_via_current_polygon_region_id].shape_attributes['all_points_x'].push(canvas_x0);
        _via_canvas_regions[_via_current_polygon_region_id].shape_attributes['all_points_y'].push(canvas_y0);
      }
    } else {
      var region_id = is_inside_region(_via_click_x0, _via_click_y0);
      if ( region_id >= 0 ) {
        // first click selects region
        _via_user_sel_region_id     = region_id;
        _via_is_region_selected     = true;
        _via_is_user_moving_region  = false;
        _via_is_user_drawing_region = false;

        // de-select all other regions if the user has not pressed Shift
        if ( !e.shiftKey ) {
          annotation_editor_clear_row_highlight();
          toggle_all_regions_selection(false);
        }
        set_region_select_state(region_id, true);

        // show annotation editor only when a single region is selected
        if ( !e.shiftKey ) {
          annotation_editor_show();
        } else {
          annotation_editor_hide();
        }

        // show the region info
        if (_via_is_region_info_visible) {
          var canvas_attr = _via_canvas_regions[region_id].shape_attributes;

          switch (canvas_attr['name']) {
          case VIA_REGION_SHAPE.RECT:
            break;

          case VIA_REGION_SHAPE.CIRCLE:
            var rf = document.getElementById('region_info');
            var attr = _via_canvas_regions[_via_user_sel_region_id].shape_attributes;
            rf.innerHTML +=  ',' + ' Radius:' + attr['r'];
            break;

          case VIA_REGION_SHAPE.ELLIPSE:
            var rf = document.getElementById('region_info');
            var attr = _via_canvas_regions[_via_user_sel_region_id].shape_attributes;
            rf.innerHTML +=  ',' + ' X-radius:' + attr['rx'] + ',' + ' Y-radius:' + attr['ry'];
            break;

          case VIA_REGION_SHAPE.POLYLINE:
          case VIA_REGION_SHAPE.POLYGON:
            break;
          }
        }

        show_message('Region selected. If you intended to draw a region, click again inside the selected region to start drawing a region.')
      } else {
        if ( _via_is_user_drawing_region ) {
          // clear all region selection
          _via_is_user_drawing_region = false;
          _via_is_region_selected     = false;
          toggle_all_regions_selection(false);
          annotation_editor_hide();
        } else {
          switch (_via_current_shape) {
          case VIA_REGION_SHAPE.POLYLINE: // handled by case for POLYGON
          case VIA_REGION_SHAPE.POLYGON:
            // user has clicked on the first point in a new polygon
            // see also event 'mouseup' for _via_is_user_moving_region=true
            _via_is_user_drawing_polygon = true;

            var canvas_polygon_region = new file_region();
            canvas_polygon_region.shape_attributes['name'] = _via_current_shape;
            canvas_polygon_region.shape_attributes['all_points_x'] = [ Math.round(_via_click_x0) ];
            canvas_polygon_region.shape_attributes['all_points_y'] = [ Math.round(_via_click_y0)] ;

            var new_length = _via_canvas_regions.push(canvas_polygon_region);
            _via_current_polygon_region_id = new_length - 1;
            break;

          case VIA_REGION_SHAPE.POINT:
            // user has marked a landmark point
            var point_region = new file_region();
            point_region.shape_attributes['name'] = VIA_REGION_SHAPE.POINT;
            point_region.shape_attributes['cx'] = Math.round(_via_click_x0 * _via_canvas_scale);
            point_region.shape_attributes['cy'] = Math.round(_via_click_y0 * _via_canvas_scale);
            _via_img_metadata[_via_image_id].regions.push(point_region);

            var canvas_point_region = new file_region();
            canvas_point_region.shape_attributes['name'] = VIA_REGION_SHAPE.POINT;
            canvas_point_region.shape_attributes['cx'] = Math.round(_via_click_x0);
            canvas_point_region.shape_attributes['cy'] = Math.round(_via_click_y0);
            _via_canvas_regions.push(canvas_point_region);

            annotation_editor_update_content();
            break;
          }
        }
      }
    }
    _via_redraw_reg_canvas();
    _via_reg_canvas.focus();
    return;
  }

  // indicates that user has finished drawing a new region
  if ( _via_is_user_drawing_region ) {
    _via_is_user_drawing_region = false;
    var region_x0 = _via_click_x0;
    var region_y0 = _via_click_y0;
    var region_x1 = _via_click_x1;
    var region_y1 = _via_click_y1;

    var original_img_region = new file_region();
    var canvas_img_region = new file_region();
    var region_dx = Math.abs(region_x1 - region_x0);
    var region_dy = Math.abs(region_y1 - region_y0);
    var new_region_added = false;

    if ( region_dx > VIA_REGION_MIN_DIM && region_dy > VIA_REGION_MIN_DIM ) { // avoid regions with 0 dim
      switch(_via_current_shape) {
      case VIA_REGION_SHAPE.RECT:
        // ensure that (x0,y0) is top-left and (x1,y1) is bottom-right
        if ( _via_click_x0 < _via_click_x1 ) {
          region_x0 = _via_click_x0;
          region_x1 = _via_click_x1;
        } else {
          region_x0 = _via_click_x1;
          region_x1 = _via_click_x0;
        }

        if ( _via_click_y0 < _via_click_y1 ) {
          region_y0 = _via_click_y0;
          region_y1 = _via_click_y1;
        } else {
          region_y0 = _via_click_y1;
          region_y1 = _via_click_y0;
        }

        var x = Math.round(region_x0 * _via_canvas_scale);
        var y = Math.round(region_y0 * _via_canvas_scale);
        var width  = Math.round(region_dx * _via_canvas_scale);
        var height = Math.round(region_dy * _via_canvas_scale);
        original_img_region.shape_attributes['name'] = 'rect';
        original_img_region.shape_attributes['x'] = x;
        original_img_region.shape_attributes['y'] = y;
        original_img_region.shape_attributes['width'] = width;
        original_img_region.shape_attributes['height'] = height;

        canvas_img_region.shape_attributes['name'] = 'rect';
        canvas_img_region.shape_attributes['x'] = Math.round( x / _via_canvas_scale );
        canvas_img_region.shape_attributes['y'] = Math.round( y / _via_canvas_scale );
        canvas_img_region.shape_attributes['width'] = Math.round( width / _via_canvas_scale );
        canvas_img_region.shape_attributes['height'] = Math.round( height / _via_canvas_scale );

        new_region_added = true;
        break;

      case VIA_REGION_SHAPE.CIRCLE:
        var cx = Math.round(region_x0 * _via_canvas_scale);
        var cy = Math.round(region_y0 * _via_canvas_scale);
        var r  = Math.round( Math.sqrt(region_dx*region_dx + region_dy*region_dy) * _via_canvas_scale );

        original_img_region.shape_attributes['name'] = 'circle';
        original_img_region.shape_attributes['cx'] = cx;
        original_img_region.shape_attributes['cy'] = cy;
        original_img_region.shape_attributes['r'] = r;

        canvas_img_region.shape_attributes['name'] = 'circle';
        canvas_img_region.shape_attributes['cx'] = Math.round( cx / _via_canvas_scale );
        canvas_img_region.shape_attributes['cy'] = Math.round( cy / _via_canvas_scale );
        canvas_img_region.shape_attributes['r'] = Math.round( r / _via_canvas_scale );

        new_region_added = true;
        break;

      case VIA_REGION_SHAPE.ELLIPSE:
        var cx = Math.round(region_x0 * _via_canvas_scale);
        var cy = Math.round(region_y0 * _via_canvas_scale);
        var rx = Math.round(region_dx * _via_canvas_scale);
        var ry = Math.round(region_dy * _via_canvas_scale);
        var theta = 0;

        original_img_region.shape_attributes['name'] = 'ellipse';
        original_img_region.shape_attributes['cx'] = cx;
        original_img_region.shape_attributes['cy'] = cy;
        original_img_region.shape_attributes['rx'] = rx;
        original_img_region.shape_attributes['ry'] = ry;
        original_img_region.shape_attributes['theta'] = theta;

        canvas_img_region.shape_attributes['name'] = 'ellipse';
        canvas_img_region.shape_attributes['cx'] = Math.round( cx / _via_canvas_scale );
        canvas_img_region.shape_attributes['cy'] = Math.round( cy / _via_canvas_scale );
        canvas_img_region.shape_attributes['rx'] = Math.round( rx / _via_canvas_scale );
        canvas_img_region.shape_attributes['ry'] = Math.round( ry / _via_canvas_scale );
        canvas_img_region.shape_attributes['theta'] = theta;

        new_region_added = true;
        break;

      case VIA_REGION_SHAPE.POINT:    // handled by case VIA_REGION_SHAPE.POLYGON
      case VIA_REGION_SHAPE.POLYLINE: // handled by case VIA_REGION_SHAPE.POLYGON
      case VIA_REGION_SHAPE.POLYGON:
        // handled by _via_is_user_drawing_polygon
        break;
      } // end of switch

      if ( new_region_added ) {
        var n1 = _via_img_metadata[_via_image_id].regions.push(original_img_region);
        var n2 = _via_canvas_regions.push(canvas_img_region);

        if ( n1 !== n2 ) {
          console.log('_via_img_metadata.regions[' + n1 + '] and _via_canvas_regions[' + n2 + '] count mismatch');
        }
        var new_region_id = n1 - 1;

        set_region_annotations_to_default_value( new_region_id );
        select_only_region(new_region_id);
        if ( _via_annotation_editor_mode === VIA_ANNOTATION_EDITOR_MODE.ALL_REGIONS &&
             _via_metadata_being_updated === 'region' ) {
          annotation_editor_add_row( new_region_id );
          annotation_editor_scroll_to_row( new_region_id );
          annotation_editor_clear_row_highlight();
          annotation_editor_highlight_row( new_region_id );
        }
        annotation_editor_show();
      }
      _via_redraw_reg_canvas();
      _via_reg_canvas.focus();
    } else {
      show_message('Prevented accidental addition of a very small region.');
    }
    return;
  }
}

function _via_reg_canvas_mouseover_handler(e) {
  // change the mouse cursor icon
  _via_redraw_reg_canvas();
  _via_reg_canvas.focus();
}

function _via_reg_canvas_mousemove_handler(e) {
  if ( !_via_current_image_loaded ) {
    return;
  }

  _via_current_x = e.offsetX; _via_current_y = e.offsetY;

  // display the cursor coordinates
  var rf = document.getElementById('region_info');
  if ( rf != null && _via_is_region_info_visible ) {
    var img_x = Math.round( _via_current_x * _via_canvas_scale );
    var img_y = Math.round( _via_current_y * _via_canvas_scale );
    rf.innerHTML = 'X:' + img_x + ',' + ' Y:' + img_y;
  }

  if ( _via_is_region_selected ) {
    // display the region's info if a region is selected
    if ( rf != null && _via_is_region_info_visible && _via_user_sel_region_id !== -1) {
      var canvas_attr = _via_canvas_regions[_via_user_sel_region_id].shape_attributes;
      switch (canvas_attr['name']) {
      case VIA_REGION_SHAPE.RECT:
        break;

      case VIA_REGION_SHAPE.CIRCLE:
        var rf = document.getElementById('region_info');
        var attr = _via_canvas_regions[_via_user_sel_region_id].shape_attributes;
        rf.innerHTML +=  ',' + ' Radius:' + attr['r'];
        break;

      case VIA_REGION_SHAPE.ELLIPSE:
        var rf = document.getElementById('region_info');
        var attr = _via_canvas_regions[_via_user_sel_region_id].shape_attributes;
        rf.innerHTML +=  ',' + ' X-radius:' + attr['rx'] + ',' + ' Y-radius:' + attr['ry'];
        break;

      case VIA_REGION_SHAPE.POLYLINE:
      case VIA_REGION_SHAPE.POLYGON:
        break;
      }
    }

    if ( !_via_is_user_resizing_region ) {
      // check if user moved mouse cursor to region boundary
      // which indicates an intention to resize the region
      _via_region_edge = is_on_region_corner(_via_current_x, _via_current_y);

      if ( _via_region_edge[0] === _via_user_sel_region_id ) {
        switch(_via_region_edge[1]) {
          // rect
        case 1: // Fall-through // top-left corner of rect
        case 3: // bottom-right corner of rect
          _via_reg_canvas.style.cursor = "nwse-resize";
          break;
        case 2: // Fall-through // top-right corner of rect
        case 4: // bottom-left corner of rect
          _via_reg_canvas.style.cursor = "nesw-resize";
          break;

        case 5: // Fall-through // top-middle point of rect
        case 7: // bottom-middle point of rect
          _via_reg_canvas.style.cursor = "ns-resize";
          break;
        case 6: // Fall-through // top-middle point of rect
        case 8: // bottom-middle point of rect
          _via_reg_canvas.style.cursor = "ew-resize";
          break;

          // circle and ellipse
        case 5:
          _via_reg_canvas.style.cursor = "n-resize";
          break;
        case 6:
          _via_reg_canvas.style.cursor = "e-resize";
          break;

        default:
          _via_reg_canvas.style.cursor = "default";
          break;
        }

        if (_via_region_edge[1] >= VIA_POLYGON_RESIZE_VERTEX_OFFSET) {
          // indicates mouse over polygon vertex
          _via_reg_canvas.style.cursor = "crosshair";
          show_message('To move vertex, simply drag the vertex. To add vertex, press [Ctrl] key and click on the edge. To delete vertex, press [Ctrl] key and click on vertex.');
        }
      } else {
        var yes = is_inside_this_region(_via_current_x,
                                        _via_current_y,
                                        _via_user_sel_region_id);
        if (yes) {
          _via_reg_canvas.style.cursor = "move";
        } else {
          _via_reg_canvas.style.cursor = "default";
        }

      }
    } else {
      annotation_editor_hide() // resizing
    }
  }

  if(_via_is_user_drawing_region) {
    // draw region as the user drags the mouse cursor
    if (_via_canvas_regions.length) {
      _via_redraw_reg_canvas(); // clear old intermediate rectangle
    } else {
      // first region being drawn, just clear the full region canvas
      _via_reg_ctx.clearRect(0, 0, _via_reg_canvas.width, _via_reg_canvas.height);
    }

    var region_x0 = _via_click_x0;
    var region_y0 = _via_click_y0;

    var dx = Math.round(Math.abs(_via_current_x - _via_click_x0));
    var dy = Math.round(Math.abs(_via_current_y - _via_click_y0));
    _via_reg_ctx.strokeStyle = VIA_THEME_BOUNDARY_FILL_COLOR;

    switch (_via_current_shape ) {
    case VIA_REGION_SHAPE.RECT:
      if ( _via_click_x0 < _via_current_x ) {
        if ( _via_click_y0 < _via_current_y ) {
          region_x0 = _via_click_x0;
          region_y0 = _via_click_y0;
        } else {
          region_x0 = _via_click_x0;
          region_y0 = _via_current_y;
        }
      } else {
        if ( _via_click_y0 < _via_current_y ) {
          region_x0 = _via_current_x;
          region_y0 = _via_click_y0;
        } else {
          region_x0 = _via_current_x;
          region_y0 = _via_current_y;
        }
      }

      _via_draw_rect_region(region_x0, region_y0, dx, dy, false);

      // display the current region info
      if ( rf != null && _via_is_region_info_visible ) {
        rf.innerHTML +=  ',' + ' W:' + dx + ',' + ' H:' + dy;
      }
      break;

    case VIA_REGION_SHAPE.CIRCLE:
      var circle_radius = Math.round(Math.sqrt( dx*dx + dy*dy ));
      _via_draw_circle_region(region_x0, region_y0, circle_radius, false);

      // display the current region info
      if ( rf != null && _via_is_region_info_visible ) {
        rf.innerHTML +=  ',' + ' Radius:' + circle_radius;
      }
      break;

    case VIA_REGION_SHAPE.ELLIPSE:
      _via_draw_ellipse_region(region_x0, region_y0, dx, dy, 0, false);

      // display the current region info
      if ( rf != null && _via_is_region_info_visible ) {
        rf.innerHTML +=  ',' + ' X-radius:' + fixfloat(dx) + ',' + ' Y-radius:' + fixfloat(dy);
      }
      break;

    case VIA_REGION_SHAPE.POLYLINE: // handled by polygon
    case VIA_REGION_SHAPE.POLYGON:
      // this is handled by the if ( _via_is_user_drawing_polygon ) { ... }
      // see below
      break;
    }
    _via_reg_canvas.focus();
  }

  if ( _via_is_user_resizing_region ) {
    // user has clicked mouse on bounding box edge and is now moving it
    // draw region as the user drags the mouse coursor
    if (_via_canvas_regions.length) {
      _via_redraw_reg_canvas(); // clear old intermediate rectangle
    } else {
      // first region being drawn, just clear the full region canvas
      _via_reg_ctx.clearRect(0, 0, _via_reg_canvas.width, _via_reg_canvas.height);
    }

    var region_id = _via_region_edge[0];
    var attr = _via_canvas_regions[region_id].shape_attributes;
    switch (attr['name']) {
    case VIA_REGION_SHAPE.RECT:
      // original rectangle
      var d = [attr['x'], attr['y'], 0, 0];
      d[2] = d[0] + attr['width'];
      d[3] = d[1] + attr['height'];

      var mx = _via_current_x;
      var my = _via_current_y;
      var preserve_aspect_ratio = false;
      // constrain (mx,my) to lie on a line connecting a diagonal of rectangle
      if ( _via_is_ctrl_pressed ) {
        preserve_aspect_ratio = true;
      }

      rect_update_corner(_via_region_edge[1], d, mx, my, preserve_aspect_ratio);
      rect_standardize_coordinates(d);

      var w = Math.abs(d[2] - d[0]);
      var h = Math.abs(d[3] - d[1]);
      _via_draw_rect_region(d[0], d[1], w, h, true);

      if ( rf != null && _via_is_region_info_visible ) {
        rf.innerHTML +=  ',' + ' W:' + w + ',' + ' H:' + h;
      }
      break;

    case VIA_REGION_SHAPE.CIRCLE:
      var dx = Math.abs(attr['cx'] - _via_current_x);
      var dy = Math.abs(attr['cy'] - _via_current_y);
      var new_r = Math.sqrt( dx*dx + dy*dy );
      _via_draw_circle_region(attr['cx'],
                              attr['cy'],
                              new_r,
                              true);
      if ( rf != null && _via_is_region_info_visible ) {
        var curr_texts = rf.innerHTML.split(",");
        rf.innerHTML = "";
        rf.innerHTML +=  curr_texts[0] + ',' + curr_texts[1] + ',' + ' Radius:' + Math.round(new_r);
      }
      break;

    case VIA_REGION_SHAPE.ELLIPSE:
      var new_rx = attr['rx'];
      var new_ry = attr['ry'];
      var new_theta = attr['theta'];
      var dx = Math.abs(attr['cx'] - _via_current_x);
      var dy = Math.abs(attr['cy'] - _via_current_y);
      switch(_via_region_edge[1]) {
      case 5:
        new_ry = Math.sqrt(dx*dx + dy*dy);
        new_theta = Math.atan2(- (_via_current_x - attr['cx']), (_via_current_y - attr['cy']));
        break;

      case 6:
        new_rx = Math.sqrt(dx*dx + dy*dy);
        new_theta = Math.atan2((_via_current_y - attr['cy']), (_via_current_x - attr['cx']));
        break;

      default:
        new_rx = dx;
        new_ry = dy;
        new_theta = 0;
        break;
      }

      _via_draw_ellipse_region(attr['cx'],
                               attr['cy'],
                               new_rx,
                               new_ry,
                               new_theta,
                               true);
      if ( rf != null && _via_is_region_info_visible ) {
        var curr_texts = rf.innerHTML.split(",");
        rf.innerHTML = "";
        rf.innerHTML = curr_texts[0] + ',' + curr_texts[1] + ',' + ' X-radius:' + fixfloat(new_rx) + ',' + ' Y-radius:' + fixfloat(new_ry);
      }
      break;

    case VIA_REGION_SHAPE.POLYLINE: // handled by polygon
    case VIA_REGION_SHAPE.POLYGON:
      var moved_all_points_x = attr['all_points_x'].slice(0);
      var moved_all_points_y = attr['all_points_y'].slice(0);
      var moved_vertex_id = _via_region_edge[1] - VIA_POLYGON_RESIZE_VERTEX_OFFSET;

      moved_all_points_x[moved_vertex_id] = _via_current_x;
      moved_all_points_y[moved_vertex_id] = _via_current_y;

      _via_draw_polygon_region(moved_all_points_x,
                               moved_all_points_y,
                               true,
                               attr['name']);
      if ( rf != null && _via_is_region_info_visible ) {
        rf.innerHTML +=  ',' + ' Vertices:' + attr['all_points_x'].length;
      }
      break;
    }
    _via_reg_canvas.focus();
  }

  if ( _via_is_user_moving_region ) {
    // draw region as the user drags the mouse coursor
    if (_via_canvas_regions.length) {
      _via_redraw_reg_canvas(); // clear old intermediate rectangle
    } else {
      // first region being drawn, just clear the full region canvas
      _via_reg_ctx.clearRect(0, 0, _via_reg_canvas.width, _via_reg_canvas.height);
    }

    var move_x = (_via_current_x - _via_region_click_x);
    var move_y = (_via_current_y - _via_region_click_y);
    var attr = _via_canvas_regions[_via_user_sel_region_id].shape_attributes;

    switch (attr['name']) {
    case VIA_REGION_SHAPE.RECT:
      _via_draw_rect_region(attr['x'] + move_x,
                            attr['y'] + move_y,
                            attr['width'],
                            attr['height'],
                            true);
      // display the current region info
      if ( rf != null && _via_is_region_info_visible ) {
        rf.innerHTML +=  ',' + ' W:' + attr['width'] + ',' + ' H:' + attr['height'];
      }
      break;

    case VIA_REGION_SHAPE.CIRCLE:
      _via_draw_circle_region(attr['cx'] + move_x,
                              attr['cy'] + move_y,
                              attr['r'],
                              true);
      break;

    case VIA_REGION_SHAPE.ELLIPSE:
      if (typeof(attr['theta']) === 'undefined') { attr['theta'] = 0; }
      _via_draw_ellipse_region(attr['cx'] + move_x,
                               attr['cy'] + move_y,
                               attr['rx'],
                               attr['ry'],
                               attr['theta'],
                               true);
      break;

    case VIA_REGION_SHAPE.POLYLINE: // handled by polygon
    case VIA_REGION_SHAPE.POLYGON:
      var moved_all_points_x = attr['all_points_x'].slice(0);
      var moved_all_points_y = attr['all_points_y'].slice(0);
      for (var i=0; i<moved_all_points_x.length; ++i) {
        moved_all_points_x[i] += move_x;
        moved_all_points_y[i] += move_y;
      }
      _via_draw_polygon_region(moved_all_points_x,
                               moved_all_points_y,
                               true,
                               attr['name']);
      if ( rf != null && _via_is_region_info_visible ) {
        rf.innerHTML +=  ',' + ' Vertices:' + attr['all_points_x'].length;
      }
      break;

    case VIA_REGION_SHAPE.POINT:
      _via_draw_point_region(attr['cx'] + move_x,
                             attr['cy'] + move_y,
                             true);
      break;
    }
    _via_reg_canvas.focus();
    annotation_editor_hide() // moving
    return;
  }

  if ( _via_is_user_drawing_polygon ) {
    _via_redraw_reg_canvas();
    var attr = _via_canvas_regions[_via_current_polygon_region_id].shape_attributes;
    var all_points_x = attr['all_points_x'];
    var all_points_y = attr['all_points_y'];
    var npts = all_points_x.length;

    if ( npts > 0 ) {
      var line_x = [all_points_x.slice(npts-1), _via_current_x];
      var line_y = [all_points_y.slice(npts-1), _via_current_y];
      _via_draw_polygon_region(line_x, line_y, false, attr['name']);
    }

    if ( rf != null && _via_is_region_info_visible ) {
      rf.innerHTML +=  ',' + ' Vertices:' + npts;
    }
  }
}

function _via_move_selected_regions(move_x, move_y) {
  var i, n;
  n = _via_region_selected_flag.length;
  for ( i = 0; i < n; ++i ) {
    if ( _via_region_selected_flag[i] ) {
      _via_move_region(i, move_x, move_y);
    }
  }
}

function _via_validate_move_region(x, y, canvas_attr) {
  switch( canvas_attr['name'] ) {
    case VIA_REGION_SHAPE.RECT:
      // left and top boundary check
      if (x < 0 || y < 0) {
          show_message('Region moved beyond image boundary. Resetting.');
          return false;
      }
      // right and bottom boundary check
      if ((y + canvas_attr['height']) > _via_current_image_height ||
          (x + canvas_attr['width']) > _via_current_image_width) {
            show_message('Region moved beyond image boundary. Resetting.');
            return false;
      }

    // same validation for all
    case VIA_REGION_SHAPE.CIRCLE:
    case VIA_REGION_SHAPE.ELLIPSE:
    case VIA_REGION_SHAPE.POINT:
    case VIA_REGION_SHAPE.POLYLINE:
    case VIA_REGION_SHAPE.POLYGON:
      if (x < 0 || y < 0 ||
          x > _via_current_image_width || y > _via_current_image_height) {
          show_message('Region moved beyond image boundary. Resetting.');
          return false;
      }
  }
  return true;
}

function _via_move_region(region_id, move_x, move_y) {
  var image_attr = _via_img_metadata[_via_image_id].regions[region_id].shape_attributes;
  var canvas_attr = _via_canvas_regions[region_id].shape_attributes;

  switch( canvas_attr['name'] ) {
  case VIA_REGION_SHAPE.RECT:
    var xnew = image_attr['x'] + Math.round(move_x * _via_canvas_scale);
    var ynew = image_attr['y'] + Math.round(move_y * _via_canvas_scale);

    var is_valid = _via_validate_move_region(xnew, ynew, image_attr);
    if (! is_valid ) { break; }

    image_attr['x'] = xnew;
    image_attr['y'] = ynew;

    canvas_attr['x'] = Math.round( image_attr['x'] / _via_canvas_scale);
    canvas_attr['y'] = Math.round( image_attr['y'] / _via_canvas_scale);
    break;

  case VIA_REGION_SHAPE.CIRCLE: // Fall-through
  case VIA_REGION_SHAPE.ELLIPSE: // Fall-through
  case VIA_REGION_SHAPE.POINT:
    var cxnew = image_attr['cx'] + Math.round(move_x * _via_canvas_scale);
    var cynew = image_attr['cy'] + Math.round(move_y * _via_canvas_scale);

    var is_valid = _via_validate_move_region(cxnew, cynew, image_attr);
    if (! is_valid ) { break; }

    image_attr['cx'] = cxnew;
    image_attr['cy'] = cynew;

    canvas_attr['cx'] = Math.round( image_attr['cx'] / _via_canvas_scale);
    canvas_attr['cy'] = Math.round( image_attr['cy'] / _via_canvas_scale);
    break;

  case VIA_REGION_SHAPE.POLYLINE: // handled by polygon
  case VIA_REGION_SHAPE.POLYGON:
    var img_px = image_attr['all_points_x'];
    var img_py = image_attr['all_points_y'];
    var canvas_px = canvas_attr['all_points_x'];
    var canvas_py = canvas_attr['all_points_y'];
    // clone for reverting if valiation fails
    var img_px_old = Object.assign({}, img_px);
    var img_py_old = Object.assign({}, img_py);

    // validate move
    for (var i=0; i<img_px.length; ++i) {
      var pxnew = img_px[i] + Math.round(move_x * _via_canvas_scale);
      var pynew = img_py[i] + Math.round(move_y * _via_canvas_scale);
      if (! _via_validate_move_region(pxnew, pynew, image_attr) ) {
        img_px = img_px_old;
        img_py = img_py_old;
        break;
      }
    }
    // move points
    for (var i=0; i<img_px.length; ++i) {
      img_px[i] = img_px[i] + Math.round(move_x * _via_canvas_scale);
      img_py[i] = img_py[i] + Math.round(move_y * _via_canvas_scale);
    }

    for (var i=0; i<canvas_px.length; ++i) {
      canvas_px[i] = Math.round( img_px[i] / _via_canvas_scale );
      canvas_py[i] = Math.round( img_py[i] / _via_canvas_scale );
    }
    break;
  }
}

function _via_polygon_del_vertex(region_id, vertex_id) {
  var rs    = _via_canvas_regions[region_id].shape_attributes;
  var npts  = rs['all_points_x'].length;
  var shape = rs['name'];
  if ( shape !== VIA_REGION_SHAPE.POLYGON && shape !== VIA_REGION_SHAPE.POLYLINE ) {
    show_message('Vertices can only be deleted from polygon/polyline.');
    return false;
  }
  if ( npts <=3 && shape === VIA_REGION_SHAPE.POLYGON ) {
    show_message('Failed to delete vertex because a polygon must have at least 3 vertices.');
    return false;
  }
  if ( npts <=2 && shape === VIA_REGION_SHAPE.POLYLINE ) {
    show_message('Failed to delete vertex because a polyline must have at least 2 vertices.');
    return false;
  }
  // delete vertex from canvas
  _via_canvas_regions[region_id].shape_attributes['all_points_x'].splice(vertex_id, 1);
  _via_canvas_regions[region_id].shape_attributes['all_points_y'].splice(vertex_id, 1);

  // delete vertex from image metadata
  _via_img_metadata[_via_image_id].regions[region_id].shape_attributes['all_points_x'].splice(vertex_id, 1);
  _via_img_metadata[_via_image_id].regions[region_id].shape_attributes['all_points_y'].splice(vertex_id, 1);
  return true;
}

//
// Canvas update routines
//
function _via_redraw_reg_canvas() {
  if (_via_current_image_loaded) {
    _via_reg_ctx.clearRect(0, 0, _via_reg_canvas.width, _via_reg_canvas.height);
    if ( _via_canvas_regions.length > 0 ) {
      if (_via_is_region_boundary_visible) {
        draw_all_regions();
      }
      if (_via_is_region_id_visible) {
        draw_all_region_id();
      }
    }
  }
}

function _via_clear_reg_canvas() {
  _via_reg_ctx.clearRect(0, 0, _via_reg_canvas.width, _via_reg_canvas.height);
}

function draw_all_regions() {
  var aid = _via_settings.ui.image.region_color;
  var attr, is_selected, aid, avalue;
  for (var i=0; i < _via_canvas_regions.length; ++i) {
    attr = _via_canvas_regions[i].shape_attributes;
    is_selected = _via_region_selected_flag[i];

    // region stroke style may depend on attribute value
    _via_reg_ctx.strokeStyle = VIA_THEME_BOUNDARY_FILL_COLOR;
    if ( ! _via_is_user_drawing_polygon &&
         aid !== '__via_default_region_color__' ) {
      avalue = _via_img_metadata[_via_image_id].regions[i].region_attributes[aid];
      if ( _via_canvas_regions_group_color.hasOwnProperty(avalue) ) {
        _via_reg_ctx.strokeStyle = _via_canvas_regions_group_color[avalue];
      }
    }

    switch( attr['name'] ) {
    case VIA_REGION_SHAPE.RECT:
      _via_draw_rect_region(attr['x'],
                            attr['y'],
                            attr['width'],
                            attr['height'],
                            is_selected);
      break;

    case VIA_REGION_SHAPE.CIRCLE:
      _via_draw_circle_region(attr['cx'],
                              attr['cy'],
                              attr['r'],
                              is_selected);
      break;

    case VIA_REGION_SHAPE.ELLIPSE:
      if (typeof(attr['theta']) === 'undefined') { attr['theta'] = 0; }
      _via_draw_ellipse_region(attr['cx'],
                               attr['cy'],
                               attr['rx'],
                               attr['ry'],
                               attr['theta'],
                               is_selected);
      break;

    case VIA_REGION_SHAPE.POLYLINE: // handled by polygon
    case VIA_REGION_SHAPE.POLYGON:
      _via_draw_polygon_region(attr['all_points_x'],
                               attr['all_points_y'],
                               is_selected,
                               attr['name']);
      break;

    case VIA_REGION_SHAPE.POINT:
      _via_draw_point_region(attr['cx'],
                             attr['cy'],
                             is_selected);
      break;
    }
  }
}

// control point for resize of region boundaries
function _via_draw_control_point(cx, cy) {
  _via_reg_ctx.beginPath();
  _via_reg_ctx.arc(cx, cy, VIA_REGION_POINT_RADIUS, 0, 2*Math.PI, false);
  _via_reg_ctx.closePath();

  _via_reg_ctx.fillStyle = VIA_THEME_CONTROL_POINT_COLOR;
  _via_reg_ctx.globalAlpha = 1.0;
  _via_reg_ctx.fill();
}

function _via_draw_rect_region(x, y, w, h, is_selected) {
  if (is_selected) {
    _via_draw_rect(x, y, w, h);

    _via_reg_ctx.strokeStyle = VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR;
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_reg_ctx.stroke();

    _via_reg_ctx.fillStyle   = VIA_THEME_SEL_REGION_FILL_COLOR;
    _via_reg_ctx.globalAlpha = VIA_THEME_SEL_REGION_OPACITY;
    _via_reg_ctx.fill();
    _via_reg_ctx.globalAlpha = 1.0;

    _via_draw_control_point(x  ,   y);
    _via_draw_control_point(x+w, y+h);
    _via_draw_control_point(x  , y+h);
    _via_draw_control_point(x+w,   y);
    _via_draw_control_point(x+w/2,   y);
    _via_draw_control_point(x+w/2, y+h);
    _via_draw_control_point(x    , y+h/2);
    _via_draw_control_point(x+w  , y+h/2);
  } else {
    // draw a fill line
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_draw_rect(x, y, w, h);
    _via_reg_ctx.stroke();

    if ( w > VIA_THEME_REGION_BOUNDARY_WIDTH &&
         h > VIA_THEME_REGION_BOUNDARY_WIDTH ) {
      // draw a boundary line on both sides of the fill line
      _via_reg_ctx.strokeStyle = VIA_THEME_BOUNDARY_LINE_COLOR;
      _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/4;
      _via_draw_rect(x - VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                     y - VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                     w + VIA_THEME_REGION_BOUNDARY_WIDTH,
                     h + VIA_THEME_REGION_BOUNDARY_WIDTH);
      _via_reg_ctx.stroke();

      _via_draw_rect(x + VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                     y + VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                     w - VIA_THEME_REGION_BOUNDARY_WIDTH,
                     h - VIA_THEME_REGION_BOUNDARY_WIDTH);
      _via_reg_ctx.stroke();
    }
  }
}

function _via_draw_rect(x, y, w, h) {
  _via_reg_ctx.beginPath();
  _via_reg_ctx.moveTo(x  , y);
  _via_reg_ctx.lineTo(x+w, y);
  _via_reg_ctx.lineTo(x+w, y+h);
  _via_reg_ctx.lineTo(x  , y+h);
  _via_reg_ctx.closePath();
}

function _via_draw_circle_region(cx, cy, r, is_selected) {
  if (is_selected) {
    _via_draw_circle(cx, cy, r);

    _via_reg_ctx.strokeStyle = VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR;
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_reg_ctx.stroke();

    _via_reg_ctx.fillStyle   = VIA_THEME_SEL_REGION_FILL_COLOR;
    _via_reg_ctx.globalAlpha = VIA_THEME_SEL_REGION_OPACITY;
    _via_reg_ctx.fill();
    _via_reg_ctx.globalAlpha = 1.0;

    _via_draw_control_point(cx + r, cy);
  } else {
    // draw a fill line
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_draw_circle(cx, cy, r);
    _via_reg_ctx.stroke();

    if ( r > VIA_THEME_REGION_BOUNDARY_WIDTH ) {
      // draw a boundary line on both sides of the fill line
      _via_reg_ctx.strokeStyle = VIA_THEME_BOUNDARY_LINE_COLOR;
      _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/4;
      _via_draw_circle(cx, cy,
                       r - VIA_THEME_REGION_BOUNDARY_WIDTH/2);
      _via_reg_ctx.stroke();
      _via_draw_circle(cx, cy,
                       r + VIA_THEME_REGION_BOUNDARY_WIDTH/2);
      _via_reg_ctx.stroke();
    }
  }
}

function _via_draw_circle(cx, cy, r) {
  _via_reg_ctx.beginPath();
  _via_reg_ctx.arc(cx, cy, r, 0, 2*Math.PI, false);
  _via_reg_ctx.closePath();
}

function _via_draw_ellipse_region(cx, cy, rx, ry, rr, is_selected) {
  if (is_selected) {
    _via_draw_ellipse(cx, cy, rx, ry, rr);

    _via_reg_ctx.strokeStyle = VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR;
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_reg_ctx.stroke();

    _via_reg_ctx.fillStyle   = VIA_THEME_SEL_REGION_FILL_COLOR;
    _via_reg_ctx.globalAlpha = VIA_THEME_SEL_REGION_OPACITY;
    _via_reg_ctx.fill();
    _via_reg_ctx.globalAlpha = 1.0;

    _via_draw_control_point(cx + rx * Math.cos(rr), cy + rx * Math.sin(rr));
    _via_draw_control_point(cx - rx * Math.cos(rr), cy - rx * Math.sin(rr));
    _via_draw_control_point(cx + ry * Math.sin(rr), cy - ry * Math.cos(rr));
    _via_draw_control_point(cx - ry * Math.sin(rr), cy + ry * Math.cos(rr));

  } else {
    // draw a fill line
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_draw_ellipse(cx, cy, rx, ry, rr);
    _via_reg_ctx.stroke();

    if ( rx > VIA_THEME_REGION_BOUNDARY_WIDTH &&
         ry > VIA_THEME_REGION_BOUNDARY_WIDTH ) {
      // draw a boundary line on both sides of the fill line
      _via_reg_ctx.strokeStyle = VIA_THEME_BOUNDARY_LINE_COLOR;
      _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/4;
      _via_draw_ellipse(cx, cy,
                        rx + VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                        ry + VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                        rr);
      _via_reg_ctx.stroke();
      _via_draw_ellipse(cx, cy,
                        rx - VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                        ry - VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                        rr);
      _via_reg_ctx.stroke();
    }
  }
}

function _via_draw_ellipse(cx, cy, rx, ry, rr) {
  _via_reg_ctx.save();

  _via_reg_ctx.beginPath();
  _via_reg_ctx.ellipse(cx, cy, rx, ry, rr, 0, 2 * Math.PI);

  _via_reg_ctx.restore(); // restore to original state
  _via_reg_ctx.closePath();
}

function _via_draw_polygon_region(all_points_x, all_points_y, is_selected, shape) {
  if ( is_selected ) {
    _via_reg_ctx.strokeStyle = VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR;
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_reg_ctx.beginPath();
    _via_reg_ctx.moveTo(all_points_x[0], all_points_y[0]);
    for ( var i=1; i < all_points_x.length; ++i ) {
      _via_reg_ctx.lineTo(all_points_x[i], all_points_y[i]);
    }
    if ( shape === VIA_REGION_SHAPE.POLYGON ) {
      _via_reg_ctx.lineTo(all_points_x[0], all_points_y[0]); // close loop
    }
    _via_reg_ctx.stroke();

    _via_reg_ctx.fillStyle   = VIA_THEME_SEL_REGION_FILL_COLOR;
    _via_reg_ctx.globalAlpha = VIA_THEME_SEL_REGION_OPACITY;
    _via_reg_ctx.fill();
    _via_reg_ctx.globalAlpha = 1.0;
    for ( var i=0; i < all_points_x.length; ++i ) {
      _via_draw_control_point(all_points_x[i], all_points_y[i]);
    }
  } else {
    // draw a fill line
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_reg_ctx.beginPath();
    _via_reg_ctx.moveTo(all_points_x[0], all_points_y[0]);
    for ( var i=0; i < all_points_x.length; ++i ) {
      _via_reg_ctx.lineTo(all_points_x[i], all_points_y[i]);
    }
    if ( shape === VIA_REGION_SHAPE.POLYGON ) {
      _via_reg_ctx.lineTo(all_points_x[0], all_points_y[0]); // close loop
    }
    _via_reg_ctx.stroke();
  }
}

function _via_draw_point_region(cx, cy, is_selected) {
  if (is_selected) {
    _via_draw_point(cx, cy, VIA_REGION_POINT_RADIUS);

    _via_reg_ctx.strokeStyle = VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR;
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_reg_ctx.stroke();

    _via_reg_ctx.fillStyle   = VIA_THEME_SEL_REGION_FILL_COLOR;
    _via_reg_ctx.globalAlpha = VIA_THEME_SEL_REGION_OPACITY;
    _via_reg_ctx.fill();
    _via_reg_ctx.globalAlpha = 1.0;
  } else {
    // draw a fill line
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
    _via_draw_point(cx, cy, VIA_REGION_POINT_RADIUS);
    _via_reg_ctx.stroke();

    // draw a boundary line on both sides of the fill line
    _via_reg_ctx.strokeStyle = VIA_THEME_BOUNDARY_LINE_COLOR;
    _via_reg_ctx.lineWidth   = VIA_THEME_REGION_BOUNDARY_WIDTH/4;
    _via_draw_point(cx, cy,
                    VIA_REGION_POINT_RADIUS - VIA_THEME_REGION_BOUNDARY_WIDTH/2);
    _via_reg_ctx.stroke();
    _via_draw_point(cx, cy,
                    VIA_REGION_POINT_RADIUS + VIA_THEME_REGION_BOUNDARY_WIDTH/2);
    _via_reg_ctx.stroke();
  }
}

function _via_draw_point(cx, cy, r) {
  _via_reg_ctx.beginPath();
  _via_reg_ctx.arc(cx, cy, r, 0, 2*Math.PI, false);
  _via_reg_ctx.closePath();
}

function draw_all_region_id() {
  _via_reg_ctx.shadowColor = "transparent";
  _via_reg_ctx.font = _via_settings.ui.image.region_label_font;
  for ( var i = 0; i < _via_img_metadata[_via_image_id].regions.length; ++i ) {
    var canvas_reg = _via_canvas_regions[i];

    var bbox = get_region_bounding_box(canvas_reg);
    var x = bbox[0];
    var y = bbox[1];
    var w = Math.abs(bbox[2] - bbox[0]);

    var char_width  = _via_reg_ctx.measureText('M').width;
    var char_height = 1.8 * char_width;

    var annotation_str  = (i+1).toString();
    var rattr = _via_img_metadata[_via_image_id].regions[i].region_attributes[_via_settings.ui.image.region_label];
    var rshape = _via_img_metadata[_via_image_id].regions[i].shape_attributes['name'];
    if ( _via_settings.ui.image.region_label !== '__via_region_id__' ) {
      if ( typeof(rattr) !== 'undefined' ) {
        switch( typeof(rattr) ) {
        default:
        case 'string':
          annotation_str = rattr;
          break;
        case 'object':
          annotation_str = Object.keys(rattr).join(',');
          break;
        }
      } else {
        annotation_str = 'undefined';
      }
    }

    var bgnd_rect_width;
    var strw = _via_reg_ctx.measureText(annotation_str).width;
    if ( strw > w ) {
      if ( _via_settings.ui.image.region_label === '__via_region_id__' ) {
        // region-id is always visible in full
        bgnd_rect_width = strw + char_width;
      } else {

        // if text overflows, crop it
        var str_max     = Math.floor((w * annotation_str.length) / strw);
        if ( str_max > 1 ) {
          annotation_str  = annotation_str.substr(0, str_max-1) + '.';
          bgnd_rect_width = w;
        } else {
          annotation_str  = annotation_str.substr(0, 1) + '.';
          bgnd_rect_width = 2 * char_width;
        }
      }
    } else {
      bgnd_rect_width = strw + char_width;
    }

    if (canvas_reg.shape_attributes['name'] === VIA_REGION_SHAPE.POLYGON ||
        canvas_reg.shape_attributes['name'] === VIA_REGION_SHAPE.POLYLINE) {
      // put label near the first vertex
      x = canvas_reg.shape_attributes['all_points_x'][0];
      y = canvas_reg.shape_attributes['all_points_y'][0];
    } else {
      // center the label
      x = x - (bgnd_rect_width/2 - w/2);
    }

    // ensure that the text is within the image boundaries
    if ( y < char_height ) {
      y = char_height;
    }

    // first, draw a background rectangle first
    _via_reg_ctx.fillStyle = 'black';
    _via_reg_ctx.globalAlpha = 0.8;
    _via_reg_ctx.fillRect(Math.floor(x),
                          Math.floor(y - 1.1*char_height),
                          Math.floor(bgnd_rect_width),
                          Math.floor(char_height));

    // then, draw text over this background rectangle
    _via_reg_ctx.globalAlpha = 1.0;
    _via_reg_ctx.fillStyle = 'yellow';
    _via_reg_ctx.fillText(annotation_str,
                          Math.floor(x + 0.4*char_width),
                          Math.floor(y - 0.35*char_height));

  }
}

function get_region_bounding_box(region) {
  var d = region.shape_attributes;
  var bbox = new Array(4);

  switch( d['name'] ) {
  case 'rect':
    bbox[0] = d['x'];
    bbox[1] = d['y'];
    bbox[2] = d['x'] + d['width'];
    bbox[3] = d['y'] + d['height'];
    break;

  case 'circle':
    bbox[0] = d['cx'] - d['r'];
    bbox[1] = d['cy'] - d['r'];
    bbox[2] = d['cx'] + d['r'];
    bbox[3] = d['cy'] + d['r'];
    break;

  case 'ellipse':
    let radians = d['theta'];
    let radians90 = radians + Math.PI / 2;
    let ux = d['rx'] * Math.cos(radians);
    let uy = d['rx'] * Math.sin(radians);
    let vx = d['ry'] * Math.cos(radians90);
    let vy = d['ry'] * Math.sin(radians90);

    let width = Math.sqrt(ux * ux + vx * vx) * 2;
    let height = Math.sqrt(uy * uy + vy * vy) * 2;

    bbox[0] = d['cx'] - (width / 2);
    bbox[1] = d['cy'] - (height / 2);
    bbox[2] = d['cx'] + (width / 2);
    bbox[3] = d['cy'] + (height / 2);
    break;

  case 'polyline': // handled by polygon
  case 'polygon':
    var all_points_x = d['all_points_x'];
    var all_points_y = d['all_points_y'];

    var minx = Number.MAX_SAFE_INTEGER;
    var miny = Number.MAX_SAFE_INTEGER;
    var maxx = 0;
    var maxy = 0;
    for ( var i=0; i < all_points_x.length; ++i ) {
      if ( all_points_x[i] < minx ) {
        minx = all_points_x[i];
      }
      if ( all_points_x[i] > maxx ) {
        maxx = all_points_x[i];
      }
      if ( all_points_y[i] < miny ) {
        miny = all_points_y[i];
      }
      if ( all_points_y[i] > maxy ) {
        maxy = all_points_y[i];
      }
    }
    bbox[0] = minx;
    bbox[1] = miny;
    bbox[2] = maxx;
    bbox[3] = maxy;
    break;

  case 'point':
    bbox[0] = d['cx'] - VIA_REGION_POINT_RADIUS;
    bbox[1] = d['cy'] - VIA_REGION_POINT_RADIUS;
    bbox[2] = d['cx'] + VIA_REGION_POINT_RADIUS;
    bbox[3] = d['cy'] + VIA_REGION_POINT_RADIUS;
    break;
  }
  return bbox;
}

//
// Region collision routines
//
function is_inside_region(px, py, descending_order) {
  var N = _via_canvas_regions.length;
  if ( N === 0 ) {
    return -1;
  }
  var start, end, del;
  // traverse the canvas regions in alternating ascending
  // and descending order to solve the issue of nested regions
  if ( descending_order ) {
    start = N - 1;
    end   = -1;
    del   = -1;
  } else {
    start = 0;
    end   = N;
    del   = 1;
  }

  var i = start;
  while ( i !== end ) {
    var yes = is_inside_this_region(px, py, i);
    if (yes) {
      return i;
    }
    i = i + del;
  }
  return -1;
}

function is_inside_this_region(px, py, region_id) {
  var attr   = _via_canvas_regions[region_id].shape_attributes;
  var result = false;
  switch ( attr['name'] ) {
  case VIA_REGION_SHAPE.RECT:
    result = is_inside_rect(attr['x'],
                            attr['y'],
                            attr['width'],
                            attr['height'],
                            px, py);
    break;

  case VIA_REGION_SHAPE.CIRCLE:
    result = is_inside_circle(attr['cx'],
                              attr['cy'],
                              attr['r'],
                              px, py);
    break;

  case VIA_REGION_SHAPE.ELLIPSE:
    result = is_inside_ellipse(attr['cx'],
                               attr['cy'],
                               attr['rx'],
                               attr['ry'],
                               attr['theta'],
                               px, py);
    break;

  case VIA_REGION_SHAPE.POLYLINE: // handled by POLYGON
  case VIA_REGION_SHAPE.POLYGON:
    result = is_inside_polygon(attr['all_points_x'],
                               attr['all_points_y'],
                               px, py);
    break;

  case VIA_REGION_SHAPE.POINT:
    result = is_inside_point(attr['cx'],
                             attr['cy'],
                             px, py);
    break;
  }
  return result;
}

function is_inside_circle(cx, cy, r, px, py) {
  var dx = px - cx;
  var dy = py - cy;
  return (dx * dx + dy * dy) < r * r;
}

function is_inside_rect(x, y, w, h, px, py) {
  return px > x &&
    px < (x + w) &&
    py > y &&
    py < (y + h);
}

function is_inside_ellipse(cx, cy, rx, ry, rr, px, py) {
  // Inverse rotation of pixel coordinates
  var dx = Math.cos(-rr) * (cx - px) - Math.sin(-rr) * (cy - py)
  var dy = Math.sin(-rr) * (cx - px) + Math.cos(-rr) * (cy - py)

  return ((dx * dx) / (rx * rx)) + ((dy * dy) / (ry * ry)) < 1;
}

// returns 0 when (px,py) is outside the polygon
// source: http://geomalgorithms.com/a03-_inclusion.html
function is_inside_polygon(all_points_x, all_points_y, px, py) {
  if ( all_points_x.length === 0 || all_points_y.length === 0 ) {
    return 0;
  }

  var wn = 0;    // the  winding number counter
  var n = all_points_x.length;
  var i;
  // loop through all edges of the polygon
  for ( i = 0; i < n-1; ++i ) {   // edge from V[i] to  V[i+1]
    var is_left_value = is_left( all_points_x[i], all_points_y[i],
                                 all_points_x[i+1], all_points_y[i+1],
                                 px, py);

    if (all_points_y[i] <= py) {
      if (all_points_y[i+1]  > py && is_left_value > 0) {
        ++wn;
      }
    }
    else {
      if (all_points_y[i+1]  <= py && is_left_value < 0) {
        --wn;
      }
    }
  }

  // also take into account the loop closing edge that connects last point with first point
  var is_left_value = is_left( all_points_x[n-1], all_points_y[n-1],
                               all_points_x[0], all_points_y[0],
                               px, py);

  if (all_points_y[n-1] <= py) {
    if (all_points_y[0]  > py && is_left_value > 0) {
      ++wn;
    }
  }
  else {
    if (all_points_y[0]  <= py && is_left_value < 0) {
      --wn;
    }
  }

  if ( wn === 0 ) {
    return 0;
  }
  else {
    return 1;
  }
}

function is_inside_point(cx, cy, px, py) {
  var dx = px - cx;
  var dy = py - cy;
  var r2 = VIA_POLYGON_VERTEX_MATCH_TOL * VIA_POLYGON_VERTEX_MATCH_TOL;
  return (dx * dx + dy * dy) < r2;
}

// returns
// >0 if (x2,y2) lies on the left side of line joining (x0,y0) and (x1,y1)
// =0 if (x2,y2) lies on the line joining (x0,y0) and (x1,y1)
// >0 if (x2,y2) lies on the right side of line joining (x0,y0) and (x1,y1)
// source: http://geomalgorithms.com/a03-_inclusion.html
function is_left(x0, y0, x1, y1, x2, y2) {
  return ( ((x1 - x0) * (y2 - y0))  - ((x2 -  x0) * (y1 - y0)) );
}

function is_on_region_corner(px, py) {
  var _via_region_edge = [-1, -1]; // region_id, corner_id [top-left=1,top-right=2,bottom-right=3,bottom-left=4]

  for ( var i = 0; i < _via_canvas_regions.length; ++i ) {
    var attr = _via_canvas_regions[i].shape_attributes;
    var result = false;
    _via_region_edge[0] = i;

    switch ( attr['name'] ) {
    case VIA_REGION_SHAPE.RECT:
      result = is_on_rect_edge(attr['x'],
                               attr['y'],
                               attr['width'],
                               attr['height'],
                               px, py);
      break;

    case VIA_REGION_SHAPE.CIRCLE:
      result = is_on_circle_edge(attr['cx'],
                                 attr['cy'],
                                 attr['r'],
                                 px, py);
      break;

    case VIA_REGION_SHAPE.ELLIPSE:
      result = is_on_ellipse_edge(attr['cx'],
                                  attr['cy'],
                                  attr['rx'],
                                  attr['ry'],
                                  attr['theta'],
                                  px, py);
      break;

    case VIA_REGION_SHAPE.POLYLINE: // handled by polygon
    case VIA_REGION_SHAPE.POLYGON:
      result = is_on_polygon_vertex(attr['all_points_x'],
                                    attr['all_points_y'],
                                    px, py);
      if ( result === 0 ) {
        result = is_on_polygon_edge(attr['all_points_x'],
                                    attr['all_points_y'],
                                    px, py);
      }
      break;

    case VIA_REGION_SHAPE.POINT:
      // since there are no edges of a point
      result = 0;
      break;
    }

    if (result > 0) {
      _via_region_edge[1] = result;
      return _via_region_edge;
    }
  }
  _via_region_edge[0] = -1;
  return _via_region_edge;
}

function is_on_rect_edge(x, y, w, h, px, py) {
  var dx0 = Math.abs(x - px);
  var dy0 = Math.abs(y - py);
  var dx1 = Math.abs(x + w - px);
  var dy1 = Math.abs(y + h - py);
  //[top-left=1,top-right=2,bottom-right=3,bottom-left=4]
  if ( dx0 < VIA_REGION_EDGE_TOL &&
       dy0 < VIA_REGION_EDGE_TOL ) {
    return 1;
  }
  if ( dx1 < VIA_REGION_EDGE_TOL &&
       dy0 < VIA_REGION_EDGE_TOL ) {
    return 2;
  }
  if ( dx1 < VIA_REGION_EDGE_TOL &&
       dy1 < VIA_REGION_EDGE_TOL ) {
    return 3;
  }

  if ( dx0 < VIA_REGION_EDGE_TOL &&
       dy1 < VIA_REGION_EDGE_TOL ) {
    return 4;
  }

  var mx0 = Math.abs(x + w/2 - px);
  var my0 = Math.abs(y + h/2 - py);
  //[top-middle=5,right-middle=6,bottom-middle=7,left-middle=8]
  if ( mx0 < VIA_REGION_EDGE_TOL &&
       dy0 < VIA_REGION_EDGE_TOL ) {
    return 5;
  }
  if ( dx1 < VIA_REGION_EDGE_TOL &&
       my0 < VIA_REGION_EDGE_TOL ) {
    return 6;
  }
  if ( mx0 < VIA_REGION_EDGE_TOL &&
       dy1 < VIA_REGION_EDGE_TOL ) {
    return 7;
  }
  if ( dx0 < VIA_REGION_EDGE_TOL &&
       my0 < VIA_REGION_EDGE_TOL ) {
    return 8;
  }

  return 0;
}

function is_on_circle_edge(cx, cy, r, px, py) {
  var dx = cx - px;
  var dy = cy - py;
  if ( Math.abs(Math.sqrt( dx*dx + dy*dy ) - r) < VIA_REGION_EDGE_TOL ) {
    var theta = Math.atan2( py - cy, px - cx );
    if ( Math.abs(theta - (Math.PI/2)) < VIA_THETA_TOL ||
         Math.abs(theta + (Math.PI/2)) < VIA_THETA_TOL) {
      return 5;
    }
    if ( Math.abs(theta) < VIA_THETA_TOL ||
         Math.abs(Math.abs(theta) - Math.PI) < VIA_THETA_TOL) {
      return 6;
    }

    if ( theta > 0 && theta < (Math.PI/2) ) {
      return 1;
    }
    if ( theta > (Math.PI/2) && theta < (Math.PI) ) {
      return 4;
    }
    if ( theta < 0 && theta > -(Math.PI/2) ) {
      return 2;
    }
    if ( theta < -(Math.PI/2) && theta > -Math.PI ) {
      return 3;
    }
  } else {
    return 0;
  }
}

function is_on_ellipse_edge(cx, cy, rx, ry, rr, px, py) {
  // Inverse rotation of pixel coordinates
  px = px - cx;
  py = py - cy;
  var px_ = Math.cos(-rr) * px - Math.sin(-rr) * py;
  var py_ = Math.sin(-rr) * px + Math.cos(-rr) * py;
  px = px_ + cx;
  py = py_ + cy;

  var dx = (cx - px)/rx;
  var dy = (cy - py)/ry;

  if ( Math.abs(Math.sqrt( dx*dx + dy*dy ) - 1) < VIA_ELLIPSE_EDGE_TOL ) {
    var theta = Math.atan2( py - cy, px - cx );
    if ( Math.abs(theta - (Math.PI/2)) < VIA_THETA_TOL ||
         Math.abs(theta + (Math.PI/2)) < VIA_THETA_TOL) {
      return 5;
    }
    if ( Math.abs(theta) < VIA_THETA_TOL ||
         Math.abs(Math.abs(theta) - Math.PI) < VIA_THETA_TOL) {
      return 6;
    }
  } else {
    return 0;
  }
}

function is_on_polygon_vertex(all_points_x, all_points_y, px, py) {
  var i, n;
  n = all_points_x.length;

  for ( i = 0; i < n; ++i ) {
    if ( Math.abs(all_points_x[i] - px) < VIA_POLYGON_VERTEX_MATCH_TOL &&
         Math.abs(all_points_y[i] - py) < VIA_POLYGON_VERTEX_MATCH_TOL ) {
      return (VIA_POLYGON_RESIZE_VERTEX_OFFSET+i);
    }
  }
  return 0;
}

function is_on_polygon_edge(all_points_x, all_points_y, px, py) {
  var i, n, di, d;
  n = all_points_x.length;
  d = [];
  for ( i = 0; i < n - 1; ++i )  {
    di = dist_to_line(px, py, all_points_x[i], all_points_y[i], all_points_x[i+1], all_points_y[i+1]);
    d.push(di);
  }
  // closing edge
  di = dist_to_line(px, py, all_points_x[n-1], all_points_y[n-1], all_points_x[0], all_points_y[0]);
  d.push(di);

  var smallest_value = d[0];
  var smallest_index = 0;
  n = d.length;
  for ( i = 1; i < n; ++i ) {
    if ( d[i] < smallest_value ) {
      smallest_value = d[i];
      smallest_index = i;
    }
  }
  if ( smallest_value < VIA_POLYGON_VERTEX_MATCH_TOL ) {
    return (VIA_POLYGON_RESIZE_VERTEX_OFFSET + smallest_index);
  } else {
    return 0;
  }
}

function is_point_inside_bounding_box(x, y, x1, y1, x2, y2) {
  // ensure that (x1,y1) is top left and (x2,y2) is bottom right corner of rectangle
  var rect = {};
  if( x1 < x2 ) {
    rect.x1 = x1;
    rect.x2 = x2;
  } else {
    rect.x1 = x2;
    rect.x2 = x1;
  }
  if ( y1 < y2 ) {
    rect.y1 = y1;
    rect.y2 = y2;
  } else {
    rect.y1 = y2;
    rect.y2 = y1;
  }

  if ( x >= rect.x1 && x <= rect.x2 && y >= rect.y1 && y <= rect.y2 ) {
    return true;
  } else {
    return false;
  }
}

function dist_to_line(x, y, x1, y1, x2, y2) {
  if ( is_point_inside_bounding_box(x, y, x1, y1, x2, y2) ) {
    var dy = y2 - y1;
    var dx = x2 - x1;
    var nr = Math.abs( dy*x - dx*y + x2*y1 - y2*x1 );
    var dr = Math.sqrt( dx*dx + dy*dy );
    var dist = nr / dr;
    return Math.round(dist);
  } else {
    return Number.MAX_SAFE_INTEGER;
  }
}

function rect_standardize_coordinates(d) {
  // d[x0,y0,x1,y1]
  // ensures that (d[0],d[1]) is top-left corner while
  // (d[2],d[3]) is bottom-right corner
  if ( d[0] > d[2] ) {
    // swap
    var t = d[0];
    d[0] = d[2];
    d[2] = t;
  }

  if ( d[1] > d[3] ) {
    // swap
    var t = d[1];
    d[1] = d[3];
    d[3] = t;
  }
}

function rect_update_corner(corner_id, d, x, y, preserve_aspect_ratio) {
  // pre-condition : d[x0,y0,x1,y1] is standardized
  // post-condition : corner is moved ( d may not stay standardized )
  if (preserve_aspect_ratio) {
    switch(corner_id) {
    case 1: // Fall-through // top-left
    case 3: // bottom-right
      var dx = d[2] - d[0];
      var dy = d[3] - d[1];
      var norm = Math.sqrt( dx*dx + dy*dy );
      var nx = dx / norm; // x component of unit vector along the diagonal of rect
      var ny = dy / norm; // y component
      var proj = (x - d[0]) * nx + (y - d[1]) * ny;
      var proj_x = nx * proj;
      var proj_y = ny * proj;
      // constrain (mx,my) to lie on a line connecting (x0,y0) and (x1,y1)
      x = Math.round( d[0] + proj_x );
      y = Math.round( d[1] + proj_y );
      break;

    case 2: // Fall-through // top-right
    case 4: // bottom-left
      var dx = d[2] - d[0];
      var dy = d[1] - d[3];
      var norm = Math.sqrt( dx*dx + dy*dy );
      var nx = dx / norm; // x component of unit vector along the diagonal of rect
      var ny = dy / norm; // y component
      var proj = (x - d[0]) * nx + (y - d[3]) * ny;
      var proj_x = nx * proj;
      var proj_y = ny * proj;
      // constrain (mx,my) to lie on a line connecting (x0,y0) and (x1,y1)
      x = Math.round( d[0] + proj_x );
      y = Math.round( d[3] + proj_y );
      break;
    }
  }

  switch(corner_id) {
  case 1: // top-left
    d[0] = x;
    d[1] = y;
    break;

  case 3: // bottom-right
    d[2] = x;
    d[3] = y;
    break;

  case 2: // top-right
    d[2] = x;
    d[1] = y;
    break;

  case 4: // bottom-left
    d[0] = x;
    d[3] = y;
    break;

  case 5: // top-middle
    d[1] = y;
    break;

  case 6: // right-middle
    d[2] = x;
    break;

  case 7: // bottom-middle
    d[3] = y;
    break;

  case 8: // left-middle
    d[0] = x;
    break;
  }
}

function _via_update_ui_components() {
  if ( ! _via_current_image_loaded ) {
    return;
  }

  show_message('Updating user interface components.');
  switch(_via_display_area_content_name) {
  case VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID:
    image_grid_set_content_panel_height_fixed();
    image_grid_set_content_to_current_group();
    break;
  case VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE:
    if ( !_via_is_window_resized && _via_current_image_loaded ) {
      _via_is_window_resized = true;
      _via_show_img(_via_image_index);

      if (_via_is_canvas_zoomed) {
        reset_zoom_level();
      }
    }
    break;
  }
}

//
// Shortcut key handlers
//
function _via_window_keydown_handler(e) {
  if ( e.target === document.body ) {
    // process the keyboard event
    _via_handle_global_keydown_event(e);
  }
}

// global keys are active irrespective of element focus
// arrow keys, n, p, s, o, space, d, Home, End, PageUp, PageDown
function _via_handle_global_keydown_event(e) {
  // zoom
  if (_via_current_image_loaded) {
    if ( e.key === "+") {
      zoom_in();
      return;
    }

    if ( e.key === "=") {
      reset_zoom_level();
      return;
    }

    if ( e.key === "-") {
      zoom_out();
      return;
    }
  }

  if ( e.key === 'ArrowRight' || e.key === 'n') {
    move_to_next_image();
    e.preventDefault();
    return;
  }
  if ( e.key === 'ArrowLeft' || e.key === 'p') {
    move_to_prev_image();
    e.preventDefault();
    return;
  }

  if ( e.key === 'ArrowUp' ) {
    region_visualisation_update('region_label', '__via_region_id__', 1);
    e.preventDefault();
    return;
  }

  if ( e.key === 'ArrowDown' ) {
    region_visualisation_update('region_color', '__via_default_region_color__', -1);
    e.preventDefault();
    return;
  }


  if ( e.key === 'Home') {
    show_first_image();
    e.preventDefault();
    return;
  }
  if ( e.key === 'End') {
    show_last_image();
    e.preventDefault();
    return;
  }
  if ( e.key === 'PageDown') {
    jump_to_next_image_block();
    e.preventDefault();
    return;
  }
  if ( e.key === 'PageUp') {
    jump_to_prev_image_block();
    e.preventDefault();
    return;
  }

  if ( e.key === 'a' ) {
    if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
      // select all in image grid
      image_grid_group_toggle_select_all();
    }
  }

  if ( e.key === 'Escape' ) {
    e.preventDefault();
    if ( _via_is_loading_current_image ) {
      _via_cancel_current_image_loading();
    }

    if ( _via_is_user_resizing_region ) {
      // cancel region resizing action
      _via_is_user_resizing_region = false;
    }

    if ( _via_is_region_selected ) {
      // clear all region selections
      _via_is_region_selected = false;
      _via_user_sel_region_id = -1;
      toggle_all_regions_selection(false);
    }

    if ( _via_is_user_drawing_polygon ) {
      _via_is_user_drawing_polygon = false;
      _via_canvas_regions.splice(_via_current_polygon_region_id, 1);
    }

    if ( _via_is_user_drawing_region ) {
      _via_is_user_drawing_region = false;
    }

    if ( _via_is_user_resizing_region ) {
      _via_is_user_resizing_region = false
    }

    if ( _via_is_user_moving_region ) {
      _via_is_user_moving_region = false
    }

    _via_redraw_reg_canvas();
    return;
  }

  if ( e.key === ' ' ) { // Space key
    if ( e.ctrlKey ) {
      annotation_editor_toggle_on_image_editor();
    } else {
      annotation_editor_toggle_all_regions_editor();
    }
    e.preventDefault();
    return;
  }

  if ( e.key === 'F1' ) { // F1 for help
    set_display_area_content(VIA_DISPLAY_AREA_CONTENT_NAME.PAGE_GETTING_STARTED);
    e.preventDefault();
    return;
  }
  if ( e.key === 'F2' ) { // F2 for about
    set_display_area_content(VIA_DISPLAY_AREA_CONTENT_NAME.PAGE_ABOUT);
    e.preventDefault();
    return;
  }
}

function _via_reg_canvas_keyup_handler(e) {
  if ( e.ctrlKey ) {
    _via_is_ctrl_pressed = false;
  }
}

function _via_reg_canvas_keydown_handler(e) {
  if ( e.ctrlKey ) {
    _via_is_ctrl_pressed = true;
  }

  if (_via_current_image_loaded) {
    if ( e.key === 'Enter' ) {
        if ( _via_current_shape === VIA_REGION_SHAPE.POLYLINE ||
             _via_current_shape === VIA_REGION_SHAPE.POLYGON) {
          _via_polyshape_finish_drawing();
        }
    }
    if ( e.key === 'Backspace' ) {
        if ( _via_current_shape === VIA_REGION_SHAPE.POLYLINE ||
             _via_current_shape === VIA_REGION_SHAPE.POLYGON) {
          _via_polyshape_delete_last_vertex();
        }
    }

    if ( e.key === 'a' ) {
      sel_all_regions();
      e.preventDefault();
      return;
    }

    if ( e.key === 'c' ) {
      if (_via_is_region_selected ||
          _via_is_all_region_selected) {
        copy_sel_regions();
      }
      e.preventDefault();
      return;
    }

    if ( e.key === 'v' ) {
      paste_sel_regions_in_current_image();
      e.preventDefault();
      return;
    }

    if ( e.key === 'b' ) {
      toggle_region_boundary_visibility();
      e.preventDefault();
      return;
    }

    if ( e.key === 'l' ) {
      toggle_region_id_visibility();
      e.preventDefault();
      return;
    }

    if ( e.key === 'd' ) {
      if ( _via_is_region_selected ||
           _via_is_all_region_selected ) {
        del_sel_regions();
      }
      e.preventDefault();
      return;
    }

    if ( _via_is_region_selected ) {
      if ( e.key === 'ArrowRight' ||
           e.key === 'ArrowLeft'  ||
           e.key === 'ArrowDown'  ||
           e.key === 'ArrowUp' ) {
        var del = 1;
        if ( e.shiftKey ) {
          del = 10;
        }
        var move_x = 0;
        var move_y = 0;
        switch( e.key ) {
        case 'ArrowLeft':
          move_x = -del;
          break;
        case 'ArrowUp':
          move_y = -del;
          break;
        case 'ArrowRight':
          move_x =  del;
          break;
        case 'ArrowDown':
          move_y =  del;
          break;
        }
        _via_move_selected_regions(move_x, move_y);
        _via_redraw_reg_canvas();
        e.preventDefault();
        return;
      }
    }
  }
  _via_handle_global_keydown_event(e);
}

function _via_polyshape_finish_drawing() {
  if ( _via_is_user_drawing_polygon ) {
    // double click is used to indicate completion of
    // polygon or polyline drawing action
    var new_region_id = _via_current_polygon_region_id;
    var new_region_shape = _via_current_shape;

    var npts =  _via_canvas_regions[new_region_id].shape_attributes['all_points_x'].length;
    if ( npts <=2 && new_region_shape === VIA_REGION_SHAPE.POLYGON ) {
      show_message('For a polygon, you must define at least 3 points. ' +
                   'Press [Esc] to cancel drawing operation.!');
      return;
    }
    if ( npts <=1 && new_region_shape === VIA_REGION_SHAPE.POLYLINE ) {
      show_message('A polyline must have at least 2 points. ' +
                   'Press [Esc] to cancel drawing operation.!');
      return;
    }

    var img_id = _via_image_id;
    _via_current_polygon_region_id = -1;
    _via_is_user_drawing_polygon = false;
    _via_is_user_drawing_region = false;

    _via_img_metadata[img_id].regions[new_region_id] = {}; // create placeholder
    _via_polyshape_add_new_polyshape(img_id, new_region_shape, new_region_id);
    select_only_region(new_region_id); // select new region
    set_region_annotations_to_default_value( new_region_id );
    annotation_editor_add_row( new_region_id );
    annotation_editor_scroll_to_row( new_region_id );

    _via_redraw_reg_canvas();
    _via_reg_canvas.focus();
  }
  return;
}

function _via_polyshape_delete_last_vertex() {
  if ( _via_is_user_drawing_polygon ) {
    var npts = _via_canvas_regions[_via_current_polygon_region_id].shape_attributes['all_points_x'].length;
    if ( npts > 0 ) {
      _via_canvas_regions[_via_current_polygon_region_id].shape_attributes['all_points_x'].splice(npts - 1, 1);
      _via_canvas_regions[_via_current_polygon_region_id].shape_attributes['all_points_y'].splice(npts - 1, 1);

      _via_redraw_reg_canvas();
      _via_reg_canvas.focus();
    }
  }
}

function _via_polyshape_add_new_polyshape(img_id, region_shape, region_id) {
  // add all polygon points stored in _via_canvas_regions[]
  var all_points_x = _via_canvas_regions[region_id].shape_attributes['all_points_x'].slice(0);
  var all_points_y = _via_canvas_regions[region_id].shape_attributes['all_points_y'].slice(0);

  var canvas_all_points_x = [];
  var canvas_all_points_y = [];
  var n = all_points_x.length;
  var i;
  for ( i = 0; i < n; ++i ) {
    all_points_x[i] = Math.round( all_points_x[i] * _via_canvas_scale );
    all_points_y[i] = Math.round( all_points_y[i] * _via_canvas_scale );

    canvas_all_points_x[i] = Math.round( all_points_x[i] / _via_canvas_scale );
    canvas_all_points_y[i] = Math.round( all_points_y[i] / _via_canvas_scale );
  }

  var polygon_region = new file_region();
  polygon_region.shape_attributes['name'] = region_shape;
  polygon_region.shape_attributes['all_points_x'] = all_points_x;
  polygon_region.shape_attributes['all_points_y'] = all_points_y;
  _via_img_metadata[img_id].regions[region_id] = polygon_region;

  // update canvas
  if ( img_id === _via_image_id ) {
    _via_canvas_regions[region_id].shape_attributes['name'] = region_shape;
    _via_canvas_regions[region_id].shape_attributes['all_points_x'] = canvas_all_points_x;
    _via_canvas_regions[region_id].shape_attributes['all_points_y'] = canvas_all_points_y;
  }
}

function del_sel_regions() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    return;
  }

  if ( !_via_current_image_loaded ) {
    show_message('First load some images!');
    return;
  }

  var del_region_count = 0;
  if ( _via_is_all_region_selected ) {
    del_region_count = _via_canvas_regions.length;
    _via_canvas_regions.splice(0);
    _via_img_metadata[_via_image_id].regions.splice(0);
  } else {
    var sorted_sel_reg_id = [];
    for ( var i = 0; i < _via_canvas_regions.length; ++i ) {
      if ( _via_region_selected_flag[i] ) {
        sorted_sel_reg_id.push(i);
        _via_region_selected_flag[i] = false;
      }
    }
    sorted_sel_reg_id.sort( function(a,b) {
      return (b-a);
    });
    for ( var i = 0; i < sorted_sel_reg_id.length; ++i ) {
      _via_canvas_regions.splice( sorted_sel_reg_id[i], 1);
      _via_img_metadata[_via_image_id].regions.splice( sorted_sel_reg_id[i], 1);
      del_region_count += 1;
    }

    if ( sorted_sel_reg_id.length ) {
      _via_reg_canvas.style.cursor = "default";
    }
  }

  _via_is_all_region_selected = false;
  _via_is_region_selected     = false;
  _via_user_sel_region_id     = -1;

  if ( _via_canvas_regions.length === 0 ) {
    // all regions were deleted, hence clear region canvas
    _via_clear_reg_canvas();
  } else {
    _via_redraw_reg_canvas();
  }
  _via_reg_canvas.focus();
  annotation_editor_show();

  show_message('Deleted ' + del_region_count + ' selected regions');
}

function sel_all_regions() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    image_grid_group_toggle_select_all();
    return;
  }

  if (!_via_current_image_loaded) {
    show_message('First load some images!');
    return;
  }

  toggle_all_regions_selection(true);
  _via_is_all_region_selected = true;
  _via_redraw_reg_canvas();
}

function copy_sel_regions() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    return;
  }

  if (!_via_current_image_loaded) {
    show_message('First load some images!');
    return;
  }

  if (_via_is_region_selected ||
      _via_is_all_region_selected) {
    _via_copied_image_regions.splice(0);
    for ( var i = 0; i < _via_img_metadata[_via_image_id].regions.length; ++i ) {
      var img_region = _via_img_metadata[_via_image_id].regions[i];
      var canvas_region = _via_canvas_regions[i];
      if ( _via_region_selected_flag[i] ) {
        _via_copied_image_regions.push( clone_image_region(img_region) );
      }
    }
    show_message('Copied ' + _via_copied_image_regions.length +
                 ' selected regions. Press Ctrl + v to paste');
  } else {
    show_message('Select a region first!');
  }
}

function paste_sel_regions_in_current_image() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    return;
  }

  if ( !_via_current_image_loaded ) {
    show_message('First load some images!');
    return;
  }

  if ( _via_copied_image_regions.length ) {
    var pasted_reg_count = 0;
    for ( var i = 0; i < _via_copied_image_regions.length; ++i ) {
      // ensure copied the regions are within this image's boundaries
      var bbox = get_region_bounding_box( _via_copied_image_regions[i] );
      if (bbox[2] < _via_current_image_width &&
          bbox[3] < _via_current_image_height) {
        var r = clone_image_region(_via_copied_image_regions[i]);
        _via_img_metadata[_via_image_id].regions.push(r);

        pasted_reg_count += 1;
      }
    }
    _via_load_canvas_regions();
    var discarded_reg_count = _via_copied_image_regions.length - pasted_reg_count;
    show_message('Pasted ' + pasted_reg_count + ' regions. ' +
                 'Discarded ' + discarded_reg_count + ' regions exceeding image boundary.');
    _via_redraw_reg_canvas();
    _via_reg_canvas.focus();
  } else {
    show_message('To paste a region, you first need to select a region and copy it!');
  }
}

function paste_to_multiple_images_with_confirm() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    return;
  }

  if ( _via_copied_image_regions.length === 0 ) {
    show_message('First copy some regions!');
    return;
  }

  var config = {'title':'Paste Regions to Multiple Images' };
  var input = { 'region_count': { type:'text', name:'Number of copied regions', value:_via_copied_image_regions.length, disabled:true },
                'prev_next_count':{ type:'text', name:'Copy to (count format)<br><span style="font-size:0.8rem">For example: to paste copied regions to the <i>previous 2 images</i> and <i>next 3 images</i>, type <strong>2,3</strong> in the textbox and to paste only in <i>next 5 images</i>, type <strong>0,5</strong></span>', placeholder:'2,3', disabled:false, size:30},
                'img_index_list':{ type:'text', name:'Copy to (image index list)<br><span style="font-size:0.8rem">For example: <strong>2-5,7,9</strong> pastes the copied regions to the images with the following id <i>2,3,4,5,7,9</i> and <strong>3,8,141</strong> pastes to the images with id <i>3,8 and 141</i></span>', placeholder:'2-5,7,9', disabled:false, size:30},
                'regex':{ type:'text', name:'Copy to filenames matching a regular expression<br><span style="font-size:0.8rem">For example: <strong>_large</strong> pastes the copied regions to all images whose filename contain the keyword <i>_large</i></span>', placeholder:'regular expression', disabled:false, size:30},
                'include_region_attributes':{ type:'checkbox', name:'Paste also the region annotations', checked:true},
              };

  invoke_with_user_inputs(paste_to_multiple_images_confirmed, input, config);
}

function paste_to_multiple_images_confirmed(input) {
  // keep a copy of user inputs for the undo operation
  _via_paste_to_multiple_images_input = input;
  var intersect = generate_img_index_list(input);
  var i;
  var total_pasted_region_count = 0;
  for ( i = 0; i < intersect.length; i++ ) {
    total_pasted_region_count += paste_regions( intersect[i] );
  }

  show_message('Pasted [' + total_pasted_region_count + '] regions ' +
               'in ' + intersect.length + ' images');

  if ( intersect.includes(_via_image_index) ) {
    _via_load_canvas_regions();
    _via_redraw_reg_canvas();
    _via_reg_canvas.focus();
  }
  user_input_default_cancel_handler();
}

function paste_regions(img_index) {
  var pasted_reg_count = 0;
  if ( _via_copied_image_regions.length ) {
    var img_id = _via_image_id_list[img_index];
    var i;
    for ( i = 0; i < _via_copied_image_regions.length; ++i ) {
      var r = clone_image_region(_via_copied_image_regions[i]);
      _via_img_metadata[img_id].regions.push(r);

      pasted_reg_count += 1;
    }
  }
  return pasted_reg_count;
}


function del_sel_regions_with_confirm() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    return;
  }

  if ( _via_copied_image_regions.length === 0 ) {
    show_message('First copy some regions!');
    return;
  }

  var prev_next_count, img_index_list, regex;
  if ( _via_paste_to_multiple_images_input ) {
    prev_next_count = _via_paste_to_multiple_images_input.prev_next_count.value;
    img_index_list  = _via_paste_to_multiple_images_input.img_index_list.value;
    regex = _via_paste_to_multiple_images_input.regex.value;
  }

  var config = {'title':'Undo Regions Pasted to Multiple Images' };
  var input = { 'region_count': { type:'text', name:'Number of regions selected', value:_via_copied_image_regions.length, disabled:true },
                'prev_next_count':{ type:'text', name:'Delete from (count format)<br><span style="font-size:0.8rem">For example: to delete copied regions from the <i>previous 2 images</i> and <i>next 3 images</i>, type <strong>2,3</strong> in the textbox and to delete regions only in <i>next 5 images</i>, type <strong>0,5</strong></span>', placeholder:'2,3', disabled:false, size:30, value:prev_next_count},
                'img_index_list':{ type:'text', name:'Delete from (image index list)<br><span style="font-size:0.8rem">For example: <strong>2-5,7,9</strong> deletes the copied regions to the images with the following id <i>2,3,4,5,7,9</i> and <strong>3,8,141</strong> deletes regions from the images with id <i>3,8 and 141</i></span>', placeholder:'2-5,7,9', disabled:false, size:30, value:img_index_list},
                'regex':{ type:'text', name:'Delete from filenames matching a regular expression<br><span style="font-size:0.8rem">For example: <strong>_large</strong> deletes the copied regions from all images whose filename contain the keyword <i>_large</i></span>', placeholder:'regular expression', disabled:false, size:30, value:regex},
              };

  invoke_with_user_inputs(del_sel_regions_confirmed, input, config);
}

function del_sel_regions_confirmed(input) {
  user_input_default_cancel_handler();
  var intersect = generate_img_index_list(input);
  var i;
  var total_deleted_region_count = 0;
  for ( i = 0; i < intersect.length; i++ ) {
    total_deleted_region_count += delete_regions( intersect[i] );
  }

  show_message('Deleted [' + total_deleted_region_count + '] regions ' +
               'in ' + intersect.length + ' images');

  if ( intersect.includes(_via_image_index) ) {
    _via_load_canvas_regions();
    _via_redraw_reg_canvas();
    _via_reg_canvas.focus();
  }
}

function delete_regions(img_index) {
  var del_region_count = 0;
  if ( _via_copied_image_regions.length ) {
    var img_id = _via_image_id_list[img_index];
    var i;
    for ( i = 0; i < _via_copied_image_regions.length; ++i ) {
      var copied_region_shape_str = JSON.stringify(_via_copied_image_regions[i].shape_attributes);
      var j;
      // start from last region in order to delete the last pasted region
      for ( j = _via_img_metadata[img_id].regions.length-1; j >= 0; --j ) {
        if ( JSON.stringify(_via_img_metadata[img_id].regions[j].shape_attributes) === copied_region_shape_str ) {
          _via_img_metadata[img_id].regions.splice( j, 1);
          del_region_count += 1;
          break; // delete only one matching region
        }
      }
    }
  }
  return del_region_count;
}

function show_first_image() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    if ( _via_image_grid_group_var.length ) {
      image_grid_group_prev( { 'value':0 } ); // simulate button click
    } else {
      show_message('First, create groups by selecting items from "Group by" dropdown list');
    }
    return;
  }

  if (_via_img_count > 0) {
    _via_show_img( _via_img_fn_list_img_index_list[0] );
  }
}

function show_last_image() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    if ( _via_image_grid_group_var.length ) {
      image_grid_group_prev( { 'value':_via_image_grid_group_var.length-1 } ); // simulate button click
    } else {
      show_message('First, create groups by selecting items from "Group by" dropdown list');
    }
    return;
  }

  if (_via_img_count > 0) {
    var last_img_index = _via_img_fn_list_img_index_list.length - 1;
    _via_show_img( _via_img_fn_list_img_index_list[ last_img_index ] );
  }
}

function jump_image_block_get_count() {
  var n = _via_img_fn_list_img_index_list.length;
  if ( n < 20 ) {
    return 2;
  }
  if ( n < 100 ) {
    return 10;
  }
  if ( n < 1000 ) {
    return 25;
  }
  if ( n < 5000 ) {
    return 50;
  }
  if ( n < 10000 ) {
    return 100;
  }
  if ( n < 50000 ) {
    return 500;
  }

  return Math.round( n / 50 );
}

function jump_to_next_image_block() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    return;
  }

  var jump_count = jump_image_block_get_count();
  if ( jump_count > 1 ) {
    var current_img_index = _via_image_index;
    if ( _via_img_fn_list_img_index_list.includes( current_img_index ) ) {
      var list_index = _via_img_fn_list_img_index_list.indexOf( current_img_index );
      var next_list_index = list_index + jump_count;
      if ( (next_list_index + 1) > _via_img_fn_list_img_index_list.length ) {
        next_list_index = 0;
      }
      var next_img_index = _via_img_fn_list_img_index_list[next_list_index];
      _via_show_img(next_img_index);
    }
  } else {
    move_to_next_image();
  }
}

function jump_to_prev_image_block() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    return;
  }

  var jump_count = jump_image_block_get_count();
  if ( jump_count > 1 ) {
    var current_img_index = _via_image_index;
    if ( _via_img_fn_list_img_index_list.includes( current_img_index ) ) {
      var list_index = _via_img_fn_list_img_index_list.indexOf( current_img_index );
      var prev_list_index = list_index - jump_count;
      if ( prev_list_index < 0 ) {
        prev_list_index = _via_img_fn_list_img_index_list.length - 1;
      }
      var prev_img_index = _via_img_fn_list_img_index_list[prev_list_index];
      _via_show_img(prev_img_index);
    }
  } else {
    move_to_prev_image();
  }
}

function move_to_prev_image() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    if ( _via_image_grid_group_var.length ) {
      var last_group_index = _via_image_grid_group_var.length - 1;
      image_grid_group_prev( { 'value':last_group_index } ); // simulate button click
    } else {
      show_message('First, create groups by selecting items from "Group by" dropdown list');
    }
    return;
  }

  if (_via_img_count > 0) {
    var current_img_index = _via_image_index;
    if ( _via_img_fn_list_img_index_list.includes( current_img_index ) ) {
      var list_index = _via_img_fn_list_img_index_list.indexOf( current_img_index );
      var next_list_index = list_index - 1;
      if ( next_list_index === -1 ) {
        next_list_index = _via_img_fn_list_img_index_list.length - 1;
      }
      var next_img_index = _via_img_fn_list_img_index_list[next_list_index];
      _via_show_img(next_img_index);
    } else {
      if ( _via_img_fn_list_img_index_list.length === 0 ) {
        show_message('Filtered file list does not any files!');
      } else {
        _via_show_img( _via_img_fn_list_img_index_list[0] );
      }
    }

    if (typeof _via_hook_prev_image === 'function') {
      _via_hook_prev_image(current_img_index);
    }
  }
}

function move_to_next_image() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    if ( _via_image_grid_group_var.length ) {
      var last_group_index = _via_image_grid_group_var.length - 1;
      image_grid_group_next( { 'value':last_group_index } ); // simulate button click
    } else {
      show_message('First, create groups by selecting items from "Group by" dropdown list');
    }
    return;
  }

  if (_via_img_count > 0) {
    var current_img_index = _via_image_index;
    if ( _via_img_fn_list_img_index_list.includes( current_img_index ) ) {
      var list_index = _via_img_fn_list_img_index_list.indexOf( current_img_index );
      var next_list_index = list_index + 1;
      if ( next_list_index === _via_img_fn_list_img_index_list.length ) {
        next_list_index = 0;
      }
      var next_img_index = _via_img_fn_list_img_index_list[next_list_index];
      _via_show_img(next_img_index);
    } else {
      if ( _via_img_fn_list_img_index_list.length === 0 ) {
        show_message('Filtered file list does not contain any files!');
      } else {
        _via_show_img( _via_img_fn_list_img_index_list[0] );
      }
    }

    if (typeof _via_hook_next_image === 'function') {
      _via_hook_next_image(current_img_index);
    }
  }
}

function set_zoom(zoom_level_index) {
  if ( zoom_level_index === VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX ) {
    _via_is_canvas_zoomed = false;
    _via_canvas_zoom_level_index = VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX;
  } else {
    _via_is_canvas_zoomed = true;
    _via_canvas_zoom_level_index = zoom_level_index;
  }

  var zoom_scale = VIA_CANVAS_ZOOM_LEVELS[_via_canvas_zoom_level_index];
  set_all_canvas_scale(zoom_scale);
  var canvas_w = ( _via_current_image.naturalWidth  * zoom_scale ) / _via_canvas_scale_without_zoom;
  var canvas_h = ( _via_current_image.naturalHeight * zoom_scale ) / _via_canvas_scale_without_zoom;
  set_all_canvas_size(canvas_w, canvas_h);
  _via_canvas_scale = _via_canvas_scale_without_zoom / zoom_scale;
  _via_canvas_scale = _via_canvas_scale_without_zoom / zoom_scale;

  if ( zoom_scale === 1 ) {
    VIA_REGION_POINT_RADIUS = VIA_REGION_POINT_RADIUS_DEFAULT;
  } else {
    if ( zoom_scale > 1 ) {
      VIA_REGION_POINT_RADIUS = VIA_REGION_POINT_RADIUS_DEFAULT * zoom_scale;
    }
  }

  _via_load_canvas_regions(); // image to canvas space transform
  _via_redraw_reg_canvas();
  _via_reg_canvas.focus();
  update_vertical_space();
}

function reset_zoom_level() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    image_grid_image_size_reset();
    show_message('Zoom reset');
    return;
  }

  if (!_via_current_image_loaded) {
    show_message('First load some images!');
    return;
  }

  if (_via_is_canvas_zoomed) {
    set_zoom(VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX);
    show_message('Zoom reset');
  } else {
    show_message('Cannot reset zoom because image zoom has not been applied!');
  }
  update_vertical_space();
}

function zoom_in() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    image_grid_image_size_increase();
    show_message('Increased size of images shown in image grid');
    return;
  }

  if (!_via_current_image_loaded) {
    show_message('First load some images!');
    return;
  }

  if ( _via_is_user_drawing_polygon || _via_is_user_drawing_region ) {
    return;
  }

  if (_via_canvas_zoom_level_index === (VIA_CANVAS_ZOOM_LEVELS.length-1)) {
    show_message('Further zoom-in not possible');
  } else {
    var new_zoom_level_index = _via_canvas_zoom_level_index + 1;
    set_zoom( new_zoom_level_index );
    show_message('Zoomed in to level ' + VIA_CANVAS_ZOOM_LEVELS[_via_canvas_zoom_level_index] + 'X');
  }
}

function zoom_out() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    image_grid_image_size_decrease();
    show_message('Reduced size of images shown in image grid');
    return;
  }

  if (!_via_current_image_loaded) {
    show_message('First load some images!');
    return;
  }

  if ( _via_is_user_drawing_polygon || _via_is_user_drawing_region ) {
    return;
  }

  if (_via_canvas_zoom_level_index === 0) {
    show_message('Further zoom-out not possible');
  } else {
    var new_zoom_level_index = _via_canvas_zoom_level_index - 1;
    set_zoom( new_zoom_level_index );
    show_message('Zoomed out to level ' + VIA_CANVAS_ZOOM_LEVELS[_via_canvas_zoom_level_index] + 'X');
  }
}

function toggle_region_boundary_visibility() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE ) {
    _via_is_region_boundary_visible = !_via_is_region_boundary_visible;
    _via_redraw_reg_canvas();
    _via_reg_canvas.focus();
  }

  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    if ( _via_settings.ui.image_grid.show_region_shape ) {
      _via_settings.ui.image_grid.show_region_shape = false;
      document.getElementById('image_grid_content_rshape').innerHTML = '';
    } else {
      _via_settings.ui.image_grid.show_region_shape = true;
      image_grid_page_show_all_regions();
    }
  }
}

function toggle_region_id_visibility() {
  _via_is_region_id_visible = !_via_is_region_id_visible;
  _via_redraw_reg_canvas();
  _via_reg_canvas.focus();
}

function toggle_region_info_visibility() {
  var elem = document.getElementById('region_info');
  // toggle between displaying and not displaying
  if ( elem.classList.contains('display_none') ) {
    elem.classList.remove('display_none');
    _via_is_region_info_visible = true;
  } else {
    elem.classList.add('display_none');
    _via_is_region_info_visible = false;
  }
}

//
// Mouse wheel event listener
//
function _via_reg_canvas_mouse_wheel_listener(e) {
  if (!_via_current_image_loaded) {
    return;
  }

  if ( e.ctrlKey ) {
    // perform zoom
    if (e.deltaY < 0) {
      zoom_in();
    } else {
      zoom_out();
    }
    e.preventDefault();
  }
}

function region_visualisation_update(type, default_id, next_offset) {
  var attr_list = [ default_id ];
  attr_list = attr_list.concat(Object.keys(_via_attributes['region']));
  var n = attr_list.length;
  var current_index = attr_list.indexOf(_via_settings.ui.image[type]);
  var new_index;
  if ( current_index !== -1 ) {
    new_index = current_index + next_offset;

    if ( new_index < 0 ) {
      new_index = n + new_index;
    }
    if ( new_index >= n ) {
      new_index = new_index - n;
    }
    switch(type) {
    case 'region_label':
      _via_settings.ui.image.region_label = attr_list[new_index];
      _via_redraw_reg_canvas();
      break;
    case 'region_color':
      _via_settings.ui.image.region_color = attr_list[new_index];
      _via_regions_group_color_init();
      _via_redraw_reg_canvas();
    }

    var type_str = type.replace('_', ' ');
    if ( _via_settings.ui.image[type].startsWith('__via') ) {
      show_message(type_str + ' cleared');
    } else {
      show_message(type_str + ' set to region attribute [' + _via_settings.ui.image[type] + ']');
    }
  }
}

//
// left sidebar toolbox maintainer
//
function leftsidebar_toggle() {
  var leftsidebar = document.getElementById('leftsidebar');
  if ( leftsidebar.style.display === 'none' ) {
    leftsidebar.style.display = 'table-cell';
    document.getElementById('leftsidebar_collapse_panel').style.display = 'none';
  } else {
    leftsidebar.style.display = 'none';
    document.getElementById('leftsidebar_collapse_panel').style.display = 'table-cell';
  }
  _via_update_ui_components();
}

function leftsidebar_increase_width() {
  var leftsidebar = document.getElementById('leftsidebar');
  var new_width = _via_settings.ui.leftsidebar_width + VIA_LEFTSIDEBAR_WIDTH_CHANGE;
  leftsidebar.style.width = new_width + 'rem';
  _via_settings.ui.leftsidebar_width = new_width;
  if ( _via_current_image_loaded ) {
    _via_show_img(_via_image_index);
  }
}

function leftsidebar_decrease_width() {
  var leftsidebar = document.getElementById('leftsidebar');
  var new_width = _via_settings.ui.leftsidebar_width - VIA_LEFTSIDEBAR_WIDTH_CHANGE;
  if ( new_width >= 5 ) {
    leftsidebar.style.width = new_width + 'rem';
    _via_settings.ui.leftsidebar_width = new_width;
    if ( _via_current_image_loaded ) {
      _via_show_img(_via_image_index);
    }
  }
}

function leftsidebar_show() {
  var leftsidebar = document.getElementById('leftsidebar');
  leftsidebar.style.display = 'table-cell';
  document.getElementById('leftsidebar_collapse_panel').style.display = 'none';
}

// source: https://www.w3schools.com/howto/howto_js_accordion.asp
function init_leftsidebar_accordion() {
  var leftsidebar = document.getElementById('leftsidebar');
  leftsidebar.style.width = _via_settings.ui.leftsidebar_width + 'rem';

  var acc = document.getElementsByClassName('leftsidebar_accordion');
  var i;
  for ( i = 0; i < acc.length; ++i ) {
    acc[i].addEventListener('click', function() {
      update_vertical_space();
      this.classList.toggle('active');
      this.nextElementSibling.classList.toggle('show');

      switch( this.innerHTML ) {
      case 'Attributes':
        update_attributes_update_panel();
        break;
      case 'Project':
        update_img_fn_list();
        break;
      }
    });
  }
}

//
// image filename list shown in leftsidebar panel
//
function is_img_fn_list_visible() {
  return img_fn_list_panel.classList.contains('show');
}

function img_loading_spinbar(image_index, show) {
  var panel = document.getElementById('project_panel_title');
  if ( show ) {
    panel.innerHTML = 'Project <span style="margin-left:1rem;" class="loading_spinbox"></span>';
  } else {
    panel.innerHTML = 'Project';
  }
}

function update_img_fn_list() {
  var regex = document.getElementById('img_fn_list_regex').value;
  var p = document.getElementById('filelist_preset_filters_list');
  if ( regex === '' || regex === null ) {
    if ( p.selectedIndex === 0 ) {
      // show all files
      _via_img_fn_list_html = [];
      _via_img_fn_list_img_index_list = [];
      _via_img_fn_list_html.push('<ul>');
      for ( var i=0; i < _via_image_filename_list.length; ++i ) {
        _via_img_fn_list_html.push( img_fn_list_ith_entry_html(i) );
        _via_img_fn_list_img_index_list.push(i);
      }
      _via_img_fn_list_html.push('</ul>');
      img_fn_list.innerHTML = _via_img_fn_list_html.join('');
      img_fn_list_scroll_to_current_file();
    } else {
      // filter according to preset filters
      img_fn_list_onpresetfilter_select();
    }
  } else {
    img_fn_list_generate_html(regex);
    img_fn_list.innerHTML = _via_img_fn_list_html.join('');
    img_fn_list_scroll_to_current_file();
  }
}

function img_fn_list_onregex() {
  var regex = document.getElementById('img_fn_list_regex').value;
  img_fn_list_generate_html( regex );
  img_fn_list.innerHTML = _via_img_fn_list_html.join('');
  img_fn_list_scroll_to_current_file();

  // select 'regex' in the predefined filter list
  var p = document.getElementById('filelist_preset_filters_list');
  if ( regex === '' ) {
    p.selectedIndex = 0;
  } else {
    var i;
    for ( i=0; i<p.options.length; ++i ) {
      if ( p.options[i].value === 'regex' ) {
        p.selectedIndex = i;
        break;
      }
    }
  }
}

function img_fn_list_onpresetfilter_select() {
  var p = document.getElementById('filelist_preset_filters_list');
  var filter = p.options[p.selectedIndex].value;
  switch(filter) {
  case 'all':
    document.getElementById('img_fn_list_regex').value = '';
    img_fn_list_generate_html();
    img_fn_list.innerHTML = _via_img_fn_list_html.join('');
    img_fn_list_scroll_to_current_file();
    break;
  case 'regex':
    document.getElementById('img_fn_list_regex').focus();
    break;
  default:
    _via_img_fn_list_html = [];
    _via_img_fn_list_img_index_list = [];
    _via_img_fn_list_html.push('<ul>');
    var i;
    for ( i=0; i < _via_image_filename_list.length; ++i ) {
      var img_id = _via_image_id_list[i];
      var add_to_list = false;
      switch(filter) {
      case 'files_without_region':
        if ( _via_img_metadata[img_id].regions.length === 0 ) {
          add_to_list = true;
        }
        break;
      case 'files_missing_region_annotations':
        if ( is_region_annotation_missing(img_id) ) {
          add_to_list = true;
        }
        break;
      case 'files_missing_file_annotations':
        if ( is_file_annotation_missing(img_id) ) {
          add_to_list = true;
        }
        break;
      case 'files_error_loading':
        if ( _via_image_load_error[i] === true ) {
          add_to_list = true;
        }
      }
      if ( add_to_list ) {
        _via_img_fn_list_html.push( img_fn_list_ith_entry_html(i) );
        _via_img_fn_list_img_index_list.push(i);
      }
    }
    _via_img_fn_list_html.push('</ul>');
    img_fn_list.innerHTML = _via_img_fn_list_html.join('');
    img_fn_list_scroll_to_current_file();
    break;
  }
}

function is_region_annotation_missing(img_id) {
  var region_attribute;
  var i;
  for ( i = 0; i < _via_img_metadata[img_id].regions.length; ++i ) {
    for ( region_attribute in _via_attributes['region'] ) {
      if ( _via_img_metadata[img_id].regions[i].region_attributes.hasOwnProperty(region_attribute) ) {
        if ( _via_img_metadata[img_id].regions[i].region_attributes[region_attribute] === '' ) {
          return true;
        }
      } else {
        return true;
      }
    }
  }
  return false;
}

function is_file_annotation_missing(img_id) {
  var file_attribute;
  for ( file_attribute in _via_attributes['file'] ) {
    if ( _via_img_metadata[img_id].file_attributes.hasOwnProperty(file_attribute) ) {
      if ( _via_img_metadata[img_id].file_attributes[file_attribute] === '' ) {
        return true;
      }
    } else {
      return true;
    }
  }
  return false;
}

function img_fn_list_ith_entry_selected(img_index, is_selected) {
  if ( is_selected ) {
    img_fn_list_ith_entry_add_css_class(img_index, 'sel');
  } else {
    img_fn_list_ith_entry_remove_css_class(img_index, 'sel');
  }
}

function img_fn_list_ith_entry_error(img_index, is_error) {
  if ( is_error ) {
    img_fn_list_ith_entry_add_css_class(img_index, 'error');
  } else {
    img_fn_list_ith_entry_remove_css_class(img_index, 'error');
  }
}

function img_fn_list_ith_entry_add_css_class(img_index, classname) {
  var li = document.getElementById('fl' + img_index);
  if ( li && ! li.classList.contains(classname)  ) {
    li.classList.add(classname);
  }
}

function img_fn_list_ith_entry_remove_css_class(img_index, classname) {
  var li = document.getElementById('fl' + img_index);
  if ( li && li.classList.contains(classname) ) {
    li.classList.remove(classname);
  }
}

function img_fn_list_clear_all_style() {
  var cn = document.getElementById('img_fn_list').childNodes[0].childNodes;
  var i, j;
  var n = cn.length;
  var nclass;
  for ( i = 0; i < n; ++i ) {
    //cn[i].classList = []; // throws error in Edge browser
    nclass = cn[i].classList.length;
    if ( nclass ) {
      for ( j = 0; j < nclass; ++j ) {
        cn[i].classList.remove( cn[i].classList.item(j) );
      }
    }
  }
}

function img_fn_list_clear_css_classname(classname) {
  var cn = document.getElementById('img_fn_list').childNodes[0].childNodes;
  var i;
  var n = cn.length;
  for ( i = 0; i < n; ++i ) {
    if ( cn[i].classList.contains(classname) ) {
      cn[i].classList.remove(classname);
    }
  }
}

function img_fn_list_ith_entry_html(i) {
  var htmli = '';
  var filename = _via_image_filename_list[i];
  if ( is_url(filename) ) {
    filename = filename.substr(0,4) + '...' + get_filename_from_url(filename);
  }

  htmli += '<li id="fl' + i + '"';
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    if ( _via_image_grid_page_img_index_list.includes(i) ) {
      // highlight images being shown in image grid
      htmli += ' class="sel"';
    }

  } else {
    if ( i === _via_image_index ) {
      // highlight the current entry
      htmli += ' class="sel"';
    }
  }
  htmli += ' onclick="jump_to_image(' + (i) + ')" title="' + _via_image_filename_list[i] + '">[' + (i+1) + '] ' + filename + '</li>';
  return htmli;
}

function img_fn_list_generate_html(regex) {
  _via_img_fn_list_html = [];
  _via_img_fn_list_img_index_list = [];
  _via_img_fn_list_html.push('<ul>');
  for ( var i=0; i < _via_image_filename_list.length; ++i ) {
    var filename = _via_image_filename_list[i];
    if ( filename.match(regex) !== null ) {
      _via_img_fn_list_html.push( img_fn_list_ith_entry_html(i) );
      _via_img_fn_list_img_index_list.push(i);
    }
  }
  _via_img_fn_list_html.push('</ul>');
}

function img_fn_list_scroll_to_current_file() {
  img_fn_list_scroll_to_file( _via_image_index );
}

function img_fn_list_scroll_to_file(file_index) {
  if( _via_img_fn_list_img_index_list.includes(file_index) ) {
    var sel_file     = document.getElementById( 'fl' + file_index );
    var panel_height = img_fn_list.clientHeight - 20;
    var window_top    = img_fn_list.scrollTop;
    var window_bottom = img_fn_list.scrollTop + panel_height
    if ( sel_file.offsetTop > window_top ) {
      if ( sel_file.offsetTop > window_bottom ) {
        img_fn_list.scrollTop = sel_file.offsetTop;
      }
    } else {
      img_fn_list.scrollTop = sel_file.offsetTop - panel_height;
    }
  }
}

function toggle_img_fn_list_visibility() {
  leftsidebar_show();
  document.getElementById('img_fn_list_panel').classList.toggle('show');
  document.getElementById('project_panel_title').classList.toggle('active');
}

function toggle_attributes_editor() {
  leftsidebar_show();
  document.getElementById('attributes_editor_panel').classList.toggle('show');
  document.getElementById('attributes_editor_panel_title').classList.toggle('active');
}

// this vertical spacer is needed to allow scrollbar to show
// items like Keyboard Shortcut hidden under the attributes panel
function update_vertical_space() {
  var panel = document.getElementById('vertical_space');
  var aepanel = document.getElementById('annotation_editor_panel');
  panel.style.height = (aepanel.offsetHeight + 40) + 'px';
}

//
// region and file attributes update panel
//
function attribute_update_panel_set_active_button() {
  var attribute_type;
  for ( attribute_type in _via_attributes ) {
    var bid = 'button_show_' + attribute_type + '_attributes';
    document.getElementById(bid).classList.remove('active');
  }
  var bid = 'button_show_' + _via_attribute_being_updated + '_attributes';
  document.getElementById(bid).classList.add('active');
}

function show_region_attributes_update_panel() {
  _via_attribute_being_updated = 'region';
  var rattr_list = Object.keys(_via_attributes['region']);
  if ( rattr_list.length ) {
    _via_current_attribute_id = rattr_list[0];
  } else {
    _via_current_attribute_id = '';
  }
  update_attributes_update_panel();
  attribute_update_panel_set_active_button();

}

function show_file_attributes_update_panel() {
  _via_attribute_being_updated = 'file';
  var fattr_list = Object.keys(_via_attributes['file']);
  if ( fattr_list.length ) {
    _via_current_attribute_id = fattr_list[0];
  } else {
    _via_current_attribute_id = '';
  }
  update_attributes_update_panel();
  attribute_update_panel_set_active_button();
}

function update_attributes_name_list() {
  var p = document.getElementById('attributes_name_list');
  p.innerHTML = '';

  var attr;
  for ( attr in _via_attributes[_via_attribute_being_updated] ) {
    var option = document.createElement('option');
    option.setAttribute('value', attr)
    option.innerHTML = attr;
    if ( attr === _via_current_attribute_id ) {
      option.setAttribute('selected', 'selected');
    }
    p.appendChild(option);
  }
}

function update_attributes_update_panel() {
  if ( document.getElementById('attributes_editor_panel').classList.contains('show') ) {
    update_attributes_name_list();
    show_attribute_properties();
    show_attribute_options();
  }
}

function update_attribute_properties_panel() {
  if ( document.getElementById('attributes_editor_panel').classList.contains('show') ) {
    show_attribute_properties();
    show_attribute_options();
  }
}

function show_attribute_properties() {
  var attr_list = document.getElementById('attributes_name_list');
  document.getElementById('attribute_properties').innerHTML = '';

  if ( attr_list.options.length === 0 ) {
    return;
  }

  if ( typeof(_via_current_attribute_id) === 'undefined' || _via_current_attribute_id === '' ) {
    _via_current_attribute_id = attr_list.options[0].value;
  }

  var attr_id = _via_current_attribute_id;
  var attr_type = _via_attribute_being_updated;
  var attr_input_type = _via_attributes[attr_type][attr_id].type;
  var attr_desc = _via_attributes[attr_type][attr_id].description;

  attribute_property_add_input_property('Name of attribute (appears in exported annotations)',
                                        'Name',
                                        attr_id,
                                        'attribute_name');
  attribute_property_add_input_property('Description of attribute (shown to user during annotation session)',
                                        'Desc.',
                                        attr_desc,
                                        'attribute_description');

  if ( attr_input_type === 'text' ) {
    var attr_default_value = _via_attributes[attr_type][attr_id].default_value;
    attribute_property_add_input_property('Default value of this attribute',
                                          'Def.',
                                          attr_default_value,
                                          'attribute_default_value');
  }

  // add dropdown for type of attribute
  var p = document.createElement('div');
  p.setAttribute('class', 'property');
  var c0 = document.createElement('span');
  c0.setAttribute('title', 'Attribute type (e.g. text, checkbox, radio, etc)');
  c0.innerHTML = 'Type';
  var c1 = document.createElement('span');
  var c1b = document.createElement('select');
  c1b.setAttribute('onchange', 'attribute_property_on_update(this)');
  c1b.setAttribute('id', 'attribute_type');
  var type_id;
  for ( type_id in VIA_ATTRIBUTE_TYPE ) {
    var type = VIA_ATTRIBUTE_TYPE[type_id];
    var option = document.createElement('option');
    option.setAttribute('value', type);
    option.innerHTML = type;
    if ( attr_input_type == type ) {
      option.setAttribute('selected', 'selected');
    }
    c1b.appendChild(option);
  }
  c1.appendChild(c1b);
  p.appendChild(c0);
  p.appendChild(c1);
  document.getElementById('attribute_properties').appendChild(p);
}

function show_attribute_options() {
  var attr_list = document.getElementById('attributes_name_list');
  document.getElementById('attribute_options').innerHTML = '';
  if ( attr_list.options.length === 0 ) {
    return;
  }

  var attr_id = attr_list.value;
  var attr_type = _via_attributes[_via_attribute_being_updated][attr_id].type;

  // populate additional options based on attribute type
  switch( attr_type ) {
  case VIA_ATTRIBUTE_TYPE.TEXT:
    // text does not have any additional properties
    break;
  case VIA_ATTRIBUTE_TYPE.IMAGE:
    var p = document.createElement('div');
    p.setAttribute('class', 'property');
    p.setAttribute('style', 'text-align:center');
    var c0 = document.createElement('span');
    c0.setAttribute('style', 'width:25%');
    c0.setAttribute('title', 'When selected, this is the value that appears in exported annotations');
    c0.innerHTML = 'id';
    var c1 = document.createElement('span');
    c1.setAttribute('style', 'width:60%');
    c1.setAttribute('title', 'URL or base64 (see https://www.base64-image.de/) encoded image data that corresponds to the image shown as an option to the annotator');
    c1.innerHTML = 'image url or b64';
    var c2 = document.createElement('span');
    c2.setAttribute('title', 'The default value of this attribute');
    c2.innerHTML = 'def.';
    p.appendChild(c0);
    p.appendChild(c1);
    p.appendChild(c2);
    document.getElementById('attribute_options').appendChild(p);

    var options = _via_attributes[_via_attribute_being_updated][attr_id].options;
    var option_id;
    for ( option_id in options ) {
      var option_desc = options[option_id];

      var option_default = _via_attributes[_via_attribute_being_updated][attr_id].default_options[option_id];
      attribute_property_add_option(attr_id, option_id, option_desc, option_default, attr_type);
    }
    attribute_property_add_new_entry_option(attr_id, attr_type);
    break;
  case VIA_ATTRIBUTE_TYPE.CHECKBOX: // handled by next case
  case VIA_ATTRIBUTE_TYPE.DROPDOWN: // handled by next case
  case VIA_ATTRIBUTE_TYPE.RADIO:
    var p = document.createElement('div');
    p.setAttribute('class', 'property');
    p.setAttribute('style', 'text-align:center');
    var c0 = document.createElement('span');
    c0.setAttribute('style', 'width:25%');
    c0.setAttribute('title', 'When selected, this is the value that appears in exported annotations');
    c0.innerHTML = 'id';
    var c1 = document.createElement('span');
    c1.setAttribute('style', 'width:60%');
    c1.setAttribute('title', 'This is the text shown as an option to the annotator');
    c1.innerHTML = 'description';
    var c2 = document.createElement('span');
    c2.setAttribute('title', 'The default value of this attribute');
    c2.innerHTML = 'def.';
    p.appendChild(c0);
    p.appendChild(c1);
    p.appendChild(c2);
    document.getElementById('attribute_options').appendChild(p);

    var options = _via_attributes[_via_attribute_being_updated][attr_id].options;
    var option_id;
    for ( option_id in options ) {
      var option_desc = options[option_id];

      var option_default = _via_attributes[_via_attribute_being_updated][attr_id].default_options[option_id];
      attribute_property_add_option(attr_id, option_id, option_desc, option_default, attr_type);
    }
    attribute_property_add_new_entry_option(attr_id, attr_type);
    break;
  default:
    console.log('Attribute type ' + attr_type + ' is unavailable');
  }
}

function attribute_property_add_input_property(title, name, value, id) {
  var p = document.createElement('div');
  p.setAttribute('class', 'property');
  var c0 = document.createElement('span');
  c0.setAttribute('title', title);
  c0.innerHTML = name;
  var c1 = document.createElement('span');
  var c1b = document.createElement('input');
  c1b.setAttribute('onchange', 'attribute_property_on_update(this)');
  if ( typeof(value) !== 'undefined' ) {
    c1b.setAttribute('value', value);
  }
  c1b.setAttribute('id', id);
  c1.appendChild(c1b);
  p.appendChild(c0);
  p.appendChild(c1);

  document.getElementById('attribute_properties').appendChild(p);
}

function attribute_property_add_option(attr_id, option_id, option_desc, option_default, attribute_type) {
  var p = document.createElement('div');
  p.setAttribute('class', 'property');
  var c0 = document.createElement('span');
  var c0b = document.createElement('input');
  c0b.setAttribute('type', 'text');
  c0b.setAttribute('value', option_id);
  c0b.setAttribute('title', option_id);
  c0b.setAttribute('onchange', 'attribute_property_on_option_update(this)');
  c0b.setAttribute('id', '_via_attribute_option_id_' + option_id);

  var c1 = document.createElement('span');
  var c1b = document.createElement('input');
  c1b.setAttribute('type', 'text');

  if ( attribute_type === VIA_ATTRIBUTE_TYPE.IMAGE ) {
    var option_desc_info = option_desc.length + ' bytes of base64 image data';
    c1b.setAttribute('value', option_desc_info);
    c1b.setAttribute('title', 'To update, copy and paste base64 image data in this text box');
  } else {
    c1b.setAttribute('value', option_desc);
    c1b.setAttribute('title', option_desc);
  }
  c1b.setAttribute('onchange', 'attribute_property_on_option_update(this)');
  c1b.setAttribute('id', '_via_attribute_option_description_' + option_id);

  var c2 = document.createElement('span');
  var c2b = document.createElement('input');
  c2b.setAttribute('type', attribute_type);
  if ( typeof option_default !== 'undefined' ) {
    c2b.checked = option_default;
  }
  if ( attribute_type === 'radio' || attribute_type === 'image' || attribute_type === 'dropdown' ) {
    // ensured that user can activate only one radio button
    c2b.setAttribute('type', 'radio');
    c2b.setAttribute('name', attr_id);
  }

  c2b.setAttribute('onchange', 'attribute_property_on_option_update(this)');
  c2b.setAttribute('id', '_via_attribute_option_default_' + option_id);

  c0.appendChild(c0b);
  c1.appendChild(c1b);
  c2.appendChild(c2b);
  p.appendChild(c0);
  p.appendChild(c1);
  p.appendChild(c2);

  document.getElementById('attribute_options').appendChild(p);
}

function attribute_property_add_new_entry_option(attr_id, attribute_type) {
  var p = document.createElement('div');
  p.setAttribute('class', 'new_option_id_entry');
  var c0b = document.createElement('input');
  c0b.setAttribute('type', 'text');
  c0b.setAttribute('onchange', 'attribute_property_on_option_add(this)');
  c0b.setAttribute('id', '_via_attribute_new_option_id');
  c0b.setAttribute('placeholder', 'Add new option id');
  p.appendChild(c0b);
  document.getElementById('attribute_options').appendChild(p);
}

function attribute_property_on_update(p) {
  var attr_id = get_current_attribute_id();
  var attr_type = _via_attribute_being_updated;
  var attr_value = p.value;

  switch(p.id) {
  case 'attribute_name':
    if ( attr_value !== attr_id ) {
      Object.defineProperty(_via_attributes[attr_type],
                            attr_value,
                            Object.getOwnPropertyDescriptor(_via_attributes[attr_type], attr_id));

      delete _via_attributes[attr_type][attr_id];
      update_attributes_update_panel();
      annotation_editor_update_content();
    }
    break;
  case 'attribute_description':
    _via_attributes[attr_type][attr_id].description = attr_value;
    update_attributes_update_panel();
    annotation_editor_update_content();
    break;
  case 'attribute_default_value':
    _via_attributes[attr_type][attr_id].default_value = attr_value;
    update_attributes_update_panel();
    annotation_editor_update_content();
    break;
  case 'attribute_type':
    _via_attributes[attr_type][attr_id].type = attr_value;
    if( attr_value === VIA_ATTRIBUTE_TYPE.TEXT ) {
      _via_attributes[attr_type][attr_id].default_value = '';
      delete _via_attributes[attr_type][attr_id].options;
      delete _via_attributes[attr_type][attr_id].default_options;
    } else {
      // preserve existing options
      if ( ! _via_attributes[attr_type][attr_id].hasOwnProperty('options') ) {
        _via_attributes[attr_type][attr_id].options = {};
        _via_attributes[attr_type][attr_id].default_options = {};
      }

      if ( _via_attributes[attr_type][attr_id].hasOwnProperty('default_value') ) {
        delete _via_attributes[attr_type][attr_id].default_value;
      }

      // collect existing attribute values and add them as options
      var attr_values = attribute_get_unique_values(attr_type, attr_id);
      var i;
      for ( i = 0; i < attr_values.length; ++i ) {
        var attr_val = attr_values[i];
        if ( attr_val !== '' ) {
          _via_attributes[attr_type][attr_id].options[attr_val] = attr_val;
        }
      }
    }
    show_attribute_properties();
    show_attribute_options();
    annotation_editor_update_content();
    break;
  }
}

function attribute_get_unique_values(attr_type, attr_id) {
  var values = [];
  switch ( attr_type ) {
  case 'file':
    var img_id, attr_val;
    for ( img_id in _via_img_metadata ) {
      if ( _via_img_metadata[img_id].file_attributes.hasOwnProperty(attr_id) ) {
        attr_val = _via_img_metadata[img_id].file_attributes[attr_id];
        if ( ! values.includes(attr_val) ) {
          values.push(attr_val);
        }
      }
    }
    break;
  case 'region':
    var img_id, attr_val, i;
    for ( img_id in _via_img_metadata ) {
      for ( i = 0; i < _via_img_metadata[img_id].regions.length; ++i ) {
        if ( _via_img_metadata[img_id].regions[i].region_attributes.hasOwnProperty(attr_id) ) {
          attr_val = _via_img_metadata[img_id].regions[i].region_attributes[attr_id];
          if ( ! values.includes(attr_val) ) {
            values.push(attr_val);
          }
        }
      }
    }
    break;
  default:
    break;
  }
  return values;
}

function attribute_property_on_option_update(p) {
  var attr_id = get_current_attribute_id();
  if ( p.id.startsWith('_via_attribute_option_id_') ) {
    var old_key = p.id.substr( '_via_attribute_option_id_'.length );
    var new_key = p.value;
    if ( old_key !== new_key ) {
      var option_id_test = attribute_property_option_id_is_valid(attr_id, new_key);
      if ( option_id_test.is_valid ) {
        update_attribute_option_id_with_confirm(_via_attribute_being_updated,
                                                attr_id,
                                                old_key,
                                                new_key);
      } else {
        p.value = old_key; // restore old value
        show_message( option_id_test.message );
        show_attribute_properties();
      }
      return;
    }
  }

  if ( p.id.startsWith('_via_attribute_option_description_') ) {
    var key = p.id.substr( '_via_attribute_option_description_'.length );
    var old_value = _via_attributes[_via_attribute_being_updated][attr_id].options[key];
    var new_value = p.value;
    if ( new_value !== old_value ) {
      _via_attributes[_via_attribute_being_updated][attr_id].options[key] = new_value;
      show_attribute_properties();
      annotation_editor_update_content();
    }
  }

  if ( p.id.startsWith('_via_attribute_option_default_') ) {
    var new_default_option_id = p.id.substr( '_via_attribute_option_default_'.length );
    var old_default_option_id_list = Object.keys(_via_attributes[_via_attribute_being_updated][attr_id].default_options);

    if ( old_default_option_id_list.length === 0 ) {
      // default set for the first time
      _via_attributes[_via_attribute_being_updated][attr_id].default_options[new_default_option_id] = p.checked;
    } else {
      switch ( _via_attributes[_via_attribute_being_updated][attr_id].type ) {
      case 'image':    // fallback
      case 'dropdown': // fallback
      case 'radio':    // fallback
        // to ensure that only one radio button is selected at a time
        _via_attributes[_via_attribute_being_updated][attr_id].default_options = {};
        _via_attributes[_via_attribute_being_updated][attr_id].default_options[new_default_option_id] = p.checked;
        break;
      case 'checkbox':
        _via_attributes[_via_attribute_being_updated][attr_id].default_options[new_default_option_id] = p.checked;
        break;
      }
    }
    // default option updated
    attribute_property_on_option_default_update(_via_attribute_being_updated,
                                                attr_id,
                                                new_default_option_id).then( function() {
                                                  show_attribute_properties();
                                                  annotation_editor_update_content();
                                                });
  }
}

function attribute_property_on_option_default_update(attribute_being_updated, attr_id, new_default_option_id) {
  return new Promise( function(ok_callback, err_callback) {
    // set all metadata to new_value if:
    // - metadata[attr_id] is missing
    // - metadata[attr_id] is set to option_old_value
    var img_id, attr_value, n, i;
    var attr_type = _via_attributes[attribute_being_updated][attr_id].type;
    switch( attribute_being_updated ) {
    case 'file':
      for ( img_id in _via_img_metadata ) {
        if ( ! _via_img_metadata[img_id].file_attributes.hasOwnProperty(attr_id) ) {
          _via_img_metadata[img_id].file_attributes[attr_id] = new_default_option_id;
        }
      }
      break;
    case 'region':
      for ( img_id in _via_img_metadata ) {
        n = _via_img_metadata[img_id].regions.length;
        for ( i = 0; i < n; ++i ) {
          if ( ! _via_img_metadata[img_id].regions[i].region_attributes.hasOwnProperty(attr_id) ) {
            _via_img_metadata[img_id].regions[i].region_attributes[attr_id] = new_default_option_id;
          }
        }
      }
      break;
    }
    ok_callback();
  });
}

function attribute_property_on_option_add(p) {
  if ( p.value === '' || p.value === null ) {
    return;
  }

  if ( p.id === '_via_attribute_new_option_id' ) {
    var attr_id = get_current_attribute_id();
    var option_id = p.value;
    var option_id_test = attribute_property_option_id_is_valid(attr_id, option_id);
    if ( option_id_test.is_valid ) {
      _via_attributes[_via_attribute_being_updated][attr_id].options[option_id] = '';
      show_attribute_options();
      annotation_editor_update_content();
    } else {
      show_message( option_id_test.message );
      attribute_property_reset_new_entry_inputs();
    }
  }
}

function attribute_property_reset_new_entry_inputs() {
  var container = document.getElementById('attribute_options');
  var p = container.lastChild;
  console.log(p.childNodes)
  if ( p.childNodes[0] ) {
    p.childNodes[0].value = '';
  }
  if ( p.childNodes[1] ) {
    p.childNodes[1].value = '';
  }
}

function attribute_property_show_new_entry_inputs(attr_id, attribute_type) {
  var n0 = document.createElement('div');
  n0.classList.add('property');
  var n1a = document.createElement('span');
  var n1b = document.createElement('input');
  n1b.setAttribute('onchange', 'attribute_property_on_option_add(this)');
  n1b.setAttribute('placeholder', 'Add new id');
  n1b.setAttribute('value', '');
  n1b.setAttribute('id', '_via_attribute_new_option_id');
  n1a.appendChild(n1b);

  var n2a = document.createElement('span');
  var n2b = document.createElement('input');
  n2b.setAttribute('onchange', 'attribute_property_on_option_add(this)');
  n2b.setAttribute('placeholder', 'Optional description');
  n2b.setAttribute('value', '');
  n2b.setAttribute('id', '_via_attribute_new_option_description');
  n2a.appendChild(n2b);

  var n3a = document.createElement('span');
  var n3b = document.createElement('input');
  n3b.setAttribute('type', attribute_type);
  if ( attribute_type === 'radio' ) {
    n3b.setAttribute('name', attr_id);
  }
  n3b.setAttribute('onchange', 'attribute_property_on_option_add(this)');
  n3b.setAttribute('id', '_via_attribute_new_option_default');
  n3a.appendChild(n3b);

  n0.appendChild(n1a);
  n0.appendChild(n2a);
  n0.appendChild(n3a);

  var container = document.getElementById('attribute_options');
  container.appendChild(n0);
}

function attribute_property_option_id_is_valid(attr_id, new_option_id) {
  var option_id;
  for ( option_id in _via_attributes[_via_attribute_being_updated][attr_id].options ) {
    if ( option_id === new_option_id ) {
      return { 'is_valid':false, 'message':'Option id [' + attr_id + '] already exists' };
    }
  }

  if ( new_option_id.includes('__') ) { // reserved separator for attribute-id, row-id, option-id
    return {'is_valid':false, 'message':'Option id cannot contain two consecutive underscores'};
  }

  return {'is_valid':true};
}

function attribute_property_id_exists(name) {
  var attr_name;
  for ( attr_name in _via_attributes[_via_attribute_being_updated] ) {
    if ( attr_name === name ) {
      return true;
    }
  }
  return false;
}

function delete_existing_attribute_with_confirm() {
  var attr_id = document.getElementById('user_input_attribute_id').value;
  if ( attr_id === '' ) {
    show_message('Enter the name of attribute that you wish to delete');
    return;
  }
  if ( attribute_property_id_exists(attr_id) ) {
    var config = {'title':'Delete ' + _via_attribute_being_updated + ' attribute [' + attr_id + ']' };
    var input = { 'attr_type':{'type':'text', 'name':'Attribute Type', 'value':_via_attribute_being_updated, 'disabled':true},
                  'attr_id':{'type':'text', 'name':'Attribute Id', 'value':attr_id, 'disabled':true}
                };
    invoke_with_user_inputs(delete_existing_attribute_confirmed, input, config);
  } else {
    show_message('Attribute [' + attr_id + '] does not exist!');
    return;
  }
}

function delete_existing_attribute_confirmed(input) {
  var attr_type = input.attr_type.value;
  var attr_id   = input.attr_id.value;
  delete_existing_attribute(attr_type, attr_id);
  document.getElementById('user_input_attribute_id').value = '';
  show_message('Deleted ' + attr_type + ' attribute [' + attr_id + ']');
  user_input_default_cancel_handler();
}

function delete_existing_attribute(attribute_type, attribute_id) {
  if ( _via_attributes[attribute_type].hasOwnProperty( attribute_id ) ) {
    var attr_id_list = Object.keys(_via_attributes[attribute_type]);
    if ( attr_id_list.length === 1 ) {
      _via_current_attribute_id = '';
    } else {
      var current_index = attr_id_list.indexOf(attribute_id);
      var next_index = current_index + 1;
      if ( next_index === attr_id_list.length ) {
        next_index = current_index - 1;
      }
      _via_current_attribute_id = attr_id_list[next_index];
    }
    delete _via_attributes[attribute_type][attribute_id];
    update_attributes_update_panel();
    annotation_editor_update_content();
  }
}

function add_new_attribute_from_user_input() {
  var attr_id = document.getElementById('user_input_attribute_id').value;
  if ( attr_id === '' ) {
    show_message('Enter the name of attribute that you wish to delete');
    return;
  }

  if ( attribute_property_id_exists(attr_id) ) {
    show_message('The ' + _via_attribute_being_updated + ' attribute [' + attr_id + '] already exists.');
  } else {
    _via_current_attribute_id = attr_id;
    add_new_attribute(attr_id);
    update_attributes_update_panel();
    annotation_editor_update_content();
    show_message('Added ' + _via_attribute_being_updated + ' attribute [' + attr_id + '].');
  }
}

function add_new_attribute(attribute_id) {
  _via_attributes[_via_attribute_being_updated][attribute_id] = {};
  _via_attributes[_via_attribute_being_updated][attribute_id].type = 'text';
  _via_attributes[_via_attribute_being_updated][attribute_id].description = '';
  _via_attributes[_via_attribute_being_updated][attribute_id].default_value = '';
}

function update_current_attribute_id(p) {
  _via_current_attribute_id = p.options[p.selectedIndex].value;
  update_attribute_properties_panel();
}

function get_current_attribute_id() {
  return document.getElementById('attributes_name_list').value;
}

function update_attribute_option_id_with_confirm(attr_type, attr_id, option_id, new_option_id) {
  var is_delete = false;
  var config;
  if ( new_option_id === '' || typeof(new_option_id) === 'undefined' ) {
    // an empty new_option_id indicates deletion of option_id
    config = {'title':'Delete an option for ' + attr_type + ' attribute'};
    is_delete = true;
  } else {
    config = {'title':'Rename an option for ' + attr_type + ' attribute'};
  }

  var input = { 'attr_type':{'type':'text', 'name':'Attribute Type', 'value':attr_type, 'disabled':true},
                'attr_id':{'type':'text', 'name':'Attribute Id', 'value':attr_id, 'disabled':true}
              };

  if ( is_delete ) {
    input['option_id'] = {'type':'text', 'name':'Attribute Option', 'value':option_id, 'disabled':true};
  } else {
    input['option_id']     = {'type':'text', 'name':'Attribute Option (old)', 'value':option_id, 'disabled':true},
    input['new_option_id'] = {'type':'text', 'name':'Attribute Option (new)', 'value':new_option_id, 'disabled':true};
  }

  invoke_with_user_inputs(update_attribute_option_id_confirmed, input, config, update_attribute_option_id_cancel);
}

function update_attribute_option_id_cancel(input) {
  update_attribute_properties_panel();
}

function update_attribute_option_id_confirmed(input) {
  var attr_type = input.attr_type.value;
  var attr_id = input.attr_id.value;
  var option_id = input.option_id.value;
  var is_delete;
  var new_option_id;
  if ( typeof(input.new_option_id) === 'undefined' || input.new_option_id === '' ) {
    is_delete = true;
    new_option_id = '';
  } else {
    is_delete = false;
    new_option_id = input.new_option_id.value;
  }

  update_attribute_option(is_delete, attr_type, attr_id, option_id, new_option_id);

  if ( is_delete ) {
    show_message('Deleted option [' + option_id + '] for ' + attr_type + ' attribute [' + attr_id + '].');
  } else {
    show_message('Renamed option [' + option_id + '] to [' + new_option_id + '] for ' + attr_type + ' attribute [' + attr_id + '].');
  }
  update_attribute_properties_panel();
  annotation_editor_update_content();
  user_input_default_cancel_handler();
}

function update_attribute_option(is_delete, attr_type, attr_id, option_id, new_option_id) {
  switch ( attr_type ) {
  case 'region':
    update_region_attribute_option_in_all_metadata(is_delete, attr_id, option_id, new_option_id);
    if ( ! is_delete ) {
      Object.defineProperty(_via_attributes[attr_type][attr_id].options,
                            new_option_id,
                            Object.getOwnPropertyDescriptor(_via_attributes[_via_attribute_being_updated][attr_id].options, option_id));
    }
    delete _via_attributes['region'][attr_id].options[option_id];

    break;
  case 'file':
    update_file_attribute_option_in_all_metadata(attr_id, option_id);
    if ( ! is_delete ) {
      Object.defineProperty(_via_attributes[attr_type][attr_id].options,
                            new_option_id,
                            Object.getOwnPropertyDescriptor(_via_attributes[_via_attribute_being_updated][attr_id].options, option_id));
    }

    delete _via_attributes['file'][attr_id].options[option_id];
    break;
  }
}

function update_file_attribute_option_in_all_metadata(is_delete, attr_id, option_id, new_option_id) {
  var image_id;
  for ( image_id in _via_img_metadata ) {
    if ( _via_img_metadata[image_id].file_attributes.hasOwnProperty(attr_id) ) {
      if ( _via_img_metadata[image_id].file_attributes[attr_id].hasOwnProperty(option_id) ) {
        Object.defineProperty(_via_img_metadata[image_id].file_attributes[attr_id],
                              new_option_id,
                              Object.getOwnPropertyDescriptor(_via_img_metadata[image_id].file_attributes[attr_id], option_id));
        delete _via_img_metadata[image_id].file_attributes[attr_id][option_id];
      }
    }
  }
}

function update_region_attribute_option_in_all_metadata(is_delete, attr_id, option_id, new_option_id) {
  var image_id;
  for ( image_id in _via_img_metadata ) {
    update_region_attribute_option_from_metadata(image_id, is_delete, attr_id, option_id, new_option_id);
  }
}

function update_region_attribute_option_from_metadata(image_id, is_delete, attr_id, option_id, new_option_id) {
  var i;
  for ( i = 0; i < _via_img_metadata[image_id].regions.length; ++i ) {
    if ( _via_img_metadata[image_id].regions[i].region_attributes.hasOwnProperty(attr_id) ) {
      if ( _via_img_metadata[image_id].regions[i].region_attributes[attr_id].hasOwnProperty(option_id) ) {
        Object.defineProperty(_via_img_metadata[image_id].regions[i].region_attributes[attr_id],
                              new_option_id,
                              Object.getOwnPropertyDescriptor(_via_img_metadata[image_id].regions[i].region_attributes[attr_id], option_id));
        delete _via_img_metadata[image_id].regions[i].region_attributes[attr_id][option_id];
      }
    }
  }
}

function delete_file_attribute_option_from_all_metadata(attr_id, option_id) {
  var image_id;
  for ( image_id in _via_img_metadata ) {
    if ( _via_img_metadata.hasOwnProperty(image_id) ) {
      delete_file_attribute_option_from_metadata(image_id, attr_id, option_id);
    }
  }
}

function delete_file_attribute_option_from_metadata(image_id, attr_id, option_id) {
  var i;
  if ( _via_img_metadata[image_id].file_attributes.hasOwnProperty(attr_id) ) {
    if ( _via_img_metadata[image_id].file_attributes[attr_id].hasOwnProperty(option_id) ) {
      delete _via_img_metadata[image_id].file_attributes[attr_id][option_id];
    }
  }
}

function delete_file_attribute_from_all_metadata(image_id, attr_id) {
  var image_id;
  for ( image_id in _via_img_metadata ) {
    if ( _via_img_metadata.hasOwnProperty(image_id) ) {
      if ( _via_img_metadata[image_id].file_attributes.hasOwnProperty(attr_id) ) {
        delete _via_img_metadata[image_id].file_attributes[attr_id];
      }
    }
  }
}

//
// invoke a method after receiving inputs from user
//
function invoke_with_user_inputs(ok_handler, input, config, cancel_handler) {
  setup_user_input_panel(ok_handler, input, config, cancel_handler);
  show_user_input_panel();
}

function setup_user_input_panel(ok_handler, input, config, cancel_handler) {
  // create html page with OK and CANCEL button
  // when OK is clicked
  //  - setup input with all the user entered values
  //  - invoke handler with input
  // when CANCEL is clicked
  //  - invoke user_input_cancel()
  _via_user_input_ok_handler = ok_handler;
  _via_user_input_cancel_handler = cancel_handler;
  _via_user_input_data = input;

  var p = document.getElementById('user_input_panel');
  var c = document.createElement('div');
  c.setAttribute('class', 'content');
  var html = [];
  html.push('<p class="title">' + config.title + '</p>');

  html.push('<div class="user_inputs">');
  var key;
  for ( key in _via_user_input_data ) {
    html.push('<div class="row">');
    html.push('<span class="cell">' + _via_user_input_data[key].name + '</span>');
    var disabled_html = '';
    if ( _via_user_input_data[key].disabled ) {
      disabled_html = 'disabled="disabled"';
    }
    var value_html = '';
    if ( _via_user_input_data[key].value ) {
      value_html = 'value="' + _via_user_input_data[key].value + '"';
    }

    switch(_via_user_input_data[key].type) {
    case 'checkbox':
      if ( _via_user_input_data[key].checked ) {
        value_html = 'checked="checked"';
      } else {
        value_html = '';
      }
      html.push('<span class="cell">' +
                '<input class="_via_user_input_variable" ' +
                value_html + ' ' +
                disabled_html + ' ' +
                'type="checkbox" id="' + key + '"></span>');
      break;
    case 'text':
      var size = '50';
      if ( _via_user_input_data[key].size ) {
        size = _via_user_input_data[key].size;
      }
      var placeholder = '';
      if ( _via_user_input_data[key].placeholder ) {
        placeholder = _via_user_input_data[key].placeholder;
      }
      html.push('<span class="cell">' +
                '<input class="_via_user_input_variable" ' +
                value_html + ' ' +
                disabled_html + ' ' +
                'size="' + size + '" ' +
                'placeholder="' + placeholder + '" ' +
                'type="text" id="' + key + '"></span>');

      break;
    case 'textarea':
      var rows = '5';
      var cols = '50'
      if ( _via_user_input_data[key].rows ) {
        rows = _via_user_input_data[key].rows;
      }
      if ( _via_user_input_data[key].cols ) {
        cols = _via_user_input_data[key].cols;
      }
      var placeholder = '';
      if ( _via_user_input_data[key].placeholder ) {
        placeholder = _via_user_input_data[key].placeholder;
      }
      html.push('<span class="cell">' +
                '<textarea class="_via_user_input_variable" ' +
                disabled_html + ' ' +
                'rows="' + rows + '" ' +
                'cols="' + cols + '" ' +
                'placeholder="' + placeholder + '" ' +
                'id="' + key + '">' + value_html + '</textarea></span>');

      break;

    }
    html.push('</div>'); // end of row
  }
  html.push('</div>'); // end of user_input div
  html.push('<div class="user_confirm">' +
            '<span class="ok">' +
            '<button id="user_input_ok_button" onclick="user_input_parse_and_invoke_handler()">&nbsp;OK&nbsp;</button></span>' +
            '<span class="cancel">' +
            '<button id="user_input_cancel_button" onclick="user_input_cancel_handler()">CANCEL</button></span></div>');
  c.innerHTML = html.join('');
  p.innerHTML = '';
  p.appendChild(c);

}

function user_input_default_cancel_handler() {
  hide_user_input_panel();
  _via_user_input_data = {};
  _via_user_input_ok_handler = null;
  _via_user_input_cancel_handler = null;
}

function user_input_cancel_handler() {
  if ( _via_user_input_cancel_handler ) {
    _via_user_input_cancel_handler();
  }
  user_input_default_cancel_handler();
}

function user_input_parse_and_invoke_handler() {
  var elist = document.getElementsByClassName('_via_user_input_variable');
  var i;
  for ( i=0; i < elist.length; ++i ) {
    var eid = elist[i].id;
    if ( _via_user_input_data.hasOwnProperty(eid) ) {
      switch(_via_user_input_data[eid].type) {
      case 'checkbox':
        _via_user_input_data[eid].value = elist[i].checked;
        break;
      default:
        _via_user_input_data[eid].value = elist[i].value;
        break;
      }
    }
  }
  if ( typeof(_via_user_input_data.confirm) !== 'undefined' ) {
    if ( _via_user_input_data.confirm.value ) {
      _via_user_input_ok_handler(_via_user_input_data);
    } else {
      if ( _via_user_input_cancel_handler ) {
        _via_user_input_cancel_handler();
      }
    }
  } else {
    _via_user_input_ok_handler(_via_user_input_data);
  }
  user_input_default_cancel_handler();
}

function show_user_input_panel() {
  document.getElementById('user_input_panel').style.display = 'block';
}

function hide_user_input_panel() {
  document.getElementById('user_input_panel').style.display = 'none';
}

//
// annotations editor panel
//
function annotation_editor_show() {
  // remove existing annotation editor (if any)
  annotation_editor_remove();

  // create new container of annotation editor
  var ae = document.createElement('div');
  ae.setAttribute('id', 'annotation_editor');

  if ( _via_annotation_editor_mode === VIA_ANNOTATION_EDITOR_MODE.SINGLE_REGION ) {
    if ( _via_settings.ui.image.on_image_annotation_editor_placement === VIA_ANNOTATION_EDITOR_PLACEMENT.DISABLE ) {
      return;
    }

    // only display on-image annotation editor if
    // - region attribute are defined
    // - region is selected
    if ( _via_is_region_selected &&
         Object.keys(_via_attributes['region']).length &&
         _via_attributes['region'].constructor === Object ) {
      ae.classList.add('force_small_font');
      ae.classList.add('display_area_content'); // to enable automatic hiding of this content
      // add annotation editor to image_panel
      if ( _via_settings.ui.image.on_image_annotation_editor_placement === VIA_ANNOTATION_EDITOR_PLACEMENT.NEAR_REGION ) {
        var html_position = annotation_editor_get_placement(_via_user_sel_region_id);
        ae.style.top = html_position.top;
        ae.style.left = html_position.left;
      }
      _via_display_area.appendChild(ae);
      annotation_editor_update_content();
      update_vertical_space();
    }
  } else {
    // show annotation editor in a separate panel at the bottom
    _via_annotaion_editor_panel.appendChild(ae);
    annotation_editor_update_content();
    update_vertical_space();

    if ( _via_is_region_selected ) {
      // highlight entry for region_id in annotation editor panel
      annotation_editor_scroll_to_row(_via_user_sel_region_id);
      annotation_editor_highlight_row(_via_user_sel_region_id);
    }
  }
}

function annotation_editor_hide() {
  if ( _via_annotation_editor_mode === VIA_ANNOTATION_EDITOR_MODE.SINGLE_REGION ) {
    // remove existing annotation editor (if any)
    annotation_editor_remove();
  } else {
    annotation_editor_clear_row_highlight();
  }
}

function annotation_editor_toggle_on_image_editor() {
  if ( _via_settings.ui.image.on_image_annotation_editor_placement === VIA_ANNOTATION_EDITOR_PLACEMENT.DISABLE ) {
    _via_annotation_editor_mode = VIA_ANNOTATION_EDITOR_MODE.SINGLE_REGION;
    _via_settings.ui.image.on_image_annotation_editor_placement = VIA_ANNOTATION_EDITOR_PLACEMENT.NEAR_REGION;
    annotation_editor_show();
    show_message('Enabled on image annotation editor');
  } else {
    _via_settings.ui.image.on_image_annotation_editor_placement = VIA_ANNOTATION_EDITOR_PLACEMENT.DISABLE;
    _via_annotation_editor_mode === VIA_ANNOTATION_EDITOR_MODE.ALL_REGIONS;
    annotation_editor_hide();
    show_message('Disabled on image annotation editor');
  }
}

function annotation_editor_update_content() {
  return new Promise( function(ok_callback, err_callback) {
    var ae = document.getElementById('annotation_editor');
    if (ae ) {
      ae.innerHTML = '';
      annotation_editor_update_header_html();
      annotation_editor_update_metadata_html();
    }
    ok_callback();
  });
}

function annotation_editor_get_placement(region_id) {
  var html_position = {};
  var r = _via_canvas_regions[region_id]['shape_attributes'];
  var shape = r['name'];
  switch( shape ) {
  case 'rect':
    html_position.top = r['y'] + r['height'];
    html_position.left = r['x'] + r['width'];
    break;
  case 'circle':
    html_position.top = r['cy'] + r['r'];
    html_position.left = r['cx'];
    break;
  case 'ellipse':
    html_position.top = r['cy'] + r['ry'] * Math.cos(r['theta']);
    html_position.left = r['cx'] - r['ry'] * Math.sin(r['theta']);
    break;
  case 'polygon':
  case 'polyline':
    var most_left =
      Object.keys(r['all_points_x']).reduce(function(a, b){
        return r['all_points_x'][a] > r['all_points_x'][b] ? a : b });
    html_position.top  = Math.max( r['all_points_y'][most_left] );
    html_position.left = Math.max( r['all_points_x'][most_left] );
    break;
  case 'point':
    html_position.top = r['cy'];
    html_position.left = r['cx'];
    break;
  }
  html_position.top  = html_position.top + _via_img_panel.offsetTop + VIA_REGION_EDGE_TOL + 'px';
  html_position.left = html_position.left + _via_img_panel.offsetLeft + VIA_REGION_EDGE_TOL + 'px';
  return html_position;
}

function annotation_editor_remove() {
  var p = document.getElementById('annotation_editor');
  if ( p ) {
    p.remove();
  }
}

function is_annotation_editor_visible() {
  return document.getElementById('annotation_editor_panel').classList.contains('display_block');
}

function annotation_editor_toggle_all_regions_editor() {
  var p = document.getElementById('annotation_editor_panel');
  if ( p.classList.contains('display_block') ) {
    p.classList.remove('display_block');
    _via_annotation_editor_mode = VIA_ANNOTATION_EDITOR_MODE.SINGLE_REGION;
  } else {
    _via_annotation_editor_mode = VIA_ANNOTATION_EDITOR_MODE.ALL_REGIONS;
    p.classList.add('display_block');
    p.style.height = _via_settings.ui.annotation_editor_height + '%';
    p.style.fontSize = _via_settings.ui.annotation_editor_fontsize + 'rem';
    annotation_editor_show();
  }
}

function annotation_editor_set_active_button() {
  var attribute_type;
  for ( attribute_type in _via_attributes ) {
    var bid = 'button_edit_' + attribute_type + '_metadata';
    document.getElementById(bid).classList.remove('active');
  }
  var bid = 'button_edit_' + _via_metadata_being_updated + '_metadata';
  document.getElementById(bid).classList.add('active');
}

function edit_region_metadata_in_annotation_editor() {
  _via_metadata_being_updated = 'region';
  annotation_editor_set_active_button();
  annotation_editor_update_content();
}
function edit_file_metadata_in_annotation_editor() {
  _via_metadata_being_updated = 'file';
  annotation_editor_set_active_button();
  annotation_editor_update_content();
}

function annotation_editor_update_header_html() {
  var head = document.createElement('div');
  head.setAttribute('class', 'row');
  head.setAttribute('id', 'annotation_editor_header');

  if ( _via_metadata_being_updated === 'region' ) {
    var rid_col = document.createElement('span');
    rid_col.setAttribute('class', 'col');
    rid_col.innerHTML = '';
    head.appendChild(rid_col);
  }

  if ( _via_metadata_being_updated === 'file' ) {
    var rid_col = document.createElement('span');
    rid_col.setAttribute('class', 'col header');
    if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
      rid_col.innerHTML = 'group';
    } else {
      rid_col.innerHTML = 'filename';
    }
    head.appendChild(rid_col);
  }

  var attr_id;
  for ( attr_id in _via_attributes[_via_metadata_being_updated] ) {
    var col = document.createElement('span');
    col.setAttribute('class', 'col header');
    col.innerHTML = attr_id;
    head.appendChild(col);
  }

  var ae = document.getElementById('annotation_editor');
  if ( ae.childNodes.length === 0 ) {
    ae.appendChild(head);
  } else {
    if ( ae.firstChild.id === 'annotation_editor_header') {
      ae.replaceChild(head, ae.firstChild);
    } else {
      // header node is absent
      ae.insertBefore(head, ae.firstChild);
    }
  }
}

function annotation_editor_update_metadata_html() {
  if ( ! _via_img_count ) {
    return;
  }

  var ae = document.getElementById('annotation_editor');
  switch ( _via_metadata_being_updated ) {
  case 'region':
    var rindex;
    if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
      ae.appendChild( annotation_editor_get_metadata_row_html(0) );
    } else {
      if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE ) {
        if ( _via_annotation_editor_mode === VIA_ANNOTATION_EDITOR_MODE.SINGLE_REGION ) {
          ae.appendChild( annotation_editor_get_metadata_row_html(_via_user_sel_region_id) );
        } else {
          for ( rindex = 0; rindex < _via_img_metadata[_via_image_id].regions.length; ++rindex ) {
            ae.appendChild( annotation_editor_get_metadata_row_html(rindex) );
          }
        }
      }
    }
    break;

  case 'file':
    ae.appendChild( annotation_editor_get_metadata_row_html(0) );
    break;
  }
}

function annotation_editor_update_row(row_id) {
  var ae = document.getElementById('annotation_editor');

  var new_row = annotation_editor_get_metadata_row_html(row_id);
  var old_row = document.getElementById(new_row.getAttribute('id'));
  ae.replaceChild(new_row, old_row);
}

function annotation_editor_add_row(row_id) {
  if ( is_annotation_editor_visible() ) {
    var ae = document.getElementById('annotation_editor');
    var new_row = annotation_editor_get_metadata_row_html(row_id);
    var penultimate_row_id = parseInt(row_id) - 1;
    if ( penultimate_row_id >= 0 ) {
      var penultimate_row_html_id = 'ae_' + _via_metadata_being_updated + '_' + penultimate_row_id;
      var penultimate_row = document.getElementById(penultimate_row_html_id);
      ae.insertBefore(new_row, penultimate_row.nextSibling);
    } else {
      ae.appendChild(new_row);
    }
  }
}

function annotation_editor_get_metadata_row_html(row_id) {
  var row = document.createElement('div');
  row.setAttribute('class', 'row');
  row.setAttribute('id', 'ae_' + _via_metadata_being_updated + '_' + row_id);

  if ( _via_metadata_being_updated === 'region' ) {
    var rid = document.createElement('span');

    switch(_via_display_area_content_name) {
    case VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID:
      rid.setAttribute('class', 'col');
      rid.innerHTML = 'Grouped regions in ' + _via_image_grid_selected_img_index_list.length + ' files';
      break;
    case VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE:
      rid.setAttribute('class', 'col id');
      rid.innerHTML = (row_id + 1);
      break;
    }
    row.appendChild(rid);
  }

  if ( _via_metadata_being_updated === 'file' ) {
    var rid = document.createElement('span');
    rid.setAttribute('class', 'col');
    switch(_via_display_area_content_name) {
    case VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID:
      rid.innerHTML = 'Group of ' + _via_image_grid_selected_img_index_list.length + ' files';
      break;
    case VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE:
      rid.innerHTML = _via_image_filename_list[_via_image_index];
      break;
    }

    row.appendChild(rid);
  }

  var attr_id;
  for ( attr_id in _via_attributes[_via_metadata_being_updated] ) {
    var col = document.createElement('span');
    col.setAttribute('class', 'col');

    var attr_type    = _via_attributes[_via_metadata_being_updated][attr_id].type;
    var attr_desc    = _via_attributes[_via_metadata_being_updated][attr_id].desc;
    if ( typeof(attr_desc) === 'undefined' ) {
      attr_desc = '';
    }
    var attr_html_id = attr_id + '__' + row_id;

    var attr_value = '';
    var attr_placeholder = '';
    if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE ) {
      switch(_via_metadata_being_updated) {
      case 'region':
        if ( _via_img_metadata[_via_image_id].regions[row_id].region_attributes.hasOwnProperty(attr_id) ) {
          attr_value = _via_img_metadata[_via_image_id].regions[row_id].region_attributes[attr_id];
        } else {
          attr_placeholder = 'not defined yet!';
        }
      case 'file':
        if ( _via_img_metadata[_via_image_id].file_attributes.hasOwnProperty(attr_id) ) {
          attr_value = _via_img_metadata[_via_image_id].file_attributes[attr_id];
        } else {
          attr_placeholder = 'not defined yet!';
        }
      }
    }

    if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
      var attr_metadata_stat;
      switch(_via_metadata_being_updated) {
      case 'region':
        attr_metadata_stat = _via_get_region_metadata_stat(_via_image_grid_selected_img_index_list, attr_id);
        break;
      case 'file':
        attr_metadata_stat = _via_get_file_metadata_stat(_via_image_grid_selected_img_index_list, attr_id);
        break;
      }

      switch ( attr_type ) {
      case 'text':
        if ( attr_metadata_stat.hasOwnProperty(attr_id) ) {
          var attr_value_set = Object.keys(attr_metadata_stat[attr_id]);
          if ( attr_value_set.includes('undefined') ) {
            attr_value = '';
            attr_placeholder = 'includes ' + attr_metadata_stat[attr_id]['undefined'] + ' undefined values';
          } else {
            switch( attr_value_set.length ) {
            case 0:
              attr_value = '';
              attr_placeholder = 'not applicable';
              break;
            case 1:
              attr_value = attr_value_set[0];
              attr_placeholder = '';
              break;
            default:
              attr_value = '';
              attr_placeholder = attr_value_set.length + ' different values: ' + JSON.stringify(attr_value_set).replace(/"/g,'\'');
              console.log(JSON.stringify(attr_value_set))
            }
          }
        } else {
          attr_value = '';
          attr_placeholder = 'not defined yet!';
        }
        break;

      case 'radio':    // fallback
      case 'dropdown': // fallback
      case 'image':    // fallback
        if ( attr_metadata_stat.hasOwnProperty(attr_id) ) {
          var attr_value_set = Object.keys(attr_metadata_stat[attr_id]);
          if ( attr_value_set.length === 1 ) {
            attr_value = attr_value_set[0];
          } else {
            attr_value = '';
          }
        } else {
          attr_value = '';
        }
        break;

      case 'checkbox':
        attr_value = {};
        if ( attr_metadata_stat.hasOwnProperty(attr_id) ) {
          var attr_value_set = Object.keys(attr_metadata_stat[attr_id]);
          var same_count = true;
          var i, n;
          var attr_value_curr, attr_value_next;
          n = attr_value_set.length;
          for ( i = 0; i < n - 1; ++i ) {
            attr_value_curr = attr_value_set[i];
            attr_value_next = attr_value_set[i+1];

            if ( attr_metadata_stat[attr_id][attr_value_curr] !== attr_metadata_stat[attr_id][attr_value_next] ) {
              same_count = false;
              break;
            }
          }
          if ( same_count ) {
            var attr_value_i;
            for ( attr_value_i in attr_metadata_stat[attr_id] ) {
              attr_value[attr_value_i] = true;
            }
          }
        }
        break;
      }
    }

    switch(attr_type) {
    case 'text':
      col.innerHTML = '<textarea ' +
        'onchange="annotation_editor_on_metadata_update(this)" ' +
        'onfocus="annotation_editor_on_metadata_focus(this)" ' +
        'title="' + attr_desc + '" ' +
        'placeholder="' + attr_placeholder + '" ' +
        'id="' + attr_html_id + '">' + attr_value + '</textarea>';
      break;
    case 'checkbox':
      var options = _via_attributes[_via_metadata_being_updated][attr_id].options;
      var option_id;
      for ( option_id in options ) {
        var option_html_id = attr_html_id + '__' + option_id;
        var option = document.createElement('input');
        option.setAttribute('type', 'checkbox');
        option.setAttribute('value', option_id);
        option.setAttribute('id', option_html_id);
        option.setAttribute('onfocus', 'annotation_editor_on_metadata_focus(this)');
        option.setAttribute('onchange', 'annotation_editor_on_metadata_update(this)');

        var option_desc  = _via_attributes[_via_metadata_being_updated][attr_id].options[option_id];
        if ( option_desc === '' || typeof(option_desc) === 'undefined' ) {
          // option description is optional, use option_id when description is not present
          option_desc = option_id;
        }

        // set the value of options based on the user annotations
        if ( typeof attr_value !== 'undefined') {
          if ( attr_value.hasOwnProperty(option_id) ) {
            option.checked = attr_value[option_id];
          }
        }

        var label  = document.createElement('label');
        label.setAttribute('for', option_html_id);
        label.innerHTML = option_desc;

        var container = document.createElement('span');
        container.appendChild(option);
        container.appendChild(label);
        col.appendChild(container);
      }
      break;
    case 'radio':
      var option_id;
      for ( option_id in _via_attributes[_via_metadata_being_updated][attr_id].options ) {
        var option_html_id = attr_html_id + '__' + option_id;
        var option = document.createElement('input');
        option.setAttribute('type', 'radio');
        option.setAttribute('name', attr_html_id);
        option.setAttribute('value', option_id);
        option.setAttribute('id', option_html_id);
        option.setAttribute('onfocus', 'annotation_editor_on_metadata_focus(this)');
        option.setAttribute('onchange', 'annotation_editor_on_metadata_update(this)');

        var option_desc  = _via_attributes[_via_metadata_being_updated][attr_id].options[option_id];
        if ( option_desc === '' || typeof(option_desc) === 'undefined' ) {
          // option description is optional, use option_id when description is not present
          option_desc = option_id;
        }

        if ( attr_value === option_id ) {
          option.checked = true;
        }

        var label  = document.createElement('label');
        label.setAttribute('for', option_html_id);
        label.innerHTML = option_desc;

        var container = document.createElement('span');
        container.appendChild(option);
        container.appendChild(label);
        col.appendChild(container);
      }
      break;
    case 'image':
      var option_id;
      var option_count = 0;
      for ( option_id in _via_attributes[_via_metadata_being_updated][attr_id].options ) {
        option_count = option_count + 1;
      }
      var img_options = document.createElement('div');
      img_options.setAttribute('class', 'img_options');
      col.appendChild(img_options);

      var option_index = 0;
      for ( option_id in _via_attributes[_via_metadata_being_updated][attr_id].options ) {
        var option_html_id = attr_html_id + '__' + option_id;
        var option = document.createElement('input');
        option.setAttribute('type', 'radio');
        option.setAttribute('name', attr_html_id);
        option.setAttribute('value', option_id);
        option.setAttribute('id', option_html_id);
        option.setAttribute('onfocus', 'annotation_editor_on_metadata_focus(this)');
        option.setAttribute('onchange', 'annotation_editor_on_metadata_update(this)');

        var option_desc  = _via_attributes[_via_metadata_being_updated][attr_id].options[option_id];
        if ( option_desc === '' || typeof(option_desc) === 'undefined' ) {
          // option description is optional, use option_id when description is not present
          option_desc = option_id;
        }

        if ( attr_value === option_id ) {
          option.checked = true;
        }

        var label  = document.createElement('label');
        label.setAttribute('for', option_html_id);
        label.innerHTML = '<img src="' + option_desc + '"><p>' + option_id + '</p>';

        var container = document.createElement('span');
        container.appendChild(option);
        container.appendChild(label);
        img_options.appendChild(container);
      }
      break;

    case 'dropdown':
      var sel = document.createElement('select');
      sel.setAttribute('id', attr_html_id);
      sel.setAttribute('onfocus', 'annotation_editor_on_metadata_focus(this)');
      sel.setAttribute('onchange', 'annotation_editor_on_metadata_update(this)');
      var option_id;
      var option_selected = false;
      for ( option_id in _via_attributes[_via_metadata_being_updated][attr_id].options ) {
        var option_html_id = attr_html_id + '__' + option_id;
        var option = document.createElement('option');
        option.setAttribute('value', option_id);

        var option_desc  = _via_attributes[_via_metadata_being_updated][attr_id].options[option_id];
        if ( option_desc === '' || typeof(option_desc) === 'undefined' ) {
          // option description is optional, use option_id when description is not present
          option_desc = option_id;
        }

        if ( option_id === attr_value ) {
          option.setAttribute('selected', 'selected');
          option_selected = true;
        }
        option.innerHTML = option_desc;
        sel.appendChild(option);
      }

      if ( ! option_selected ) {
        sel.selectedIndex = '-1';
      }
      col.appendChild(sel);
      break;
    }

    row.appendChild(col);
  }
  return row;
}

function annotation_editor_scroll_to_row(row_id) {
  if ( is_annotation_editor_visible() ) {
    var row_html_id = 'ae_' + _via_metadata_being_updated + '_' + row_id;
    var row = document.getElementById(row_html_id);
    row.scrollIntoView(false);
  }
}

function annotation_editor_highlight_row(row_id) {
  if ( is_annotation_editor_visible() ) {
    var row_html_id = 'ae_' + _via_metadata_being_updated + '_' + row_id;
    var row = document.getElementById(row_html_id);
    row.classList.add('highlight');
  }
}

function annotation_editor_clear_row_highlight() {
  if ( is_annotation_editor_visible() ) {
    var ae = document.getElementById('annotation_editor');
    var i;
    for ( i=0; i<ae.childNodes.length; ++i ) {
      ae.childNodes[i].classList.remove('highlight');
    }
  }
}

function annotation_editor_extract_html_id_components(html_id) {
  // html_id : attribute_name__row-id__option_id
  var parts = html_id.split('__');
  var parsed_id = {};
  switch( parts.length ) {
  case 3:
    // html_id : attribute-id__row-id__option_id
    parsed_id.attr_id = parts[0];
    parsed_id.row_id  = parts[1];
    parsed_id.option_id = parts[2];
    break;
  case 2:
    // html_id : attribute-id__row-id
    parsed_id.attr_id = parts[0];
    parsed_id.row_id  = parts[1];
    break;
  default:
  }
  return parsed_id;
}

function _via_get_file_metadata_stat(img_index_list, attr_id) {
  var stat = {};
  stat[attr_id] = {};
  var i, n, img_id, img_index, value;
  n = img_index_list.length;
  for ( i = 0; i < n; ++i ) {
    img_index = img_index_list[i];
    img_id = _via_image_id_list[img_index];
    if ( _via_img_metadata[img_id].file_attributes.hasOwnProperty(attr_id) ) {
      value = _via_img_metadata[img_id].file_attributes[attr_id];
      if ( typeof(value) === 'object' ) {
        // checkbox has multiple values and hence is object
        var key;
        for ( key in value ) {
          if ( stat[attr_id].hasOwnProperty(key) ) {
            stat[attr_id][key] += 1;
          } else {
            stat[attr_id][key] = 1;
          }
        }
      } else {
        if ( stat[attr_id].hasOwnProperty(value) ) {
          stat[attr_id][value] += 1;
        } else {
          stat[attr_id][value] = 1;
        }
      }
    }

  }
  return stat;
}

function _via_get_region_metadata_stat(img_index_list, attr_id) {
  var stat = {};
  stat[attr_id] = {};
  var i, n, img_id, img_index, value;
  var j, m;
  n = img_index_list.length;
  for ( i = 0; i < n; ++i ) {
    img_index = img_index_list[i];
    img_id = _via_image_id_list[img_index];
    m = _via_img_metadata[img_id].regions.length;
    for ( j = 0; j < m; ++j ) {
      if ( ! image_grid_is_region_in_current_group( _via_img_metadata[img_id].regions[j].region_attributes ) ) {
        // skip region not in current group
        continue;
      }

      value = _via_img_metadata[img_id].regions[j].region_attributes[attr_id];
      if ( typeof(value) === 'object' ) {
        // checkbox has multiple values and hence is object
        var key;
        for ( key in value ) {
          if ( stat[attr_id].hasOwnProperty(key) ) {
            stat[attr_id][key] += 1;
          } else {
            stat[attr_id][key] = 1;
          }
        }
      } else {
        if ( stat[attr_id].hasOwnProperty(value) ) {
          stat[attr_id][value] += 1;
        } else {
          stat[attr_id][value] = 1;
        }
      }
    }
  }
  return stat;
}

// invoked when the input entry in annotation editor receives focus
function annotation_editor_on_metadata_focus(p) {
  if ( _via_annotation_editor_mode === VIA_ANNOTATION_EDITOR_MODE.ALL_REGIONS ) {
    var pid       = annotation_editor_extract_html_id_components(p.id);
    var region_id = pid.row_id;
    // clear existing highlights (if any)
    toggle_all_regions_selection(false);
    annotation_editor_clear_row_highlight();
    // set new selection highlights
    set_region_select_state(region_id, true);
    annotation_editor_scroll_to_row(region_id);
    annotation_editor_highlight_row(region_id);

    _via_redraw_reg_canvas();
  }
}

// invoked when the user updates annotations using the annotation editor
function annotation_editor_on_metadata_update(p) {
  var pid       = annotation_editor_extract_html_id_components(p.id);
  var img_id    = _via_image_id;

  var img_index_list = [ _via_image_index ];
  var region_id = pid.row_id;
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    img_index_list = _via_image_grid_selected_img_index_list.slice(0);
    region_id = -1; // this flag denotes that we want to update all regions
  }

  if ( _via_metadata_being_updated === 'file' ) {
    annotation_editor_update_file_metadata(img_index_list, pid.attr_id, p.value, p.checked).then( function(update_count) {
      annotation_editor_on_metadata_update_done('file', pid.attr_id, update_count);
    }, function(err) {
      console.log(err)
      show_message('Failed to update file attributes! ' + err);
    });
    return;
  }

  if ( _via_metadata_being_updated === 'region' ) {
    annotation_editor_update_region_metadata(img_index_list, region_id, pid.attr_id, p.value, p.checked).then( function(update_count) {
      annotation_editor_on_metadata_update_done('region', pid.attr_id, update_count);
    }, function(err) {
      show_message('Failed to update region attributes! ');
    });
    return;
  }
}

function annotation_editor_on_metadata_update_done(type, attr_id, update_count) {
  show_message('Updated ' + type + ' attributes of ' + update_count + ' ' + type + 's');
  // check if the updated attribute is one of the group variables
  var i, n, type, attr_id;
  n = _via_image_grid_group_var.length;
  var clear_all_group = false;
  for ( i = 0; i < n; ++i ) {
    if ( _via_image_grid_group_var[i].type === type &&
         _via_image_grid_group_var[i].name === attr_id ) {
      clear_all_group = true;
      break;
    }
  }
  _via_regions_group_color_init();
  _via_redraw_reg_canvas();

  // @todo: it is wasteful to cancel the full set of groups.
  // we should only cancel the groups that are affected by this update.
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    if ( clear_all_group ) {
      image_grid_show_all_project_images();
    }
  }
}

function annotation_editor_update_file_metadata(img_index_list, attr_id, new_value, new_checked) {
  return new Promise( function(ok_callback, err_callback) {
    var i, n, img_id, img_index;
    n = img_index_list.length;
    var update_count = 0;
    for ( i = 0; i < n; ++i ) {
      img_index = img_index_list[i];
      img_id = _via_image_id_list[img_index];

      switch( _via_attributes['file'][attr_id].type ) {
      case 'text':  // fallback
      case 'radio': // fallback
      case 'dropdown': // fallback
      case 'image':
        _via_img_metadata[img_id].file_attributes[attr_id] = new_value;
        update_count += 1;
        break;

      case 'checkbox':
        var option_id = new_value;
        console.log('option_id='+option_id)
        console.log('attr_id='+attr_id)
        console.log('img_id='+img_id)
        console.log(_via_img_metadata[img_id].file_attributes)
        console.log(_via_attributes['file'][attr_id])
        if ( _via_img_metadata[img_id].file_attributes.hasOwnProperty(attr_id) ) {
          if ( typeof(_via_img_metadata[img_id].file_attributes[attr_id]) !== 'object' ) {
            var old_value = _via_img_metadata[img_id].file_attributes[attr_id];
            _via_img_metadata[img_id].file_attributes[attr_id] = {};
            if ( Object.keys(_via_attributes['file'][attr_id]['options']).includes(old_value) ) {
              // transform existing value as checkbox option
              _via_img_metadata[img_id].file_attributes[attr_id] = {};
              _via_img_metadata[img_id].file_attributes[attr_id][old_value] = true;
            }
          }
        } else {
          _via_img_metadata[img_id].file_attributes[attr_id] = {};
        }

        console.log(_via_img_metadata[img_id].file_attributes[attr_id])
        console.log(new_checked)
        console.log(new_value)
        if ( new_checked ) {
          _via_img_metadata[img_id].file_attributes[attr_id][option_id] = true;
        } else {
          // false option values are not stored
          delete _via_img_metadata[img_id].file_attributes[attr_id][option_id];
        }
        update_count += 1;
        break;
      }
    }
    ok_callback(update_count);
  });
}

function annotation_editor_update_region_metadata(img_index_list, region_id, attr_id, new_value, new_checked) {
  return new Promise( function(ok_callback, err_callback) {
    var i, n, img_id, img_index;
    n = img_index_list.length;
    var update_count = 0;
    var region_list = [];
    var j, m;

    if ( region_id === -1 ) {
      // update all regions on a file (for image grid view)
      for ( i = 0; i < n; ++i ) {
        img_index = img_index_list[i];
        img_id = _via_image_id_list[img_index];

        m = _via_img_metadata[img_id].regions.length;
        for ( j = 0; j < m; ++j ) {
          if ( ! image_grid_is_region_in_current_group( _via_img_metadata[img_id].regions[j].region_attributes ) ) {
            continue;
          }

          switch( _via_attributes['region'][attr_id].type ) {
          case 'text':  // fallback
          case 'dropdown': // fallback
          case 'radio': // fallback
          case 'image':
            _via_img_metadata[img_id].regions[j].region_attributes[attr_id] = new_value;
            update_count += 1;
            break;
          case 'checkbox':
            var option_id = new_value;
            if ( _via_img_metadata[img_id].regions[j].region_attributes.hasOwnProperty(attr_id) ) {
              if ( typeof(_via_img_metadata[img_id].regions[j].region_attributes[attr_id]) !== 'object' ) {
                var old_value = _via_img_metadata[img_id].regions[j].region_attributes[attr_id];
                _via_img_metadata[img_id].regions[j].region_attributes[attr_id] = {}
                if ( Object.keys(_via_attributes['region'][attr_id]['options']).includes(old_value) ) {
                  // transform existing value as checkbox option
                  _via_img_metadata[img_id].regions[j].region_attributes[attr_id][old_value] = true;
                }
              }
            } else {
              _via_img_metadata[img_id].regions[j].region_attributes[attr_id] = {};
            }

            if ( new_checked ) {
              _via_img_metadata[img_id].regions[j].region_attributes[attr_id][option_id] = true;
            } else {
              // false option values are not stored
              delete _via_img_metadata[img_id].regions[j].region_attributes[attr_id][option_id];
            }
            update_count += 1;
            break;
          }
        }
      }
    } else {
      // update a single region in a file (for single image view)
      // update all regions on a file (for image grid view)
      for ( i = 0; i < n; ++i ) {
        img_index = img_index_list[i];
        img_id = _via_image_id_list[img_index];

        switch( _via_attributes['region'][attr_id].type ) {
        case 'text':  // fallback
        case 'dropdown': // fallback
        case 'radio': // fallback
        case 'image':
          _via_img_metadata[img_id].regions[region_id].region_attributes[attr_id] = new_value;
          update_count += 1;
          break;
        case 'checkbox':
          var option_id = new_value;

          if ( _via_img_metadata[img_id].regions[region_id].region_attributes.hasOwnProperty(attr_id) ) {
            if ( typeof(_via_img_metadata[img_id].regions[region_id].region_attributes[attr_id]) !== 'object' ) {
              var old_value = _via_img_metadata[img_id].regions[region_id].region_attributes[attr_id];
              _via_img_metadata[img_id].regions[region_id].region_attributes[attr_id] = {};
              if ( Object.keys(_via_attributes['region'][attr_id]['options']).includes(old_value) ) {
                // transform existing value as checkbox option
                _via_img_metadata[img_id].regions[region_id].region_attributes[attr_id][old_value] = true;
              }
            }
          } else {
            _via_img_metadata[img_id].regions[region_id].region_attributes[attr_id] = {};
          }

          if ( new_checked ) {
            _via_img_metadata[img_id].regions[region_id].region_attributes[attr_id][option_id] = true;
          } else {
            // false option values are not stored
            delete _via_img_metadata[img_id].regions[region_id].region_attributes[attr_id][option_id];
          }
          update_count += 1;
          break;
        }
      }
    }
    ok_callback(update_count);
  });
}

function set_region_annotations_to_default_value(rid) {
  var attr_id;
  for ( attr_id in _via_attributes['region'] ) {
    var attr_type = _via_attributes['region'][attr_id].type;
    switch( attr_type ) {
    case 'text':
      var default_value = _via_attributes['region'][attr_id].default_value;
      if ( typeof(default_value) !== 'undefined' ) {
        _via_img_metadata[_via_image_id].regions[rid].region_attributes[attr_id] = default_value;
      }
      break;
    case 'image':    // fallback
    case 'dropdown': // fallback
    case 'radio':
      _via_img_metadata[_via_image_id].regions[rid].region_attributes[attr_id] = '';
      var default_options = _via_attributes['region'][attr_id].default_options;
      if ( typeof(default_options) !== 'undefined' ) {
        _via_img_metadata[_via_image_id].regions[rid].region_attributes[attr_id] = Object.keys(default_options)[0];
      }
      break;

    case 'checkbox':
      _via_img_metadata[_via_image_id].regions[rid].region_attributes[attr_id] = {};
      var default_options = _via_attributes['region'][attr_id].default_options;
      if ( typeof(default_options) !== 'underfined' ) {
        var option_id;
        for ( option_id in default_options ) {
          var default_value = default_options[option_id];
          if ( typeof(default_value) !== 'underfined' ) {
            _via_img_metadata[_via_image_id].regions[rid].region_attributes[attr_id][option_id] = default_value;
          }
        }
      }
      break;
    }
  }
}

function set_file_annotations_to_default_value(image_id) {
  var attr_id;
  for ( attr_id in _via_attributes['file'] ) {
    var attr_type = _via_attributes['file'][attr_id].type;
    switch( attr_type ) {
    case 'text':
      var default_value = _via_attributes['file'][attr_id].default_value;
      _via_img_metadata[image_id].file_attributes[attr_id] = default_value;
      break;
    case 'image':    // fallback
    case 'dropdown': // fallback
    case 'radio':
      _via_img_metadata[image_id].file_attributes[attr_id] = '';
      var default_options = _via_attributes['file'][attr_id].default_options;
      _via_img_metadata[image_id].file_attributes[attr_id] = Object.keys(default_options)[0];
      break;
    case 'checkbox':
      _via_img_metadata[image_id].file_attributes[attr_id] = {};
      var default_options = _via_attributes['file'][attr_id].default_options;
      var option_id;
      for ( option_id in default_options ) {
        var default_value = default_options[option_id];
        _via_img_metadata[image_id].file_attributes[attr_id][option_id] = default_value;
      }
      break;
    }
  }
}

function annotation_editor_increase_panel_height() {
  var p = document.getElementById('annotation_editor_panel');
  if ( _via_settings.ui.annotation_editor_height < 95 ) {
    _via_settings.ui.annotation_editor_height += VIA_ANNOTATION_EDITOR_HEIGHT_CHANGE;
    p.style.height = _via_settings.ui.annotation_editor_height + '%';
  }
}

function annotation_editor_decrease_panel_height() {
  var p = document.getElementById('annotation_editor_panel');
  if ( _via_settings.ui.annotation_editor_height > 10 ) {
    _via_settings.ui.annotation_editor_height -= VIA_ANNOTATION_EDITOR_HEIGHT_CHANGE;
    p.style.height = _via_settings.ui.annotation_editor_height + '%';
  }
}

function annotation_editor_increase_content_size() {
  var p = document.getElementById('annotation_editor_panel');
  if ( _via_settings.ui.annotation_editor_fontsize < 1.6 ) {
    _via_settings.ui.annotation_editor_fontsize += VIA_ANNOTATION_EDITOR_FONTSIZE_CHANGE;
    p.style.fontSize = _via_settings.ui.annotation_editor_fontsize + 'rem';
  }
}

function annotation_editor_decrease_content_size() {
  var p = document.getElementById('annotation_editor_panel');
  if ( _via_settings.ui.annotation_editor_fontsize > 0.4 ) {
    _via_settings.ui.annotation_editor_fontsize -= VIA_ANNOTATION_EDITOR_FONTSIZE_CHANGE;
    p.style.fontSize = _via_settings.ui.annotation_editor_fontsize + 'rem';
  }
}

//
// via project
//
function project_set_name(name) {
  _via_settings.project.name = name;

  var p = document.getElementById('project_name');
  p.value = _via_settings.project.name;
}

function project_init_default_project() {
  if ( ! _via_settings.hasOwnProperty('project') ) {
    _via_settings.project = {};
  }

  project_set_name( project_get_default_project_name() );
}

function project_on_name_update(p) {
  project_set_name(p.value);
}

function project_get_default_project_name() {
  const now = new Date();
  var MONTH_SHORT_NAME = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  var ts = now.getDate() + MONTH_SHORT_NAME[now.getMonth()] + now.getFullYear() +
      '_' + now.getHours() + 'h' + now.getMinutes() + 'm';

  var project_name = 'via_project_' + ts;
  return project_name;
}

function project_save_with_confirm() {
  var config = {'title':'Save Project' };
  var input = { 'project_name': { type:'text', name:'Project Name', value:_via_settings.project.name, disabled:false, size:30 },
                'save_annotations':{ type:'checkbox', name:'Save region and file annotations (i.e. manual annotations)', checked:true, disabled:false},
                'save_attributes':{ type:'checkbox', name:'Save region and file attributes.', checked:true},
                'save_via_settings':{ type:'checkbox', name:'Save VIA application settings', checked:true},
                //                'save_base64_data':{ type:'checkbox', name:'Save base64 data of images (if present)', checked:false},
                //                'save_images':{type:'checkbox', 'name':'Save images <span class="warning">(WARNING: only recommended for projects containing small number of images)</span>', value:false},
              };

  invoke_with_user_inputs(project_save_confirmed, input, config);
}

function project_save_confirmed(input) {
  if ( input.project_name.value !== _via_settings.project.name ) {
    project_set_name(input.project_name.value);
  }

  // via project
  var _via_project = { '_via_settings': _via_settings,
                       '_via_img_metadata': _via_img_metadata,
                       '_via_attributes': _via_attributes };

  var filename = input.project_name.value + '.json';
  var data_blob = new Blob( [JSON.stringify(_via_project)],
                            {type: 'text/json;charset=utf-8'});

  save_data_to_local_file(data_blob, filename);

  user_input_default_cancel_handler();
}

function project_open_select_project_file() {
  if (invisible_file_input) {
    invisible_file_input.accept = '.json';
    invisible_file_input.onchange = project_open;
    invisible_file_input.removeAttribute('multiple');
    invisible_file_input.click();
  }
}

function project_open(event) {
  var selected_file = event.target.files[0];
  load_text_file(selected_file, project_open_parse_json_file);
}

function project_open_parse_json_file(project_file_data) {
  var d = JSON.parse(project_file_data);
  if ( d['_via_settings'] && d['_via_img_metadata'] && d['_via_attributes'] ) {
    // import settings
    project_import_settings(d['_via_settings']);

    // clear existing data (if any)
    _via_image_id_list = [];
    _via_image_filename_list = [];
    _via_img_count = 0;
    _via_img_metadata = {};
    _via_img_fileref = {};
    _via_img_src = {};
    _via_attributes = { 'region':{}, 'file':{} };
    _via_buffer_remove_all();

    // import image metadata
    _via_img_metadata = d['_via_img_metadata'];
    var img_id;
    for ( img_id in _via_img_metadata ) {
      _via_image_id_list.push(img_id);
      _via_image_filename_list.push( _via_img_metadata[img_id].filename );
      set_file_annotations_to_default_value(img_id);
      _via_img_count += 1;
    }

    // import attributes
    _via_attributes = d['_via_attributes'];
    project_parse_via_attributes_from_img_metadata();
    var fattr_id_list = Object.keys(_via_attributes['file']);
    var rattr_id_list = Object.keys(_via_attributes['region']);
    if ( rattr_id_list.length ) {
      _via_attribute_being_updated = 'region';
      _via_current_attribute_id = rattr_id_list[0];
    } else {
      if ( fattr_id_list.length ) {
        _via_attribute_being_updated = 'file';
        _via_current_attribute_id = fattr_id_list[0];
      }
    }

    if ( _via_settings.core.default_filepath !== '' ) {
      _via_file_resolve_all_to_default_filepath();
    }

    show_message('Imported project [' + _via_settings['project'].name + '] with ' + _via_img_count + ' files.');

    if ( _via_img_count > 0 ) {
      _via_show_img(0);
      update_img_fn_list();
      _via_reload_img_fn_list_table = true;
    }
  } else {
    show_message('Cannot import project from a corrupt file!');
  }
}

function project_parse_via_attributes_from_img_metadata() {
  // parse _via_img_metadata to populate _via_attributes
  var img_id, fa, ra;

  if ( ! _via_attributes.hasOwnProperty('file') ) {
    _via_attributes['file'] = {};
  }
  if ( ! _via_attributes.hasOwnProperty('region') ) {
    _via_attributes['region'] = {};
  }

  for ( img_id in _via_img_metadata ) {
    // file attributes
    for ( fa in _via_img_metadata[img_id].file_attributes ) {
      if ( ! _via_attributes['file'].hasOwnProperty(fa) ) {
        _via_attributes['file'][fa] = {};
        _via_attributes['file'][fa]['type'] = 'text';
      }
    }
    // region attributes
    var ri;
    for ( ri = 0; ri < _via_img_metadata[img_id].regions.length; ++ri ) {
      for ( ra in _via_img_metadata[img_id].regions[ri].region_attributes ) {
        if ( ! _via_attributes['region'].hasOwnProperty(ra) ) {
          _via_attributes['region'][ra] = {};
          _via_attributes['region'][ra]['type'] = 'text';
        }
      }
    }
  }
}

function project_import_settings(s) {
  // @todo find a generic way to import into _via_settings
  // only the components present in s (and not overwrite everything)
  var k1;
  for ( k1 in s ) {
    if ( typeof( s[k1] ) === 'object' ) {
      var k2;
      for ( k2 in s[k1] ) {
        if ( typeof( s[k1][k2] ) === 'object' ) {
          var k3;
          for ( k3 in s[k1][k2] ) {
            _via_settings[k1][k2][k3] = s[k1][k2][k3];
          }
        } else {
          _via_settings[k1][k2] = s[k1][k2];
        }
      }
    } else {
      _via_settings[k1] = s[k1];
    }
  }
}

function project_file_remove_with_confirm() {
  var img_id = _via_image_id_list[_via_image_index];
  var filename = _via_img_metadata[img_id].filename;
  var region_count = _via_img_metadata[img_id].regions.length;

  var config = {'title':'Remove File from Project' };
  var input = { 'img_index': { type:'text', name:'File Id', value:(_via_image_index+1), disabled:true, size:8 },
                'filename':{ type:'text', name:'Filename', value:filename, disabled:true, size:30},
                'region_count':{ type:'text', name:'Number of regions', disabled:true, value:region_count, size:8}
              };

  invoke_with_user_inputs(project_file_remove_confirmed, input, config);
}

function project_file_remove_confirmed(input) {
  var img_index = input.img_index.value - 1;
  project_remove_file(img_index);

  if ( img_index === _via_img_count ) {
    if ( _via_img_count === 0 ) {
      _via_current_image_loaded = false;
      show_home_panel();
    } else {
      _via_show_img(img_index - 1);
    }
  } else {
    _via_show_img(img_index);
  }
  _via_reload_img_fn_list_table = true;
  update_img_fn_list();
  show_message('Removed file [' + input.filename.value + '] from project');
  user_input_default_cancel_handler();
}


function project_remove_file(img_index) {
  if ( img_index < 0 || img_index >= _via_img_count ) {
    console.log('project_remove_file(): invalid img_index ' + img_index);
    return;
  }
  var img_id = _via_image_id_list[img_index];

  // remove img_index from all array
  // this invalidates all image_index > img_index
  _via_image_id_list.splice( img_index, 1 );
  _via_image_filename_list.splice( img_index, 1 );

  var img_fn_list_index = _via_img_fn_list_img_index_list.indexOf(img_index);
  if ( img_fn_list_index !== -1 ) {
    _via_img_fn_list_img_index_list.splice( img_fn_list_index, 1 );
  }

  // clear all buffer
  // @todo: it is wasteful to clear all the buffer instead of removing a single image
  _via_buffer_remove_all();
  img_fn_list_clear_css_classname('buffered');

  _via_clear_reg_canvas();
  delete _via_img_metadata[img_id];
  delete _via_img_src[img_id];
  delete _via_img_fileref[img_id];

  _via_img_count -= 1;
}

function project_add_new_file(filename, size, file_id) {
  var img_id = file_id;
  if ( typeof(img_id) === 'undefined' ) {
    if ( typeof(size) === 'undefined' ) {
      size = -1;
    }
    img_id = _via_get_image_id(filename, size);
  }

  if ( ! _via_img_metadata.hasOwnProperty(img_id) ) {
    _via_img_metadata[img_id] = new file_metadata(filename, size);
    _via_image_id_list.push(img_id);
    _via_image_filename_list.push(filename);
    _via_img_count += 1;
  }
  return img_id;
}

function project_file_add_local(event) {
  var user_selected_images = event.target.files;
  var original_image_count = _via_img_count;

  var new_img_index_list = [];
  var discarded_file_count = 0;
  for ( var i = 0; i < user_selected_images.length; ++i ) {
    var filetype = user_selected_images[i].type.substr(0, 5);
    if ( filetype === 'image' ) {
      var filename = user_selected_images[i].name;
      var size     = user_selected_images[i].size;
      var img_id1  = _via_get_image_id(filename, size);
      var img_id2  = _via_get_image_id(filename, -1);
      var img_id   = img_id1;

      if ( _via_img_metadata.hasOwnProperty(img_id1) || _via_img_metadata.hasOwnProperty(img_id2) ) {
        if ( _via_img_metadata.hasOwnProperty(img_id2) ) {
          img_id = img_id2;
        }

        _via_img_fileref[img_id] = user_selected_images[i];
        if ( _via_img_metadata[img_id].size === -1 ) {
          _via_img_metadata[img_id].size = size;
        }
      } else {
        img_id = project_add_new_file(filename, size);
        _via_img_fileref[img_id] = user_selected_images[i];
        set_file_annotations_to_default_value(img_id);
      }
      new_img_index_list.push( _via_image_id_list.indexOf(img_id) );
    } else {
      discarded_file_count += 1;
    }
  }

  if ( _via_img_metadata ) {
    var status_msg = 'Loaded ' + new_img_index_list.length + ' images.';
    if ( discarded_file_count ) {
      status_msg += ' ( Discarded ' + discarded_file_count + ' non-image files! )';
    }
    show_message(status_msg);

    if ( new_img_index_list.length ) {
      // show first of newly added image
      _via_show_img( new_img_index_list[0] );
    } else {
      // show original image
      _via_show_img ( _via_image_index );
    }
    update_img_fn_list();
  } else {
    show_message("Please upload some image files!");
  }
}

function project_file_add_abs_path_with_input() {
  var config = {'title':'Add File using Absolute Path' };
  var input = { 'absolute_path': { type:'text', name:'add one absolute path', placeholder:'/home/abhishek/image1.jpg', disabled:false, size:50 },
		'absolute_path_list': { type:'textarea', name:'or, add multiple paths (one path per line)', placeholder:'/home/abhishek/image1.jpg\n/home/abhishek/image2.jpg\n/home/abhishek/image3.png', disabled:false, rows:5, cols:80 }
              };

  invoke_with_user_inputs(project_file_add_abs_path_input_done, input, config);
}

function project_file_add_abs_path_input_done(input) {
  if ( input.absolute_path.value !== '' ) {
    var abs_path  = input.absolute_path.value.trim();
    var img_id    = project_file_add_url(abs_path);
    var img_index = _via_image_id_list.indexOf(img_id);
    _via_show_img(img_index);
    show_message('Added file at absolute path [' + abs_path + ']');
    update_img_fn_list();
    user_input_default_cancel_handler();
  } else {
    if ( input.absolute_path_list.value !== '' ) {
      var absolute_path_list_str = input.absolute_path_list.value;
      import_files_url_from_csv(absolute_path_list_str);
    }
  }
}

function project_file_add_url_with_input() {
  var config = {'title':'Add File using URL' };
  var input = { 'url': { type:'text', name:'add one URL', placeholder:'http://www.robots.ox.ac.uk/~vgg/software/via/images/swan.jpg', disabled:false, size:50 },
		'url_list': { type:'textarea', name:'or, add multiple URL (one url per line)', placeholder:'http://www.example.com/image1.jpg\nhttp://www.example.com/image2.jpg\nhttp://www.example.com/image3.png', disabled:false, rows:5, cols:80 }
              };

  invoke_with_user_inputs(project_file_add_url_input_done, input, config);
}

function project_file_add_url_input_done(input) {
  if ( input.url.value !== '' ) {
    var url = input.url.value.trim();
    var img_id    = project_file_add_url(url);
    var img_index = _via_image_id_list.indexOf(img_id);
    show_message('Added file at url [' + url + ']');
    update_img_fn_list();
    _via_show_img(img_index);
    user_input_default_cancel_handler();
  } else {
    if ( input.url_list.value !== '' ) {
      var url_list_str = input.url_list.value;
      import_files_url_from_csv(url_list_str);
    }
  }
}

function project_file_add_url(url) {
  if ( url !== '' ) {
    var size = -1; // convention: files added using url have size = -1
    var img_id   = _via_get_image_id(url, size);

    if ( ! _via_img_metadata.hasOwnProperty(img_id) ) {
      img_id = project_add_new_file(url);
      _via_img_src[img_id] = _via_img_metadata[img_id].filename;
      set_file_annotations_to_default_value(img_id);
      return img_id;
    }
  }
}

function project_file_add_base64(filename, base64) {
  var size = -1; // convention: files added using url have size = -1
  var img_id   = _via_get_image_id(filename, size);

  if ( ! _via_img_metadata.hasOwnProperty(img_id) ) {
    img_id = project_add_new_file(filename, size);
    _via_img_src[img_id] = base64;
    set_file_annotations_to_default_value(img_id);
  }
}

function project_file_load_on_fail(img_index) {
  var img_id = _via_image_id_list[img_index];
  _via_img_src[img_id] = '';
  _via_image_load_error[img_index] = true;
  img_fn_list_ith_entry_error(img_index, true);
}

function project_file_load_on_success(img_index) {
  _via_image_load_error[img_index] = false;
  img_fn_list_ith_entry_error(img_index, false);
}

function project_settings_toggle() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.SETTINGS ) {
    show_single_image_view();
  } else {
    project_settings_show();
  }
}

function project_settings_show() {
  set_display_area_content(VIA_DISPLAY_AREA_CONTENT_NAME.SETTINGS);
}

function project_filepath_add_from_input(p, button) {
  var new_path = document.getElementById(p).value.trim();
  var img_index = parseInt(button.getAttribute('value'));
  project_filepath_add(new_path);
  _via_show_img(img_index);
}

function project_filepath_add(new_path) {
  console.log('adding path: ' + new_path);
  if ( path === '' ) {
    return;
  }

  if ( _via_settings.core.filepath.hasOwnProperty(new_path) ) {
    return;
  } else {
    var largest_order = 0;
    var path;
    for ( path in _via_settings.core.filepath ) {
      if ( _via_settings.core.filepath[path] > largest_order ) {
        largest_order = _via_settings.core.filepath[path];
      }
    }
    _via_settings.core.filepath[new_path] = largest_order + 1;

  }
}

function project_filepath_del(path) {
  if ( _via_settings.core.filepath.hasOwnProperty(path) ) {
    delete _via_settings.core.filepath[path];
  }
}

function project_save_attributes() {
  var blob_attr = {type: 'application/json;charset=utf-8'};
  var all_region_data_blob = new Blob( [ JSON.stringify(_via_attributes) ], blob_attr);

  save_data_to_local_file(all_region_data_blob, _via_settings.project.name + '_attributes.json');
}

function project_import_attributes_from_file(event) {
  var selected_files = event.target.files;
  for ( var i = 0; i < selected_files.length; ++i ) {
    var file = selected_files[i];
    load_text_file(file, project_import_attributes_from_json);
  }
}

function project_import_attributes_from_json(data) {
  try {
    var d = JSON.parse(data);
    var attr;
    var fattr_count = 0;
    var rattr_count = 0;
    // process file attributes
    for ( attr in d['file'] ) {
      _via_attributes['file'][attr] = JSON.parse( JSON.stringify( d['file'][attr] ) );
      fattr_count += 1;
    }

    // process region attributes
    for ( attr in d['region'] ) {
      _via_attributes['region'][attr] = JSON.parse( JSON.stringify( d['region'][attr] ) );
      rattr_count += 1;
    }

    if ( fattr_count > 0 || rattr_count > 0 ) {
      var fattr_id_list = Object.keys(_via_attributes['file']);
      var rattr_id_list = Object.keys(_via_attributes['region']);
      if ( rattr_id_list.length ) {
        _via_attribute_being_updated = 'region';
        _via_current_attribute_id = rattr_id_list[0];
      } else {
        if ( fattr_id_list.length ) {
          _via_attribute_being_updated = 'file';
          _via_current_attribute_id = fattr_id_list[0];
        }
      }
      attribute_update_panel_set_active_button();
      update_attributes_update_panel();
      annotation_editor_update_content();
    }
    show_message('Imported ' + fattr_count + ' file attributes and '
                 + rattr_count + ' region attributes');
  } catch (error) {
    show_message('Failed to import attributes: [' + error + ']');
  }
}

//
// image grid
//
function image_grid_init() {
  var p = document.getElementById('image_grid_content');
  p.focus();
  p.addEventListener('mousedown', image_grid_mousedown_handler, false);
  p.addEventListener('mouseup', image_grid_mouseup_handler, false);
  p.addEventListener('dblclick', image_grid_dblclick_handler, false);

  image_grid_set_content_panel_height_fixed();

  // select policy as defined in settings
  var i, option;
  var p = document.getElementById('image_grid_show_image_policy');
  var n = p.options.length;
  for ( i = 0; i < n; ++i ) {
    if ( p.options[i].value === _via_settings.ui.image_grid.show_image_policy ) {
      p.selectedIndex = i;
      break;
    }
  }
}

function image_grid_update() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    image_grid_set_content( _via_image_grid_img_index_list );
  }
}

function image_grid_toggle() {
  var p = document.getElementById('toolbar_image_grid_toggle');
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE_GRID ) {
    image_grid_clear_all_groups();
    show_single_image_view();
  } else {
    show_image_grid_view();
  }
}

function image_grid_show_all_project_images() {
  var all_img_index_list = [];
  var i, n;
  //n = _via_image_id_list.length;
  n = _via_img_fn_list_img_index_list.length;
  for ( i = 0; i < n; ++i ) {
    all_img_index_list.push( _via_img_fn_list_img_index_list[i] );
  }
  image_grid_clear_all_groups();

  var p = document.getElementById('image_grid_toolbar_group_by_select');
  p.selectedIndex = 0;

  image_grid_set_content(all_img_index_list);
}

function image_grid_clear_all_groups() {
  var i, n;
  n = _via_image_grid_group_var.length;
  for ( i = 0; i < n; ++i ) {
    image_grid_remove_html_group_panel( _via_image_grid_group_var[i] );
    image_grid_group_by_select_set_disabled( _via_image_grid_group_var[i].type,
                                             _via_image_grid_group_var[i].name,
                                             false);
  }
  _via_image_grid_group = {};
  _via_image_grid_group_var = [];

}

function image_grid_set_content(img_index_list) {
  if ( img_index_list.length === 0 ) {
    return;
  }
  if ( _via_image_grid_load_ongoing ) {
    return;
  }

  _via_image_grid_img_index_list = img_index_list.slice(0);
  _via_image_grid_selected_img_index_list = img_index_list.slice(0);

  document.getElementById('image_grid_group_by_img_count').innerHTML = _via_image_grid_img_index_list.length;

  _via_image_grid_page_first_index    = 0;
  _via_image_grid_page_last_index     = null;
  _via_image_grid_stack_prev_page     = [];
  _via_image_grid_page_img_index_list = [];

  image_grid_clear_content();
  image_grid_set_content_panel_height_fixed();
  _via_image_grid_load_ongoing = true;

  var n = _via_image_grid_img_index_list.length;
  switch ( _via_settings.ui.image_grid.show_image_policy ) {
  case 'all':
    _via_image_grid_page_img_index_list = _via_image_grid_img_index_list.slice(0);
    break;
  case 'first_mid_last':
    if ( n < 3 ) {
      var i;
      for ( i = 0; i < n; ++i ) {
        _via_image_grid_page_img_index_list.push( _via_image_grid_img_index_list[i] );
      }
    } else {
      _via_image_grid_page_img_index_list.push( _via_image_grid_img_index_list[0] );
      _via_image_grid_page_img_index_list.push( _via_image_grid_img_index_list[ Math.floor(n/2) ] );
      _via_image_grid_page_img_index_list.push( _via_image_grid_img_index_list[n-1] );
    }
    break;
  case 'even_indexed':
    var i;
    for ( i = 0; i < n; ++i ) {
      if ( i % 2 !== 0 ) { // since the user views (i+1) based indexing
        _via_image_grid_page_img_index_list.push( _via_image_grid_img_index_list[i] );
      }
    }
    break;
  case 'odd_indexed':
    var i;
    for ( i = 0; i < n; ++i ) {
      if ( i % 2 === 0 ) { // since the user views (i+1) based indexing
        _via_image_grid_page_img_index_list.push( _via_image_grid_img_index_list[i] );
      }
    }
    break;
  case 'gap5':  // fallback
  case 'gap25': // fallback
  case 'gap50': // fallback
    var del = parseInt( _via_settings.ui.image_grid.show_image_policy.substr( 'gap'.length ) );
    var i;
    for ( i = 0; i < n; i = i + del ) {
      _via_image_grid_page_img_index_list.push( _via_image_grid_img_index_list[i] );
    }
    break;
  }

  _via_image_grid_visible_img_index_list = [];

  image_grid_update_sel_count_html();
  annotation_editor_update_content();

  image_grid_content_append_img( _via_image_grid_page_first_index );

  show_message('[Click] toggles selection, ' +
               '[Shift + Click] selects everything a image, ' +
               '[Click] or [Ctrl + Click] removes selection of all subsequent or preceeding images.');
}

function image_grid_clear_content() {
  var img_container = document.getElementById('image_grid_content_img');
  var img_rshape = document.getElementById('image_grid_content_rshape');
  img_container.innerHTML = '';
  img_rshape.innerHTML = '';
  _via_image_grid_visible_img_index_list = [];
}

function image_grid_set_content_panel_height_fixed() {
  var pc = document.getElementById('image_grid_content');
  var de = document.documentElement;
  pc.style.height = (de.clientHeight - 5.5*ui_top_panel.offsetHeight) + 'px';
}

// We do not know how many images will fit in the display area.
// Therefore, we add images one-by-one until overflow of parent
// container is detected.
function image_grid_content_append_img( img_grid_index ) {
  var img_index   = _via_image_grid_page_img_index_list[img_grid_index];
  var html_img_id = image_grid_get_html_img_id(img_index);
  var img_id      = _via_image_id_list[img_index];
  var e = document.createElement('img');
  if ( _via_img_fileref[img_id] instanceof File ) {
    var img_reader = new FileReader();
    img_reader.addEventListener( "error", function() {
      //@todo
    }, false);
    img_reader.addEventListener( "load", function() {
      e.src = img_reader.result;
    }, false);
    img_reader.readAsDataURL( _via_img_fileref[img_id] );
  } else {
    e.src = _via_img_src[img_id];
  }
  e.setAttribute('id', html_img_id);
  e.setAttribute('height', _via_settings.ui.image_grid.img_height + 'px');
  e.setAttribute('title', '[' + (img_index+1) + '] ' + _via_img_metadata[img_id].filename);

  e.addEventListener('load', image_grid_on_img_load, false);
  e.addEventListener('error', image_grid_on_img_error, false);
  document.getElementById('image_grid_content_img').appendChild(e);
}

function image_grid_on_img_load(e) {
  var img = e.target;
  var img_index = image_grid_parse_html_img_id(img.id);
  project_file_load_on_success(img_index);

  image_grid_add_img_if_possible(img);
}

function image_grid_on_img_error(e) {
  var img       = e.target;
  var img_index = image_grid_parse_html_img_id(img.id);
  project_file_load_on_fail(img_index);
  image_grid_add_img_if_possible(img);
}

function image_grid_add_img_if_possible(img) {
  var img_index = image_grid_parse_html_img_id(img.id);

  var p = document.getElementById('image_grid_content_img');
  var img_bottom_right_corner = parseInt(img.offsetTop) + parseInt(img.height);
  if ( p.clientHeight < img_bottom_right_corner ) {
    // stop as addition of this image caused overflow of parent container
    var img_container = document.getElementById('image_grid_content_img');
    img_container.removeChild(img);

    if ( _via_settings.ui.image_grid.show_region_shape ) {
      image_grid_page_show_all_regions();
    }
    _via_image_grid_load_ongoing = false;

    var index = _via_image_grid_page_img_index_list.indexOf(img_index);
    _via_image_grid_page_last_index = index;

    // setup prev, next navigation
    var info = document.getElementById('image_grid_nav');
    var html = [];
    var first_index = _via_image_grid_page_first_index;
    var last_index  = _via_image_grid_page_last_index - 1;
    html.push('<span>Showing&nbsp;' + (first_index + 1) +
              ' to ' + (last_index + 1) + '&nbsp;:</span>');
    if ( _via_image_grid_stack_prev_page.length ) {
      html.push('<span class="text_button" onclick="image_grid_page_prev()">Prev</span>');
    } else {
      html.push('<span>Prev</span>');
    }
    html.push('<span class="text_button" onclick="image_grid_page_next()">Next</span');
    info.innerHTML = html.join('');
  } else {
    // process this image and trigger addition of next image in sequence
    var img_fn_list_index = _via_image_grid_page_img_index_list.indexOf(img_index);
    var next_img_fn_list_index = img_fn_list_index + 1;

    _via_image_grid_visible_img_index_list.push( img_index );
    var is_selected = ( _via_image_grid_selected_img_index_list.indexOf(img_index) !== -1 );
    if ( ! is_selected ) {
      image_grid_update_img_select(img_index, 'unselect');
    }

    if ( next_img_fn_list_index !==  _via_image_grid_page_img_index_list.length ) {
      if ( _via_image_grid_load_ongoing ) {
        image_grid_content_append_img( img_fn_list_index + 1 );
      } else {
        // image grid load operation was cancelled
        _via_image_grid_page_last_index = _via_image_grid_page_first_index; // load this page again

        var info = document.getElementById('image_grid_nav');
        var html = [];
        html.push('<span>Cancelled&nbsp;:</span>');
        if ( _via_image_grid_stack_prev_page.length ) {
          html.push('<span class="text_button" onclick="image_grid_page_prev()">Prev</span>');
        } else {
          html.push('<span>Prev</span>');
        }
        html.push('<span class="text_button" onclick="image_grid_page_next()">Next</span');
        info.innerHTML = html.join('');
      }
    } else {
      // last page
      var index = _via_image_grid_page_img_index_list.indexOf(img_index);
      _via_image_grid_page_last_index = index;

      if ( _via_settings.ui.image_grid.show_region_shape ) {
        image_grid_page_show_all_regions();
      }
      _via_image_grid_load_ongoing = false;

      // setup prev, next navigation
      var info = document.getElementById('image_grid_nav');
      var html = [];
      var first_index = _via_image_grid_page_first_index;
      var last_index  = _via_image_grid_page_last_index;
      html.push('<span>Showing&nbsp;' + (first_index + 1) +
                ' to ' + (last_index + 1) + ' (end)&nbsp;</span>');
      if ( _via_image_grid_stack_prev_page.length ) {
        html.push('<span class="text_button" onclick="image_grid_page_prev()">Prev</span>');
      } else {
        html.push('<span>Prev</span>');
      }
      html.push('<span>Next</span');

      info.innerHTML = html.join('');
    }
  }
}

function image_grid_onchange_show_image_policy(p) {
  _via_settings.ui.image_grid.show_image_policy = p.options[p.selectedIndex].value;
  image_grid_set_content(_via_image_grid_img_index_list);
}

function image_grid_page_show_all_regions() {
  var all_promises = [];
  if ( _via_settings.ui.image_grid.show_region_shape ) {
    var p = document.getElementById('image_grid_content_img');
    var n = p.childNodes.length;
    var i;
    for ( i = 0; i < n; ++i ) {
      // draw region shape into global canvas for image grid
      var img_index = image_grid_parse_html_img_id( p.childNodes[i].id );
      var img_param = []; // [width, height, originalWidth, originalHeight, x, y]
      img_param.push( parseInt(p.childNodes[i].width) );
      img_param.push( parseInt(p.childNodes[i].height) );
      img_param.push( parseInt(p.childNodes[i].naturalWidth) );
      img_param.push( parseInt(p.childNodes[i].naturalHeight) );
      img_param.push( parseInt(p.childNodes[i].offsetLeft) + parseInt(p.childNodes[i].clientLeft) );
      img_param.push( parseInt(p.childNodes[i].offsetTop) + parseInt(p.childNodes[i].clientTop) );
      var promise = image_grid_show_region_shape( img_index, img_param );
      all_promises.push( promise );
    }
    // @todo: ensure that all promises are fulfilled
  }
}

function image_grid_is_region_in_current_group(r) {
  var i, n;
  n = _via_image_grid_group_var.length;
  if ( n === 0 ) {
    return true;
  }

  for ( i = 0; i < n; ++i ) {
    if ( _via_image_grid_group_var[i].type === 'region' ) {
      var group_value = _via_image_grid_group_var[i].values[ _via_image_grid_group_var[i].current_value_index ];
      if ( r[_via_image_grid_group_var[i].name] != group_value ) {
        return false;
      }
    }
  }
  return true;
}

function image_grid_show_region_shape(img_index, img_param) {
  return new Promise( function(ok_callback, err_callback) {
    var i;
    var img_id = _via_image_id_list[img_index];
    var html_img_id = image_grid_get_html_img_id(img_index);
    var n = _via_img_metadata[img_id].regions.length;
    var is_in_group = false;
    for ( i = 0; i < n; ++i ) {
      if ( ! image_grid_is_region_in_current_group( _via_img_metadata[img_id].regions[i].region_attributes ) ) {
        // skip drawing this region which is not in current group
        continue;
      }

      var r = _via_img_metadata[img_id].regions[i].shape_attributes;
      var dimg; // region coordinates in original image space
      switch( r.name ) {
      case VIA_REGION_SHAPE.RECT:
        dimg = [ r['x'], r['y'], r['x']+r['width'], r['y']+r['height'] ];
        break;
      case VIA_REGION_SHAPE.CIRCLE:
        dimg = [ r['cx'], r['cy'], r['cx']+r['r'], r['cy']+r['r'] ];
        break;
      case VIA_REGION_SHAPE.ELLIPSE:
        dimg = [ r['cx'], r['cy'], r['cx']+r['rx'], r['cy']+r['ry'] ];
        break;
      case VIA_REGION_SHAPE.POLYLINE: // handled by POLYGON
      case VIA_REGION_SHAPE.POLYGON:
        var j;
        dimg = [];
        for ( j = 0; j < r['all_points_x'].length; ++j ) {
          dimg.push( r['all_points_x'][j] );
          dimg.push( r['all_points_y'][j] );
        }
        break;
      case VIA_REGION_SHAPE.POINT:
        dimg = [ r['cx'], r['cy'] ];
        break;
      }
      var scale_factor = img_param[1] / img_param[3]; // new_height / original height
      var offset_x     = img_param[4];
      var offset_y     = img_param[5];
      var r2 = new _via_region( r.name, i, dimg, scale_factor, offset_x, offset_y);
      var r2_svg = r2.get_svg_element();
      r2_svg.setAttribute('id', image_grid_get_html_region_id(img_index, i));
      r2_svg.setAttribute('class', html_img_id);
      r2_svg.setAttribute('fill',         _via_settings.ui.image_grid.rshape_fill);
      //r2_svg.setAttribute('fill-opacity', _via_settings.ui.image_grid.rshape_fill_opacity);
      r2_svg.setAttribute('stroke',       _via_settings.ui.image_grid.rshape_stroke);
      r2_svg.setAttribute('stroke-width', _via_settings.ui.image_grid.rshape_stroke_width);

      document.getElementById('image_grid_content_rshape').appendChild(r2_svg);
    }
  });
}

function image_grid_image_size_increase() {
  var new_img_height = _via_settings.ui.image_grid.img_height + VIA_IMAGE_GRID_IMG_HEIGHT_CHANGE;
  _via_settings.ui.image_grid.img_height = new_img_height;

  _via_image_grid_page_last_index = null;
  image_grid_update();
}

function image_grid_image_size_decrease() {
  var new_img_height = _via_settings.ui.image_grid.img_height - VIA_IMAGE_GRID_IMG_HEIGHT_CHANGE;
  if ( new_img_height > 1 ) {
    _via_settings.ui.image_grid.img_height = new_img_height;
    _via_image_grid_page_last_index = null;
    image_grid_update();
  }
}

function image_grid_image_size_reset() {
  var new_img_height = _via_settings.ui.image_grid.img_height;
  if ( new_img_height > 1 ) {
    _via_settings.ui.image_grid.img_height = new_img_height;
    _via_image_grid_page_last_index = null;
    image_grid_update();
  }
}

function image_grid_mousedown_handler(e) {
  e.preventDefault();
  _via_image_grid_mousedown_img_index = image_grid_parse_html_img_id(e.target.id);
}

function image_grid_mouseup_handler(e) {
  e.preventDefault();
  var last_mouseup_img_index = _via_image_grid_mouseup_img_index;
  _via_image_grid_mouseup_img_index = image_grid_parse_html_img_id(e.target.id);
  if ( isNaN(_via_image_grid_mousedown_img_index) ||
       isNaN(_via_image_grid_mouseup_img_index)) {
    last_mouseup_img_index = _via_image_grid_img_index_list[0];
    image_grid_group_select_none();
    return;
  }

  var mousedown_img_arr_index = _via_image_grid_img_index_list.indexOf(_via_image_grid_mousedown_img_index);
  var mouseup_img_arr_index = _via_image_grid_img_index_list.indexOf(_via_image_grid_mouseup_img_index);

  var start = -1;
  var end   = -1;
  var operation = 'select'; // {'select', 'unselect', 'toggle'}
  if ( mousedown_img_arr_index === mouseup_img_arr_index ) {
    if ( e.shiftKey ) {
      // select all elements until this element
      start = _via_image_grid_img_index_list.indexOf(last_mouseup_img_index) + 1;
      end   = mouseup_img_arr_index + 1;
    } else {
      // toggle selection of single image
      start = mousedown_img_arr_index;
      end   = start + 1;
      operation = 'toggle';
    }
  } else {
    if ( mousedown_img_arr_index < mouseup_img_arr_index ) {
      start = mousedown_img_arr_index;
      end   = mouseup_img_arr_index + 1;
    } else {
      start = mouseup_img_arr_index + 1;
      end   = mousedown_img_arr_index;
    }
    operation = 'toggle';
  }

  if ( start > end ) {
    return;
  }

  var i, img_index;
  for ( i = start; i < end; ++i ) {
    img_index = _via_image_grid_img_index_list[i];
    image_grid_update_img_select(img_index, operation);
  }
  image_grid_update_sel_count_html();
  annotation_editor_update_content();
}

function image_grid_update_sel_count_html() {
  document.getElementById('image_grid_group_by_sel_img_count').innerHTML = _via_image_grid_selected_img_index_list.length;
}

// state \in {'select', 'unselect', 'toggle'}
function image_grid_update_img_select(img_index, state) {
  var html_img_id = image_grid_get_html_img_id(img_index);
  var is_selected = ( _via_image_grid_selected_img_index_list.indexOf(img_index) !== -1 );
  if (state === 'toggle' ) {
    if ( is_selected ) {
      state = 'unselect';
    } else {
      state = 'select';
    }
  }

  switch(state) {
  case 'select':
    if ( ! is_selected ) {
      _via_image_grid_selected_img_index_list.push(img_index);
    }
    if ( _via_image_grid_visible_img_index_list.indexOf(img_index) !== -1 ) {
      document.getElementById(html_img_id).classList.remove('not_sel');
    }
    break;
  case 'unselect':
    if ( is_selected ) {
      var arr_index = _via_image_grid_selected_img_index_list.indexOf(img_index);
      _via_image_grid_selected_img_index_list.splice(arr_index, 1);
    }
    if ( _via_image_grid_visible_img_index_list.indexOf(img_index) !== -1 ) {
      document.getElementById(html_img_id).classList.add('not_sel');
    }
    break;
  }
}

function image_grid_group_select_all() {
  image_grid_group_set_all_selection_state('select');
  image_grid_update_sel_count_html();
  annotation_editor_update_content();
  show_message('Selected all images in the current group');
}

function image_grid_group_select_none() {
  image_grid_group_set_all_selection_state('unselect');
  image_grid_update_sel_count_html();
  annotation_editor_update_content();
  show_message('Removed selection of all images in the current group');
}

function image_grid_group_set_all_selection_state(state) {
  var i, img_index;
  for ( i = 0; i < _via_image_grid_img_index_list.length; ++i ) {
    img_index = _via_image_grid_img_index_list[i];
    image_grid_update_img_select(img_index, state);
  }
}

function image_grid_group_toggle_select_all() {
  if ( _via_image_grid_selected_img_index_list.length === _via_image_grid_img_index_list.length ) {
    image_grid_group_select_none();
  } else {
    image_grid_group_select_all();
  }
}

function image_grid_parse_html_img_id(html_img_id) {
  var img_index = html_img_id.substr(2);
  return parseInt(img_index);
}

function image_grid_get_html_img_id(img_index) {
  return 'im' + img_index;
}

function image_grid_parse_html_region_id(html_region_id) {
  var chunks = html_region_id.split('_');
  if ( chunks.length === 2 ) {
    var img_index = parseInt(chunks[0].substr(2));
    var region_id = parseInt(chunks[1].substr(2));
    return {'img_index':img_index, 'region_id':region_id};
  } else {
    console.log('image_grid_parse_html_region_id(): invalid html_region_id');
    return {};
  }
}

function image_grid_get_html_region_id(img_index, region_id) {
  return image_grid_get_html_img_id(img_index) + '_rs' + region_id;
}

function image_grid_dblclick_handler(e) {
  _via_image_index = image_grid_parse_html_img_id(e.target.id);
  show_single_image_view();
}

function image_grid_toolbar_update_group_by_select() {
  var p = document.getElementById('image_grid_toolbar_group_by_select');
  p.innerHTML = '';

  var o = document.createElement('option');
  o.setAttribute('value', '');
  o.setAttribute('selected', 'selected');
  o.innerHTML = 'All Images';
  p.appendChild(o);

  // add file attributes
  var fattr;
  for ( fattr in _via_attributes['file'] ) {
    var o = document.createElement('option');
    o.setAttribute('value', image_grid_toolbar_group_by_select_get_html_id('file', fattr));
    o.innerHTML = '[file] ' + fattr;
    p.appendChild(o);
  }

  // add region attributes
  var rattr;
  for ( rattr in _via_attributes['region'] ) {
    var o = document.createElement('option');
    o.setAttribute('value', image_grid_toolbar_group_by_select_get_html_id('region', rattr));
    o.innerHTML = '[region] ' + rattr;
    p.appendChild(o);
  }
}

function image_grid_toolbar_group_by_select_get_html_id(type, name) {
  if ( type === 'file' ) {
    return 'f_' + name;
  }
  if ( type === 'region' ) {
    return 'r_' + name;
  }
}

function image_grid_toolbar_group_by_select_parse_html_id(id) {
  if ( id.startsWith('f_') ) {
    return { 'attr_type':'file', 'attr_name':id.substr(2) };
  }
  if ( id.startsWith('r_') ) {
    return { 'attr_type':'region', 'attr_name':id.substr(2) };
  }
}

function image_grid_toolbar_onchange_group_by_select(p) {
  if ( p.options[p.selectedIndex].value === '' ) {
    image_grid_show_all_project_images();
    return;
  }

  var v = image_grid_toolbar_group_by_select_parse_html_id( p.options[p.selectedIndex].value );
  var attr_type = v.attr_type;
  var attr_name = v.attr_name;
  image_grid_group_by(attr_type, attr_name);

  image_grid_group_by_select_set_disabled(attr_type, attr_name, true);
  p.blur(); // to avoid adding new groups using keyboard keys as dropdown is still in focus
}

function image_grid_remove_html_group_panel(d) {
  var p = document.getElementById('group_toolbar_' + d.group_index);
  document.getElementById('image_grid_group_panel').removeChild(p);
}

function image_grid_add_html_group_panel(d) {
  var p = document.createElement('div');
  p.classList.add('image_grid_group_toolbar');
  p.setAttribute('id', 'group_toolbar_' + d.group_index);

  var del = document.createElement('span');
  del.classList.add('text_button');
  del.setAttribute('onclick', 'image_grid_remove_group_by(this)');
  del.innerHTML = '&times;';
  p.appendChild(del);

  var prev = document.createElement('button');
  prev.innerHTML = '<';
  prev.setAttribute('value', d.group_index);
  prev.setAttribute('onclick', 'image_grid_group_prev(this)');
  p.appendChild(prev);

  var sel = document.createElement('select');
  sel.setAttribute('id', image_grid_group_select_get_html_id(d.group_index));
  sel.setAttribute('onchange', 'image_grid_group_value_onchange(this)');
  var i, value;
  var n = d.values.length;
  var current_value = d.values[ d.current_value_index ];
  for ( i = 0; i < n; ++i ) {
    value = d.values[i];
    var o = document.createElement('option');
    o.setAttribute('value', value);
    o.innerHTML = (i+1) + '/' + n + ': ' + d.name + ' = ' + value;
    if ( value === current_value ) {
      o.setAttribute('selected', 'selected');
    }

    sel.appendChild(o);
  }
  p.appendChild(sel);

  var next = document.createElement('button');
  next.innerHTML = '>';
  next.setAttribute('value', d.group_index);
  next.setAttribute('onclick', 'image_grid_group_next(this)');
  p.appendChild(next);

  document.getElementById('image_grid_group_panel').appendChild(p);
}

function image_grid_group_panel_set_selected_value(group_index) {
  var sel = document.getElementById(image_grid_group_select_get_html_id(group_index));
  sel.selectedIndex = _via_image_grid_group_var[group_index].current_value_index;
}

function image_grid_group_panel_set_options(group_index) {
  var sel = document.getElementById(image_grid_group_select_get_html_id(group_index));
  sel.innerHTML = '';

  var i, value;
  var n = _via_image_grid_group_var[group_index].values.length;
  var name = _via_image_grid_group_var[group_index].name;
  var current_value = _via_image_grid_group_var[group_index].values[ _via_image_grid_group_var[group_index].current_value_index ]
  for ( i = 0; i < n; ++i ) {
    value = _via_image_grid_group_var[group_index].values[i];
    var o = document.createElement('option');
    o.setAttribute('value', value);
    o.innerHTML = (i+1) + '/' + n + ': ' + name + ' = ' + value;
    if ( value === current_value ) {
      o.setAttribute('selected', 'selected');
    }
    sel.appendChild(o);
  }
}

function image_grid_group_select_get_html_id(group_index) {
  return 'gi_' + group_index;
}

function image_grid_group_select_parse_html_id(id) {
  return parseInt(id.substr(3));
}

function image_grid_group_by_select_set_disabled(type, name, is_disabled) {
  var p = document.getElementById('image_grid_toolbar_group_by_select');
  var sel_option_value = image_grid_toolbar_group_by_select_get_html_id(type, name);

  var n = p.options.length;
  var option_value;
  var i;
  for ( i = 0; i < n; ++i ) {
    if ( sel_option_value === p.options[i].value ) {
      if ( is_disabled ) {
        p.options[i].setAttribute('disabled', 'disabled');
      } else {
        p.options[i].removeAttribute('disabled');
      }
      break;
    }
  }
}

function image_grid_remove_group_by(p) {
  var prefix = 'group_toolbar_';
  var group_index = parseInt( p.parentNode.id.substr( prefix.length ) );

  if ( group_index === 0 ) {
    image_grid_show_all_project_images();
  } else {
    // merge all groups that are child of group_index
    image_grid_group_by_merge(_via_image_grid_group, 0, group_index);

    var n = _via_image_grid_group_var.length;
    var p = document.getElementById('image_grid_group_panel');
    var group_panel_id;
    var i;
    for ( i = group_index; i < n; ++i ) {
      image_grid_remove_html_group_panel( _via_image_grid_group_var[i] );
      image_grid_group_by_select_set_disabled( _via_image_grid_group_var[i].type,
                                               _via_image_grid_group_var[i].name,
                                               false);
    }
    _via_image_grid_group_var.splice(group_index);

    image_grid_set_content_to_current_group();
  }
}

function image_grid_group_by(type, name) {
  if ( Object.keys(_via_image_grid_group).length === 0 ) {
    // first group
    var img_index_array = [];
    var n = _via_img_fn_list_img_index_list.length;
    var i;
    for ( i = 0; i < n; ++i ) {
      img_index_array.push( _via_img_fn_list_img_index_list[i] );
    }

    _via_image_grid_group = image_grid_split_array_to_group(img_index_array, type, name);
    var new_group_values = Object.keys(_via_image_grid_group);
    _via_image_grid_group_var = [];
    _via_image_grid_group_var.push( { 'type':type, 'name':name, 'current_value_index':0, 'values':new_group_values, 'group_index':0 } );

    image_grid_add_html_group_panel(_via_image_grid_group_var[0]);
  } else {
    image_grid_group_split_all_arrays( _via_image_grid_group, type, name );

    var i, n, value;
    var current_group_value = _via_image_grid_group;
    n = _via_image_grid_group_var.length;

    for ( i = 0; i < n; ++i ) {
      value = _via_image_grid_group_var[i].values[ _via_image_grid_group_var[i].current_value_index ];
      current_group_value = current_group_value[ value ];
    }
    var new_group_values = Object.keys(current_group_value);
    var group_var_index = _via_image_grid_group_var.length;
    _via_image_grid_group_var.push( { 'type':type, 'name':name, 'current_value_index':0, 'values':new_group_values, 'group_index':group_var_index } );
    image_grid_add_html_group_panel( _via_image_grid_group_var[group_var_index] );
  }

  image_grid_set_content_to_current_group();
}

function image_grid_group_by_merge(group, current_level, target_level) {
  var child_value;
  var group_data = [];
  if ( current_level === target_level ) {
    return image_grid_group_by_collapse(group);
  } else {
    for ( child_value in group ) {
      group[child_value] = image_grid_group_by_merge(group[child_value], current_level + 1, target_level);
    }
  }
}

function image_grid_group_by_collapse(group) {
  var child_value;
  var child_collapsed_value;
  var group_data = [];
  for ( child_value in group ) {
    if ( Array.isArray(group[child_value]) ) {
      group_data = group_data.concat(group[child_value]);
    } else {
      group_data = group_data.concat(image_grid_group_by_collapse(group[child_value]));
    }
  }
  return group_data;
}

// recursively collapse all arrays to list
function image_grid_group_split_all_arrays(group, type, name) {
  if ( Array.isArray(group) ) {
    return image_grid_split_array_to_group(group, type, name);
  } else {
    var group_value;
    for ( group_value in group ) {
      if ( Array.isArray( group[group_value] ) ) {
        group[group_value] = image_grid_split_array_to_group(group[group_value], type, name);
      } else {
        image_grid_group_split_all_arrays(group[group_value], type, name);
      }
    }
  }
}

function image_grid_split_array_to_group(img_index_array, attr_type, attr_name) {
  var grp = {};
  var img_index, img_id, i;
  var n = img_index_array.length;
  var attr_value;

  switch(attr_type) {
  case 'file':
    for ( i = 0; i < n; ++i ) {
      img_index = img_index_array[i];
      img_id = _via_image_id_list[img_index];
      if ( _via_img_metadata[img_id].file_attributes.hasOwnProperty(attr_name) ) {
        attr_value = _via_img_metadata[img_id].file_attributes[attr_name];

        if ( ! grp.hasOwnProperty(attr_value) ) {
          grp[attr_value] = [];
        }
        grp[attr_value].push(img_index);
      }
    }
    break;
  case 'region':
    var j;
    var region_count;
    for ( i = 0; i < n; ++i ) {
      img_index    = img_index_array[i];
      img_id       = _via_image_id_list[img_index];
      region_count = _via_img_metadata[img_id].regions.length;
      for ( j = 0; j < region_count; ++j ) {
        if ( _via_img_metadata[img_id].regions[j].region_attributes.hasOwnProperty(attr_name) ) {
          attr_value = _via_img_metadata[img_id].regions[j].region_attributes[attr_name];

          if ( ! grp.hasOwnProperty(attr_value) ) {
            grp[attr_value] = [];
          }
          if ( grp[attr_value].includes(img_index) ) {
            continue;
          } else {
            grp[attr_value].push(img_index);
          }
        }
      }
    }
    break;
  }
  return grp;
}

function image_grid_group_next(p) {
  var group_index = parseInt( p.value );
  var group_value_list = _via_image_grid_group_var[group_index].values;
  var n = group_value_list.length;
  var current_index = _via_image_grid_group_var[group_index].current_value_index;
  var next_index = current_index + 1;
  if ( next_index >= n ) {
    if ( group_index === 0 ) {
      next_index = next_index - n;
      image_grid_jump_to_group(group_index, next_index);
    } else {
      // next of parent group
      var parent_group_index = group_index - 1;
      var parent_current_val_index = _via_image_grid_group_var[parent_group_index].current_value_index;
      var parent_next_val_index = parent_current_val_index + 1;
      while ( parent_group_index !== 0 ) {
        if ( parent_next_val_index >= _via_image_grid_group_var[parent_group_index].values.length ) {
          parent_group_index = group_index - 1;
          parent_current_val_index = _via_image_grid_group_var[parent_group_index].current_value_index;
          parent_next_val_index = parent_current_val_index + 1;
        } else {
          break;
        }
      }

      if ( parent_next_val_index >= _via_image_grid_group_var[parent_group_index].values.length ) {
        parent_next_val_index = 0;
      }
      image_grid_jump_to_group(parent_group_index, parent_next_val_index);
    }
  } else {
    image_grid_jump_to_group(group_index, next_index);
  }
  image_grid_set_content_to_current_group();
}

function image_grid_group_prev(p) {
  var group_index = parseInt( p.value );
  var group_value_list = _via_image_grid_group_var[group_index].values;
  var n = group_value_list.length;
  var current_index = _via_image_grid_group_var[group_index].current_value_index;
  var prev_index = current_index - 1;
  if ( prev_index < 0 ) {
    if ( group_index === 0 ) {
      prev_index = n + prev_index;
      image_grid_jump_to_group(group_index, prev_index);
    } else {
      // prev of parent group
      var parent_group_index = group_index - 1;
      var parent_current_val_index = _via_image_grid_group_var[parent_group_index].current_value_index;
      var parent_prev_val_index = parent_current_val_index - 1;
      while ( parent_group_index !== 0 ) {
        if ( parent_prev_val_index < 0 ) {
          parent_group_index = group_index - 1;
          parent_current_val_index = _via_image_grid_group_var[parent_group_index].current_value_index;
          parent_prev_val_index = parent_current_val_index - 1;
        } else {
          break;
        }
      }

      if ( parent_prev_val_index < 0 ) {
        parent_prev_val_index = _via_image_grid_group_var[parent_group_index].values.length - 1;
      }
      image_grid_jump_to_group(parent_group_index, parent_prev_val_index);
    }
  } else {
    image_grid_jump_to_group(group_index, prev_index);
  }
  image_grid_set_content_to_current_group();
}


function image_grid_group_value_onchange(p) {
  var group_index = image_grid_group_select_parse_html_id(p.id);
  image_grid_jump_to_group(group_index, p.selectedIndex);
  image_grid_set_content_to_current_group();
}

function image_grid_jump_to_group(group_index, value_index) {
  var n = _via_image_grid_group_var[group_index].values.length;
  if ( value_index >=n || value_index < 0 ) {
    return;
  }

  _via_image_grid_group_var[group_index].current_value_index = value_index;
  image_grid_group_panel_set_selected_value( group_index );

  // reset the value of lower groups
  var i, value;
  if ( group_index + 1 < _via_image_grid_group_var.length ) {
    var e = _via_image_grid_group;
    for ( i = 0; i <= group_index; ++i ) {
      value = _via_image_grid_group_var[i].values[ _via_image_grid_group_var[i].current_value_index ];
      e = e[ value ];
    }

    for ( i = group_index + 1; i < _via_image_grid_group_var.length; ++i ) {
      _via_image_grid_group_var[i].values = Object.keys(e);
      if ( _via_image_grid_group_var[i].values.length === 0 ) {
        _via_image_grid_group_var[i].current_value_index = -1;
        _via_image_grid_group_var.splice(i);
        image_grid_group_panel_set_options(i);
        break;
      } else {
        _via_image_grid_group_var[i].current_value_index = 0;
        value = _via_image_grid_group_var[i].values[0]
        e = e[value];
        image_grid_group_panel_set_options(i);
      }
    }
  }
}

function image_grid_set_content_to_current_group() {
  var n = _via_image_grid_group_var.length;

  if ( n === 0 ) {
    image_grid_show_all_project_images();
  } else {
    var group_img_index_list = [];
    var img_index_list = _via_image_grid_group;
    var i, n, value, current_value_index;
    for ( i = 0; i < n; ++i ) {
      value = _via_image_grid_group_var[i].values[ _via_image_grid_group_var[i].current_value_index ];
      img_index_list = img_index_list[ value ];
    }

    if ( Array.isArray(img_index_list) ) {
      image_grid_set_content(img_index_list);
    } else {
      console.log('Error: image_grid_set_content_to_current_group(): expected array while got ' + typeof(img_index_list));
    }
  }
}

function image_grid_page_next() {
  _via_image_grid_stack_prev_page.push(_via_image_grid_page_first_index);
  _via_image_grid_page_first_index = _via_image_grid_page_last_index;

  image_grid_clear_content();
  _via_image_grid_load_ongoing = true;
  image_grid_page_nav_show_cancel();
  image_grid_content_append_img( _via_image_grid_page_first_index );
}

function image_grid_page_prev() {
  _via_image_grid_page_first_index = _via_image_grid_stack_prev_page.pop();
  _via_image_grid_page_last_index = -1;

  image_grid_clear_content();
  _via_image_grid_load_ongoing = true;
  image_grid_page_nav_show_cancel();
  image_grid_content_append_img( _via_image_grid_page_first_index );
}

function image_grid_page_nav_show_cancel() {
  var info = document.getElementById('image_grid_nav');
  var html = [];
  html.push('<span>Loading images ... </span>');
  html.push('<span class="text_button" onclick="image_grid_cancel_load_ongoing()">Cancel</span>');
  info.innerHTML = html.join('');
}

function image_grid_cancel_load_ongoing() {
  _via_image_grid_load_ongoing = false;
}


// everything to do with image zooming
function image_zoom_init() {

}

//
// hooks for sub-modules
// implemented by sub-modules
//
//function _via_hook_next_image() {}
//function _via_hook_prev_image() {}


////////////////////////////////////////////////////////////////////////////////
//
// Code borrowed from via2 branch
// - in future, the <canvas> based reigon shape drawing will be replaced by <svg>
//   because svg allows independent manipulation of individual regions without
//   requiring to clear the canvas every time some region is updated.
//
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//
// @file        _via_region.js
// @description Implementation of region shapes like rectangle, circle, etc.
// @author      Abhishek Dutta <adutta@robots.ox.ac.uk>
// @date        17 June 2017
//
////////////////////////////////////////////////////////////////////////////////

function _via_region( shape, id, data_img_space, view_scale_factor, view_offset_x, view_offset_y) {
  // Note the following terminology:
  //   view space  :
  //     - corresponds to the x-y plane on which the scaled version of original image is shown to the user
  //     - all the region query operations like is_inside(), is_on_edge(), etc are performed in view space
  //     - all svg draw operations like get_svg() are also in view space
  //
  //   image space :
  //     - corresponds to the x-y plane which corresponds to the spatial space of the original image
  //     - region save, export, git push operations are performed in image space
  //     - to avoid any rounding issues (caused by floating scale factor),
  //        * user drawn regions in view space is first converted to image space
  //        * this region in image space is now used to initialize region in view space
  //
  //   The two spaces are related by _via_model.now.tform.scale which is computed by the method
  //     _via_ctrl.compute_view_panel_to_nowfile_tform()
  //   and applied as follows:
  //     x coordinate in image space = scale_factor * x coordinate in view space
  //
  // shape : {rect, circle, ellipse, line, polyline, polygon, point}
  // id    : unique region-id
  // d[]   : (in view space) data whose meaning depend on region shape as follows:
  //        rect     : d[x1,y1,x2,y2] or d[corner1_x, corner1_y, corner2_x, corner2_y]
  //        circle   : d[x1,y1,x2,y2] or d[center_x, center_y, circumference_x, circumference_y]
  //        ellipse  : d[x1,y1,x2,y2,transform]
  //        line     : d[x1,y1,x2,y2]
  //        polyline : d[x1,y1,...,xn,yn]
  //        polygon  : d[x1,y1,...,xn,yn]
  //        point    : d[cx,cy]
  // scale_factor : for conversion from view space to image space
  //
  // Note: no svg data are stored with prefix "_". For example: _scale_factor, _x2
  this.shape  = shape;
  this.id     = id;
  this.scale_factor     = view_scale_factor;
  this.offset_x         = view_offset_x;
  this.offset_y         = view_offset_y;
  this.recompute_svg    = false;
  this.attributes  = {};

  var n = data_img_space.length;
  var i;
  this.dview  = new Array(n);
  this.dimg   = new Array(n);

  if ( n !== 0 ) {
    // IMPORTANT:
    // to avoid any rounding issues (caused by floating scale factor), we stick to
    // the principal that image space coordinates are the ground truth for every region.
    // Hence, we proceed as:
    //   * user drawn regions in view space is first converted to image space
    //   * this region in image space is now used to initialize region in view space
    for ( i = 0; i < n; i++ ) {
      this.dimg[i]  = data_img_space[i];

      var offset = this.offset_x;
      if ( i % 2 !== 0 ) {
        // y coordinate
        offset = this.offset_y;
      }
      this.dview[i] = Math.round( this.dimg[i] * this.scale_factor ) + offset;
    }
  }

  // set svg attributes for each shape
  switch( this.shape ) {
  case "rect":
    _via_region_rect.call( this );
    this.svg_attributes = ['x', 'y', 'width', 'height'];
    break;
  case "circle":
    _via_region_circle.call( this );
    this.svg_attributes = ['cx', 'cy', 'r'];
    break;
  case "ellipse":
    _via_region_ellipse.call( this );
    this.svg_attributes = ['cx', 'cy', 'rx', 'ry','transform'];
    break;
  case "line":
    _via_region_line.call( this );
    this.svg_attributes = ['x1', 'y1', 'x2', 'y2'];
    break;
  case "polyline":
    _via_region_polyline.call( this );
    this.svg_attributes = ['points'];
    break;
  case "polygon":
    _via_region_polygon.call( this );
    this.svg_attributes = ['points'];
    break;
  case "point":
    _via_region_point.call( this );
    // point is a special circle with minimal radius required for visualization
    this.shape = 'circle';
    this.svg_attributes = ['cx', 'cy', 'r'];
    break;
  }

  this.initialize();
}


_via_region.prototype.prepare_svg_element = function() {
  var _VIA_SVG_NS = "http://www.w3.org/2000/svg";
  this.svg_element = document.createElementNS(_VIA_SVG_NS, this.shape);
  this.svg_string  = '<' + this.shape;
  this.svg_element.setAttributeNS(null, 'id', this.id);

  var n = this.svg_attributes.length;
  for ( var i = 0; i < n; i++ ) {
    this.svg_element.setAttributeNS(null, this.svg_attributes[i], this[this.svg_attributes[i]]);
    this.svg_string += ' ' + this.svg_attributes[i] + '="' + this[this.svg_attributes[i]] + '"';
  }
  this.svg_string  += '/>';
}

_via_region.prototype.get_svg_element = function() {
  if ( this.recompute_svg ) {
    this.prepare_svg_element();
    this.recompute_svg = false;
  }
  return this.svg_element;
}

_via_region.prototype.get_svg_string = function() {
  if ( this.recompute_svg ) {
    this.prepare_svg_element();
    this.recompute_svg = false;
  }
  return this.svg_string;
}

///
/// Region shape : rectangle
///
function _via_region_rect() {
  this.is_inside  = _via_region_rect.prototype.is_inside;
  this.is_on_edge = _via_region_rect.prototype.is_on_edge;
  this.move  = _via_region_rect.prototype.move;
  this.resize  = _via_region_rect.prototype.resize;
  this.initialize = _via_region_rect.prototype.initialize;
  this.dist_to_nearest_edge = _via_region_rect.prototype.dist_to_nearest_edge;
}

_via_region_rect.prototype.initialize = function() {
  // ensure that this.(x,y) corresponds to top-left corner of rectangle
  // Note: this.(x2,y2) is defined for convenience in calculations
  if ( this.dview[0] < this.dview[2] ) {
    this.x  = this.dview[0];
    this.x2 = this.dview[2];
  } else {
    this.x  = this.dview[2];
    this.x2 = this.dview[0];
  }
  if ( this.dview[1] < this.dview[3] ) {
    this.y  = this.dview[1];
    this.y2 = this.dview[3];
  } else {
    this.y  = this.dview[3];
    this.y2 = this.dview[1];
  }
  this.width  = this.x2 - this.x;
  this.height = this.y2 - this.y;
  this.recompute_svg = true;
}

///
/// Region shape : circle
///
function _via_region_circle() {
  this.is_inside  = _via_region_circle.prototype.is_inside;
  this.is_on_edge = _via_region_circle.prototype.is_on_edge;
  this.move       = _via_region_circle.prototype.move;
  this.resize     = _via_region_circle.prototype.resize;
  this.initialize = _via_region_circle.prototype.initialize;
  this.dist_to_nearest_edge = _via_region_circle.prototype.dist_to_nearest_edge;
}

_via_region_circle.prototype.initialize = function() {
  this.cx = this.dview[0];
  this.cy = this.dview[1];
  var dx = this.dview[2] - this.dview[0];
  var dy = this.dview[3] - this.dview[1];
  this.r  = Math.round( Math.sqrt(dx * dx + dy * dy) );
  this.r2 = this.r * this.r;
  this.recompute_svg = true;
}


///
/// Region shape : ellipse
///
function _via_region_ellipse() {
  this.is_inside  = _via_region_ellipse.prototype.is_inside;
  this.is_on_edge = _via_region_ellipse.prototype.is_on_edge;
  this.move  = _via_region_ellipse.prototype.move;
  this.resize  = _via_region_ellipse.prototype.resize;
  this.initialize = _via_region_ellipse.prototype.initialize;
  this.dist_to_nearest_edge = _via_region_ellipse.prototype.dist_to_nearest_edge;
}

_via_region_ellipse.prototype.initialize = function() {
  this.cx = this.dview[0];
  this.cy = this.dview[1];
  this.rx = Math.abs(this.dview[2] - this.dview[0]);
  this.ry = Math.abs(this.dview[3] - this.dview[1]);

  this.inv_rx2 = 1 / (this.rx * this.rx);
  this.inv_ry2 = 1 / (this.ry * this.ry);

  this.recompute_svg = true;
}



///
/// Region shape : line
///
function _via_region_line() {
  this.is_inside  = _via_region_line.prototype.is_inside;
  this.is_on_edge = _via_region_line.prototype.is_on_edge;
  this.move  = _via_region_line.prototype.move;
  this.resize  = _via_region_line.prototype.resize;
  this.initialize = _via_region_line.prototype.initialize;
  this.dist_to_nearest_edge = _via_region_line.prototype.dist_to_nearest_edge;
}

_via_region_line.prototype.initialize = function() {
  this.x1 = this.dview[0];
  this.y1 = this.dview[1];
  this.x2 = this.dview[2];
  this.y2 = this.dview[3];
  this.dx = this.x1 - this.x2;
  this.dy = this.y1 - this.y2;
  this.mconst = (this.x1 * this.y2) - (this.x2 * this.y1);

  this.recompute_svg = true;
}


///
/// Region shape : polyline
///
function _via_region_polyline() {
  this.is_inside  = _via_region_polyline.prototype.is_inside;
  this.is_on_edge = _via_region_polyline.prototype.is_on_edge;
  this.move  = _via_region_polyline.prototype.move;
  this.resize  = _via_region_polyline.prototype.resize;
  this.initialize = _via_region_polyline.prototype.initialize;
  this.dist_to_nearest_edge = _via_region_polyline.prototype.dist_to_nearest_edge;
}

_via_region_polyline.prototype.initialize = function() {
  var n = this.dview.length;
  var points = new Array(n/2);
  var points_index = 0;
  for ( var i = 0; i < n; i += 2 ) {
    points[points_index] = ( this.dview[i] + ' ' + this.dview[i+1] );
    points_index++;
  }
  this.points = points.join(',');
  this.recompute_svg = true;
}


///
/// Region shape : polygon
///
function _via_region_polygon() {
  this.is_inside  = _via_region_polygon.prototype.is_inside;
  this.is_on_edge = _via_region_polygon.prototype.is_on_edge;
  this.move  = _via_region_polygon.prototype.move;
  this.resize  = _via_region_polygon.prototype.resize;
  this.initialize = _via_region_polygon.prototype.initialize;
  this.dist_to_nearest_edge = _via_region_polygon.prototype.dist_to_nearest_edge;
}

_via_region_polygon.prototype.initialize = function() {
  var n = this.dview.length;
  var points = new Array(n/2);
  var points_index = 0;
  for ( var i = 0; i < n; i += 2 ) {
    points[points_index] = ( this.dview[i] + ' ' + this.dview[i+1] );
    points_index++;
  }
  this.points = points.join(',');
  this.recompute_svg = true;
}


///
/// Region shape : point
///
function _via_region_point() {
  this.is_inside  = _via_region_point.prototype.is_inside;
  this.is_on_edge = _via_region_point.prototype.is_on_edge;
  this.move  = _via_region_point.prototype.move;
  this.resize  = _via_region_point.prototype.resize
  this.initialize  = _via_region_point.prototype.initialize;
  this.dist_to_nearest_edge = _via_region_point.prototype.dist_to_nearest_edge;
}

_via_region_point.prototype.initialize = function() {
  this.cx = this.dview[0];
  this.cy = this.dview[1];
  this.r  = 2;
  this.r2 = this.r * this.r;
  this.recompute_svg = true;
}

//
// image buffering
//

function _via_cancel_current_image_loading() {
  var panel = document.getElementById('project_panel_title');
  panel.innerHTML = 'Project';
  _via_is_loading_current_image = false;
}

function _via_show_img(img_index) {
  if ( _via_is_loading_current_image ) {
    return;
  }

  var img_id = _via_image_id_list[img_index];

  if ( ! _via_img_metadata.hasOwnProperty(img_id) ) {
    console.log('_via_show_img(): [' + img_index + '] ' + img_id + ' does not exist!')
    show_message('The requested image does not exist!')
    return;
  }

  // file_resolve() is not necessary for files selected using browser's file selector
  if ( typeof(_via_img_fileref[img_id]) === 'undefined' || ! _via_img_fileref[img_id] instanceof File ) {
    // try preload from local file or url
    if ( typeof(_via_img_src[img_id]) === 'undefined' || _via_img_src[img_id] === '' ) {
      if ( is_url( _via_img_metadata[img_id].filename ) ) {
        _via_img_src[img_id] = _via_img_metadata[img_id].filename;
        _via_show_img(img_index);
        return;
      } else {
        var search_path_list = _via_file_get_search_path_list();
        if ( search_path_list.length === 0 ) {
          search_path_list.push(''); // search using just the filename
        }

        _via_file_resolve(img_index, search_path_list).then( function(ok_file_index) {
          _via_show_img(img_index);
        }, function(err_file_index) {
          show_page_404(img_index);
        });
        return;
      }
    }
  }

  if ( _via_buffer_img_index_list.includes(img_index) ) {
    _via_current_image_loaded = false;
    _via_show_img_from_buffer(img_index).then( function(ok_img_index) {
      // trigger preload of images in buffer corresponding to img_index
      // but, wait until all previous promises get cancelled
      Promise.all(_via_preload_img_promise_list).then( function(values) {
        _via_preload_img_promise_list = [];
        var preload_promise = _via_img_buffer_start_preload( img_index, 0 )
        _via_preload_img_promise_list.push(preload_promise);
      });
    }, function(err_img_index) {
      console.log('_via_show_img_from_buffer() failed for file: ' + _via_image_filename_list[err_img_index]);
      _via_current_image_loaded = false;
    });
  } else {
    // image not in buffer, so first add this image to buffer
    _via_is_loading_current_image = true;
    img_loading_spinbar(img_index, true);
    _via_img_buffer_add_image(img_index).then( function(ok_img_index) {
      _via_is_loading_current_image = false;
      img_loading_spinbar(img_index, false);
      _via_show_img(img_index);
    }, function(err_img_index) {
      _via_is_loading_current_image = false;
      img_loading_spinbar(img_index, false);
      show_page_404(img_index);
      console.log('_via_img_buffer_add_image() failed for file: ' + _via_image_filename_list[err_img_index]);
    });
  }

  // add zooming
  _via_add_zoom_for_image(img_index)

}

function _via_add_zoom_for_image(img_index) {
  // var img = document.getElementById('bim' + img_index);
  // img.style.backgroundRepeat = 'no-repeat';
  // img.style.backgroundImage = 'url("'+img.src+'")';
  // tramsparent_img = 'data:image/svg+xml;base64,'+window.btoa('<svg xmlns="http://www.w3.org/2000/svg" width="'+img.naturalWidth+'" height="'+img.naturalHeight+'"></svg>');
  // img.src = transparentSpaceFiller;
  // _via_img_panel.style.backgroundSize
}

function _via_buffer_hide_current_image() {
  img_fn_list_ith_entry_selected(_via_image_index, false);
  _via_clear_reg_canvas(); // clear old region shapes
  if ( _via_current_image ) {
    _via_current_image.classList.remove('visible');
  }
}

function _via_show_img_from_buffer(img_index) {
  return new Promise( function(ok_callback, err_callback) {
    _via_buffer_hide_current_image();

    var cimg_html_id = _via_img_buffer_get_html_id(img_index);
    _via_current_image = document.getElementById(cimg_html_id);
    if ( ! _via_current_image ) {
      // the said image is not present in buffer, which could be because
      // the image got removed from the buffer
      err_callback(img_index);
      return;
    }
    _via_current_image.classList.add('visible'); // now show the new image

    _via_image_index = img_index;
    _via_image_id    = _via_image_id_list[_via_image_index];
    _via_current_image_filename = _via_img_metadata[_via_image_id].filename;
    _via_current_image_loaded = true;

    var arr_index = _via_buffer_img_index_list.indexOf(img_index);
    _via_buffer_img_shown_timestamp[arr_index] = Date.now(); // update shown timestamp

    // update the current state of application
    _via_click_x0 = 0; _via_click_y0 = 0;
    _via_click_x1 = 0; _via_click_y1 = 0;
    _via_is_user_drawing_region = false;
    _via_is_window_resized = false;
    _via_is_user_resizing_region = false;
    _via_is_user_moving_region = false;
    _via_is_user_drawing_polygon = false;
    _via_is_region_selected = false;
    _via_user_sel_region_id = -1;
    _via_current_image_width = _via_current_image.naturalWidth;
    _via_current_image_height = _via_current_image.naturalHeight;

    if ( _via_current_image_width === 0 || _via_current_image_height === 0 ) {
      // for error image icon
      _via_current_image_width = 640;
      _via_current_image_height = 480;
    }

    // set the size of canvas
    // based on the current dimension of browser window
    var de = document.documentElement;
    var image_panel_width = de.clientWidth - leftsidebar.clientWidth - 20;
    if ( leftsidebar.style.display === 'none' ) {
      image_panel_width = de.clientWidth;
    }
    var image_panel_height = de.clientHeight - 2*ui_top_panel.offsetHeight;

    _via_canvas_width = _via_current_image_width;
    _via_canvas_height = _via_current_image_height;

    if ( _via_canvas_width > image_panel_width ) {
      // resize image to match the panel width
      var scale_width = image_panel_width / _via_current_image.naturalWidth;
      _via_canvas_width = image_panel_width;
      _via_canvas_height = _via_current_image.naturalHeight * scale_width;
    }
    if ( _via_canvas_height > image_panel_height ) {
      // resize further image if its height is larger than the image panel
      var scale_height = image_panel_height / _via_canvas_height;
      _via_canvas_height = image_panel_height;
      _via_canvas_width = _via_canvas_width * scale_height;
    }
    _via_canvas_width = Math.round(_via_canvas_width);
    _via_canvas_height = Math.round(_via_canvas_height);
    _via_canvas_scale = _via_current_image.naturalWidth / _via_canvas_width;
    _via_canvas_scale_without_zoom = _via_canvas_scale;
    set_all_canvas_size(_via_canvas_width, _via_canvas_height);
    //set_all_canvas_scale(_via_canvas_scale_without_zoom);

    // reset all regions to "not selected" state
    toggle_all_regions_selection(false);

    // ensure that all the canvas are visible
    set_display_area_content( VIA_DISPLAY_AREA_CONTENT_NAME.IMAGE );

    // update img_fn_list
    img_fn_list_ith_entry_selected(_via_image_index, true);
    img_fn_list_scroll_to_current_file();

    // refresh the annotations panel
    annotation_editor_update_content();

    _via_load_canvas_regions(); // image to canvas space transform
    _via_redraw_reg_canvas();
    _via_reg_canvas.focus();

    // Preserve zoom level
    if (_via_is_canvas_zoomed) {
      set_zoom( _via_canvas_zoom_level_index );
    }
    ok_callback(img_index);
  });
}

function _via_img_buffer_add_image(img_index) {
  return new Promise( function(ok_callback, err_callback) {
    if ( _via_buffer_img_index_list.includes(img_index) ) {
      //console.log('_via_img_buffer_add_image(): image ' + img_index + ' already exists in buffer!')
      ok_callback(img_index);
      return;
    }

    var img_id = _via_image_id_list[img_index];
    var img_filename = _via_img_metadata[img_id].filename;
    if ( !_via_img_metadata.hasOwnProperty(img_id)) {
      err_callback(img_index);
      return;
    }

    // check if user has given access to local file using
    // browser's file selector
    if ( _via_img_fileref[img_id] instanceof File ) {
      var tmp_file_object_url = URL.createObjectURL(_via_img_fileref[img_id]);
      var img_id = _via_image_id_list[img_index];
      var bimg = document.createElement('img');
      bimg.setAttribute('id', _via_img_buffer_get_html_id(img_index));
      bimg.setAttribute('src', tmp_file_object_url);
      bimg.setAttribute('alt', 'Image loaded from base64 data of a local file selected by user.');
      bimg.addEventListener('error', function() {
        URL.revokeObjectURL(tmp_file_object_url);
        project_file_load_on_fail(img_index);
        err_callback(img_index);
      });
      bimg.addEventListener('load', function() {
        URL.revokeObjectURL(tmp_file_object_url);
        img_stat_set(img_index, [bimg.naturalWidth, bimg.naturalHeight]);
        _via_img_panel.insertBefore(bimg, _via_reg_canvas);
        project_file_load_on_success(img_index);
        img_fn_list_ith_entry_add_css_class(img_index, 'buffered')
        // add timestamp so that we can apply Least Recently Used (LRU)
        // scheme to remove elements when buffer is full
        var arr_index = _via_buffer_img_index_list.length;
        _via_buffer_img_index_list.push(img_index);
        _via_buffer_img_shown_timestamp[arr_index] = Date.now(); // though, not seen yet
        ok_callback(img_index);
      });
      return;
    }

    if ( typeof(_via_img_src[img_id]) === 'undefined' || _via_img_src[img_id] === '' ) {
      err_callback(img_index);
    } else {
      var img_id = _via_image_id_list[img_index];

      var bimg = document.createElement('img');
      bimg.setAttribute('id', _via_img_buffer_get_html_id(img_index));
      _via_img_src[img_id] = _via_img_src[img_id].replace('#', '%23');
      bimg.setAttribute('src', _via_img_src[img_id]);
      if ( _via_img_src[img_id].startsWith('data:image') ) {
        bimg.setAttribute('alt', 'Source: image data in base64 format');
      } else {
        bimg.setAttribute('alt', 'Source: ' + _via_img_src[img_id]);
      }

      bimg.addEventListener('abort', function() {
        project_file_load_on_fail(img_index);
        err_callback(img_index);
      });
      bimg.addEventListener('error', function() {
        project_file_load_on_fail(img_index);
        err_callback(img_index);
      });

      // Note: _via_current_image.{naturalWidth,naturalHeight} is only accessible after
      // the "load" event. Therefore, all processing must happen inside this event handler.
      bimg.addEventListener('load', function() {
        img_stat_set(img_index, [bimg.naturalWidth, bimg.naturalHeight]);
        _via_img_panel.insertBefore(bimg, _via_reg_canvas);

        project_file_load_on_success(img_index);
        img_fn_list_ith_entry_add_css_class(img_index, 'buffered')
        // add timestamp so that we can apply Least Recently Used (LRU)
        // scheme to remove elements when buffer is full
        var arr_index = _via_buffer_img_index_list.length;
        _via_buffer_img_index_list.push(img_index);
        _via_buffer_img_shown_timestamp[arr_index] = Date.now(); // though, not seen yet
        ok_callback(img_index);
      }, false);
    }
  }, false);
}

function _via_img_buffer_get_html_id(img_index) {
  return 'bim' + img_index;
}

function _via_img_buffer_parse_html_id(html_id) {
  return parseInt( html_id.substr(3) );
}

function _via_img_buffer_start_preload(img_index, preload_index) {
  return new Promise( function(ok_callback, err_callback) {
    _via_buffer_preload_img_index = img_index;
    _via_img_buffer_preload_img(_via_buffer_preload_img_index, 0).then( function(ok_img_index_list) {
      ok_callback(ok_img_index_list);
    });
  });
}

function _via_img_buffer_preload_img(img_index, preload_index) {
  return new Promise( function(ok_callback, err_callback) {
    var preload_img_index = _via_img_buffer_get_preload_img_index(img_index, preload_index);

    if ( _via_buffer_preload_img_index !== _via_image_index ) {
      ok_callback([]);
      return;
    }

    // ensure that there is sufficient buffer space left for preloading image
    if ( _via_buffer_img_index_list.length > _via_settings.core.buffer_size ) {
      while( _via_buffer_img_index_list.length > _via_settings.core.buffer_size ) {
        _via_img_buffer_remove_least_useful_img();
        if ( _via_image_index !== _via_buffer_preload_img_index ) {
          // current image has changed therefore, we need to cancel this preload operation
          ok_callback([]);
          return;
        }
      }
    }

    _via_img_buffer_add_image(preload_img_index).then( function(ok_img_index) {
      if ( _via_image_index !== _via_buffer_preload_img_index ) {
        ok_callback( [ok_img_index] );
        return;
      }

      var next_preload_index = preload_index + 1;
      if ( next_preload_index !== VIA_IMG_PRELOAD_COUNT ) {
        _via_img_buffer_preload_img(img_index, next_preload_index).then( function(ok_img_index_list) {
          ok_img_index_list.push( ok_img_index )
          ok_callback( ok_img_index_list );
        });
      } else {
        ok_callback( [ok_img_index] );
      }
    }, function(err_img_index) {
      // continue with preload of other images in sequence
      var next_preload_index = preload_index + 1;
      if ( next_preload_index !== VIA_IMG_PRELOAD_COUNT ) {
        _via_img_buffer_preload_img(img_index, next_preload_index).then( function(ok_img_index_list) {
          ok_callback( ok_img_index_list );
        });
      } else {
        ok_callback([]);
      }
    });
  });
}

function _via_img_buffer_get_preload_img_index(img_index, preload_index) {
  var preload_img_index = img_index + VIA_IMG_PRELOAD_INDICES[preload_index];
  if ( (preload_img_index < 0) || (preload_img_index >= _via_img_count) ) {
    if ( preload_img_index < 0 ) {
      preload_img_index = _via_img_count + preload_img_index;
    } else {
      preload_img_index = preload_img_index - _via_img_count;
    }
  }
  return preload_img_index;
}

// the least useful image is, one with the following properties:
// - preload list for current image will always get loaded, so there is no point in removing them from buffer
// - all the other images in buffer were seen more recently by the image
// - all the other images are closer (in terms of their image index) to the image currently being shown
function _via_img_buffer_remove_least_useful_img() {
  var not_in_preload_list = _via_buffer_img_not_in_preload_list();
  var oldest_buffer_index = _via_buffer_get_oldest_in_list(not_in_preload_list);

  if ( _via_buffer_img_index_list[oldest_buffer_index] !== _via_image_index ) {
    //console.log('removing oldest_buffer index: ' + oldest_buffer_index);
    _via_buffer_remove(oldest_buffer_index);
  } else {
    var furthest_buffer_index = _via_buffer_get_buffer_furthest_from_current_img();
    _via_buffer_remove(furthest_buffer_index);
  }
}

function _via_buffer_remove( buffer_index ) {
  var img_index = _via_buffer_img_index_list[buffer_index];
  var bimg_html_id = _via_img_buffer_get_html_id(img_index);
  var bimg = document.getElementById(bimg_html_id);
  if ( bimg ) {
    _via_buffer_img_index_list.splice(buffer_index, 1);
    _via_buffer_img_shown_timestamp.splice(buffer_index, 1);
    _via_img_panel.removeChild(bimg);

    img_fn_list_ith_entry_remove_css_class(img_index, 'buffered')
  }
}

function _via_buffer_remove_all() {
  var i, n;
  n = _via_buffer_img_index_list.length;
  for ( i = 0 ; i < n; ++i ) {
    var img_index = _via_buffer_img_index_list[i];
    var bimg_html_id = _via_img_buffer_get_html_id(img_index);
    var bimg = document.getElementById(bimg_html_id);
    if ( bimg ) {
      _via_img_panel.removeChild(bimg);
    }
  }
  _via_buffer_img_index_list = [];
  _via_buffer_img_shown_timestamp = [];
}

function _via_buffer_get_oldest_in_list(not_in_preload_list) {
  var i;
  var n = not_in_preload_list.length;
  var oldest_buffer_index = -1;
  var oldest_buffer_timestamp = Date.now();

  for ( i = 0; i < n; ++i ) {
    var _via_buffer_index = not_in_preload_list[i];
    if ( _via_buffer_img_shown_timestamp[_via_buffer_index] < oldest_buffer_timestamp ) {
      oldest_buffer_timestamp = _via_buffer_img_shown_timestamp[i];
      oldest_buffer_index = i;
    }
  }
  return oldest_buffer_index;
}

function _via_buffer_get_buffer_furthest_from_current_img() {
  var now_img_index = _via_image_index;
  var i, dist1, dist2, dist;
  var n = _via_buffer_img_index_list.length;
  var furthest_buffer_index = 0;
  dist1 = Math.abs( _via_buffer_img_index_list[0] - now_img_index );
  dist2 = _via_img_count - dist1; // assuming the list is circular
  var furthest_buffer_dist = Math.min(dist1, dist2);

  for ( i = 1; i < n; ++i ) {
    dist1 = Math.abs( _via_buffer_img_index_list[i] - now_img_index );
    dist2 = _via_img_count - dist1; // assuming the list is circular
    dist = Math.min(dist1, dist2);
    // image has been seen by user at least once
    if ( dist > furthest_buffer_dist ) {
      furthest_buffer_dist = dist;
      furthest_buffer_index = i;
    }
  }
  return furthest_buffer_index;
}

function _via_buffer_img_not_in_preload_list() {
  var preload_list = _via_buffer_get_current_preload_list();
  var i;
  var not_in_preload_list = [];
  for ( i = 0; i < _via_buffer_img_index_list.length; ++i ) {
    if ( ! preload_list.includes( _via_buffer_img_index_list[i] ) ) {
      not_in_preload_list.push( i );
    }
  }
  return not_in_preload_list;
}

function _via_buffer_get_current_preload_list() {
  var i;
  var preload_list = [_via_image_index];
  var img_index = _via_image_index;
  for ( i = 0; i < VIA_IMG_PRELOAD_COUNT; ++i ) {
    var preload_index = img_index + VIA_IMG_PRELOAD_INDICES[i];
    if ( preload_index < 0 ) {
      preload_index = _via_img_count + preload_index;
    }
    if ( preload_index >= _via_img_count ) {
      preload_index = preload_index - _via_img_count;
    }
    preload_list.push(preload_index);
  }
  return preload_list;
}

//
// settings
//
function settings_panel_toggle() {
  if ( _via_display_area_content_name === VIA_DISPLAY_AREA_CONTENT_NAME.SETTINGS ) {
    if ( _via_display_area_content_name_prev !== '' ) {
      set_display_area_content(_via_display_area_content_name_prev);
    } else {
      show_single_image_view();
      _via_redraw_rleg_canvas();
    }
  }
  else {
    settings_init();
    set_display_area_content(VIA_DISPLAY_AREA_CONTENT_NAME.SETTINGS);
  }
}

function settings_init() {
  settings_region_visualisation_update_options();
  settings_filepath_update_html();
  settings_show_current_value();
}

function settings_save() {
  // check if default path was updated
  var default_path_updated = false;
  if ( document.getElementById('_via_settings.core.default_filepath').value !== _via_settings.core.default_filepath ) {
    default_path_updated = true;
  }

  var p = document.getElementById('settings_panel');
  var vl = p.getElementsByClassName('value');
  var n = vl.length;
  var i;
  for ( i = 0; i < n; ++i ) {
    var s = vl[i].childNodes[1];
    var sid_parts = s.id.split('.');
    if ( sid_parts[0] === '_via_settings' ) {
      var el = _via_settings;
      var found = true;
      var j;
      for ( j = 1; j < sid_parts.length - 1; ++j ) {
        if ( el.hasOwnProperty( sid_parts[j] ) ) {
          el = el[ sid_parts[j] ];
        } else {
          // unrecognized setting
          found = false;
          break;
        }
      }
      if ( found ) {
        var param = sid_parts[ sid_parts.length - 1 ];
        if ( s.value !== '' || typeof(s.value) !== 'undefined' ) {
          el[param] = s.value;
        }
      }
    }
  }

  // non-standard settings
  var p;
  p = document.getElementById('settings_input_new_filepath');
  if ( p.value !== '' ) {
    project_filepath_add(p.value.trim());
  }
  p = document.getElementById('project_name');
  if ( p.value !== _via_settings.project.name ) {
    p.value = _via_settings.project.name;
  }

  if ( default_path_updated ) {
    _via_file_resolve_all_to_default_filepath();
    _via_show_img(_via_image_index);
  }

  show_message('Settings saved.');
  settings_panel_toggle();
}

function settings_show_current_value() {
  var p = document.getElementById('settings_panel');
  var vl = p.getElementsByClassName('value');
  var n = vl.length;
  var i;
  for ( i = 0; i < n; ++i ) {
    var s = vl[i].childNodes[1];
    var sid_parts = s.id.split('.');
    if ( sid_parts[0] === '_via_settings' ) {
      var el = _via_settings;
      var found = true;
      var j;
      for ( j = 1; j < sid_parts.length; ++j ) {
        if ( el.hasOwnProperty( sid_parts[j] ) ) {
          el = el[ sid_parts[j] ];
        } else {
          // unrecognized setting
          found = false;
          break;
        }
      }

      if ( found ) {
        s.value = el;
      }
    }
  }
}

function settings_region_visualisation_update_options() {
  var region_setting_list = {'region_label': {
    'default_option':'__via_region_id__',
    'default_label':'Region id (1, 2, ...)',
    'label_prefix':'Show value of region attribute: ',
  }, 'region_color': {
    'default_option':'__via_default_region_color__',
    'default_label':'Default Region Colour',
    'label_prefix':'Based on value of region attribute: ',
  }};

  for ( var setting in region_setting_list ) {
    var select = document.getElementById('_via_settings.ui.image.' + setting);
    select.innerHTML = '';
    var default_option = document.createElement('option');
    default_option.setAttribute('value', region_setting_list[setting]['default_option']);
    if ( _via_settings.ui.image[setting] === region_setting_list[setting]['default_option'] ) {
      default_option.setAttribute('selected', 'selected');
    }
    default_option.innerHTML = region_setting_list[setting]['default_label'];
    select.appendChild(default_option);

    // options: add region attributes
    var rattr;
    for ( rattr in _via_attributes['region'] ) {
      var o = document.createElement('option');
      o.setAttribute('value', rattr);
      o.innerHTML = region_setting_list[setting]['label_prefix'] + rattr;
      if ( _via_settings.ui.image.region_label === rattr ) {
        o.setAttribute('selected', 'selected');
      }
      select.appendChild(o);
    }
  }
}

function settings_filepath_update_html() {
  var p = document.getElementById('_via_settings.core.filepath');
  p.innerHTML = '';
  var i, path, order;
  for ( path in _via_settings.core.filepath ) {
    order = _via_settings.core.filepath[path]
    if ( order !== 0 ) {
      var li = document.createElement('li');
      li.innerHTML = path + '<span class="text_button" title="Delete image path" onclick="project_filepath_del(\"' + path + '\"); settings_filepath_update_html();">&times;</span>';
      p.appendChild(li);
    }
  }
}

//
// find location of file
//

function _via_file_resolve_all_to_default_filepath() {
  var img_id;
  for ( img_id in _via_img_metadata ) {
    if ( _via_img_metadata.hasOwnProperty(img_id) ) {
      _via_file_resolve_file_to_default_filepath(img_id);
    }
  }
}

function _via_file_resolve_file_to_default_filepath(img_id) {
  if ( _via_img_metadata.hasOwnProperty(img_id) ) {
    if ( typeof(_via_img_fileref[img_id]) === 'undefined' || ! _via_img_fileref[img_id] instanceof File ) {
      if ( is_url( _via_img_metadata[img_id].filename ) ) {
        _via_img_src[img_id] = _via_img_metadata[img_id].filename;
      } else {
        _via_img_src[img_id] = _via_settings.core.default_filepath + _via_img_metadata[img_id].filename;
      }
    }
  }
}

function _via_file_resolve_all() {
  return new Promise( function(ok_callback, err_callback) {
    var all_promises = [];

    var search_path_list = _via_file_get_search_path_list();
    var i, img_id;
    for ( i = 0; i < _via_img_count; ++i ) {
      img_id = _via_image_id_list[i];
      if ( typeof(_via_img_src[img_id]) === 'undefined' || _via_img_src[img_id] === '' ) {
        var p = _via_file_resolve(i, search_path_list);
        all_promises.push(p);
      }
    }

    Promise.all( all_promises ).then( function(ok_file_index_list) {
      console.log(ok_file_index_list);
      ok_callback();
      //project_file_load_on_success(ok_file_index);
    }, function(err_file_index_list) {
      console.log(err_file_index_list);
      err_callback();
      //project_file_load_on_fail(err_file_index);
    });

  });
}

function _via_file_get_search_path_list() {
  var search_path_list = [];
  var path;
  for ( path in _via_settings.core.filepath ) {
    if ( _via_settings.core.filepath[path] !== 0 ) {
      search_path_list.push(path);
    }
  }
  return search_path_list;
}

function _via_file_resolve(file_index, search_path_list) {
  return new Promise( function(ok_callback, err_callback) {
    var path_index = 0;
    var p = _via_file_resolve_check_path(file_index, path_index, search_path_list).then(function(ok) {
      ok_callback(ok);
    }, function(err) {
      err_callback(err);
    });
  }, false);
}

function _via_file_resolve_check_path(file_index, path_index, search_path_list) {
  return new Promise( function(ok_callback, err_callback) {
    var img_id = _via_image_id_list[file_index];
    var img = new Image(0,0);

    var img_path = search_path_list[path_index] + _via_img_metadata[img_id].filename;
    if ( is_url( _via_img_metadata[img_id].filename ) ) {
      if ( search_path_list[path_index] !== '' ) {
        // we search for the the image filename pointed by URL in local search paths
        img_path = search_path_list[path_index] + get_filename_from_url( _via_img_metadata[img_id].filename );
      }
    }

    img.setAttribute('src', img_path);

    img.addEventListener('load', function() {
      _via_img_src[img_id] = img_path;
      ok_callback(file_index);
    }, false);
    img.addEventListener('abort', function() {
      err_callback(file_index);
    });
    img.addEventListener('error', function() {
      var new_path_index = path_index + 1;
      if ( new_path_index < search_path_list.length ) {
        _via_file_resolve_check_path(file_index, new_path_index, search_path_list).then( function(ok) {
          ok_callback(file_index);
        }, function(err) {
          err_callback(file_index);
        });
      } else {
        err_callback(file_index);
      }
    }, false);
  }, false);
}

//
// page 404 (file not found)
//
function show_page_404(img_index) {
  _via_buffer_hide_current_image();

  set_display_area_content(VIA_DISPLAY_AREA_CONTENT_NAME.PAGE_404);

  _via_image_index = img_index;
  _via_image_id = _via_image_id_list[_via_image_index];
  _via_current_image_loaded = false;
  img_fn_list_ith_entry_selected(_via_image_index, true);

  document.getElementById('page_404_filename').innerHTML = '[' + (_via_image_index+1) + ']' + _via_img_metadata[_via_image_id].filename;
}


//
// utils
//

function is_url( s ) {
  // @todo: ensure that this is sufficient to capture all image url
  if ( s.startsWith('http://') || s.startsWith('https://') || s.startsWith('www.') ) {
    return true;
  } else {
    return false;
  }
}

function get_filename_from_url( url ) {
  return url.substring( url.lastIndexOf('/') + 1 );
}

// start with the array having smallest number of elements
// check the remaining arrays if they all contain the elements of this shortest array
function array_intersect( array_list ) {
  if ( array_list.length === 0 ) {
    return [];
  }
  if ( array_list.length === 1 ) {
    return array_list[0];
  }

  var shortest_array = array_list[0];
  var shortest_array_index = 0;
  var i;
  for ( i = 1; i < array_list.length; ++i ) {
    if ( array_list[i].length < shortest_array.length ) {
      shortest_array = array_list[i];
      shortest_array_index = i;
    }
  }

  var intersect = [];
  var element_count = {};

  var array_index_i;
  for ( i = 0; i < array_list.length; ++i ) {
    if ( i === 0 ) {
      // in the first iteration, process the shortest element array
      array_index_i = shortest_array_index;
    } else {
      array_index_i = i;
    }

    var j;
    for ( j = 0; j < array_list[array_index_i].length; ++j ) {
      if ( element_count[ array_list[array_index_i][j] ] === (i-1) ) {
        if ( i === array_list.length - 1 ) {
          intersect.push( array_list[array_index_i][j] );
          element_count[ array_list[array_index_i][j] ] = 0;
        } else {
          element_count[ array_list[array_index_i][j] ] = i;
        }
      } else {
        element_count[ array_list[array_index_i][j] ] = 0;
      }
    }
  }
  return intersect;
}

function generate_img_index_list(input) {
  var all_img_index_list = [];

  // condition: count format a,b
  var count_format_img_index_list = [];
  if ( input.prev_next_count.value !== '' ) {
    var prev_next_split = input.prev_next_count.value.split(',');
    if ( prev_next_split.length === 2 ) {
      var prev = parseInt( prev_next_split[0] );
      var next = parseInt( prev_next_split[1] );
      var i;
      for ( i = (_via_image_index - prev); i <= (_via_image_index + next); i++ ) {
        count_format_img_index_list.push(i);
      }
    }
  }
  if ( count_format_img_index_list.length !== 0 ) {
    all_img_index_list.push(count_format_img_index_list);
  }

  //condition: image index list expression
  var expr_img_index_list = [];
  if ( input.img_index_list.value !== '' ) {
    var img_index_expr = input.img_index_list.value.split(',');
    if ( img_index_expr.length !== 0 ) {
      var i;
      for ( i = 0; i < img_index_expr.length; ++i ) {
        if ( img_index_expr[i].includes('-') ) {
          var ab = img_index_expr[i].split('-');
          var a = parseInt( ab[0] ) - 1; // 0 based indexing
          var b = parseInt( ab[1] ) - 1;
          var j;
          for ( j = a; j <= b; ++j ) {
            expr_img_index_list.push(j);
          }
        } else {
          expr_img_index_list.push( parseInt(img_index_expr[i]) - 1 );
        }
      }
    }
  }
  if ( expr_img_index_list.length !== 0 ) {
    all_img_index_list.push(expr_img_index_list);
  }


  // condition: regular expression
  var regex_img_index_list = [];
  if ( input.regex.value !== '' ) {
    var regex = input.regex.value;
    for ( var i=0; i < _via_image_filename_list.length; ++i ) {
      var filename = _via_image_filename_list[i];
      if ( filename.match(regex) !== null ) {
        regex_img_index_list.push(i);
      }
    }
  }
  if ( regex_img_index_list.length !== 0 ) {
    all_img_index_list.push(regex_img_index_list);
  }

  var intersect = array_intersect(all_img_index_list);
  return intersect;
}

if ( ! _via_is_debug_mode ) {
  // warn user of possible loss of data
  window.onbeforeunload = function (e) {
    e = e || window.event;

    // For IE and Firefox prior to version 4
    if (e) {
      e.returnValue = 'Did you save your data?';
    }

    // For Safari
    return 'Did you save your data?';
  };
}

//
// keep a record of image statistics (e.g. width, height, ...)
//
function img_stat_set(img_index, stat) {
  if ( stat.length ) {
    _via_img_stat[img_index] = stat;
  } else {
    delete _via_img_stat[img_index];
  }
}

function img_stat_set_all() {
  return new Promise( function(ok_callback, err_callback) {
    var promise_list = [];
    var img_id;
    for ( var img_index in _via_image_id_list ) {
      if ( ! _via_img_stat.hasOwnProperty(img_index) ) {
        img_id = _via_image_id_list[img_index];
        if ( _via_img_metadata[img_id].file_attributes.hasOwnProperty('width') &&
             _via_img_metadata[img_id].file_attributes.hasOwnProperty('height')
           ) {
          _via_img_stat[img_index] = [_via_img_metadata[img_id].file_attributes['width'],
                                      _via_img_metadata[img_id].file_attributes['height'],
                                     ];
        } else {
          promise_list.push( img_stat_get(img_index) );
        }
      }
    }
    if ( promise_list.length ) {
      Promise.all(promise_list).then( function(ok) {
        ok_callback();
      }.bind(this), function(err) {
        console.warn('Failed to read statistics of all images!');
        err_callback();
      });
    } else {
      ok_callback();
    }
  }.bind(this));
}

function img_stat_get(img_index) {
  return new Promise( function(ok_callback, err_callback) {
    var img_id = _via_image_id_list[img_index];
    var tmp_img = document.createElement('img');
    var tmp_file_object_url = null;
    tmp_img.addEventListener('load', function() {
      _via_img_stat[img_index] = [tmp_img.naturalWidth, tmp_img.naturalHeight];
      if ( tmp_file_object_url !== null ) {
        URL.revokeObjectURL(tmp_file_object_url);
      }
      ok_callback();
    }.bind(this));
    tmp_img.addEventListener('error', function() {
      _via_img_stat[img_index] = [-1, -1];
      if ( tmp_file_object_url !== null ) {
        URL.revokeObjectURL(tmp_file_object_url);
      }
      ok_callback();
    }.bind(this));

    if ( _via_img_fileref[img_id] instanceof File ) {
      tmp_file_object_url = URL.createObjectURL(_via_img_fileref[img_id]);
      tmp_img.src = tmp_file_object_url;
    } else {
      tmp_img.src = _via_img_src[img_id];
    }
  }.bind(this));
}

//
// util
//
function fixfloat(x) {
  return parseFloat( x.toFixed(VIA_FLOAT_PRECISION) );
}

function shape_attribute_fixfloat(sa) {
  for ( var attr in sa ) {
    switch(attr) {
    case 'x':
    case 'y':
    case 'width':
    case 'height':
    case 'r':
    case 'rx':
    case 'ry':
      sa[attr] = fixfloat( sa[attr] );
      break;
    case 'all_points_x':
    case 'all_points_y':
      for ( var i in sa[attr] ) {
        sa[attr][i] = fixfloat( sa[attr][i] );
      }
    }
  }
}

// pts = [x0,y0,x1,y1,....]
function polygon_to_bbox(pts) {
  var xmin = +Infinity;
  var xmax = -Infinity;
  var ymin = +Infinity;
  var ymax = -Infinity;
  for ( var i = 0; i < pts.length; i = i + 2 ) {
    if ( pts[i] > xmax ) {
      xmax = pts[i];
    }
    if ( pts[i] < xmin ) {
      xmin = pts[i];
    }
    if ( pts[i+1] > ymax ) {
      ymax = pts[i+1];
    }
    if ( pts[i+1] < ymin ) {
      ymin = pts[i+1];
    }
  }
  return [xmin, ymin, xmax-xmin, ymax-ymin];
}